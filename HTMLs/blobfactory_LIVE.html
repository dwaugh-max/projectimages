<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOB FACTORY // MASTER FORGE (v65.97)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Oswald:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root {
            --bg: #050505;
            --panel: #111;
            --accent: #ff0055;
            /* ARCHITECT CRIMSON */
            --accent-glow: rgba(255, 0, 85, 0.3);
            --border: #222;
            --text: #eee;
            --font-p: 'Inter', sans-serif;
            --font-h: 'Oswald', sans-serif;
            --font-m: 'JetBrains Mono', monospace;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: var(--font-p);
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* Allow scrolling on mobile if need be, but keep dash layout */
            overflow-x: hidden;
            overflow-y: auto;
            position: relative;
        }

        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #050505;
        }

        ::-webkit-scrollbar-thumb {
            background: #222;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* BACKGROUND EFFECTS */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 50% 50%, rgba(20, 20, 20, 0) 0%, rgba(0, 0, 0, 0.8) 100%),
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 100%, 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 10;
        }

        header {
            padding: 20px 40px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .logo {
            font-family: var(--font-h);
            font-size: 1.2rem;
            letter-spacing: 4px;
            color: var(--accent);
            text-transform: uppercase;
        }

        .logo span {
            color: #fff;
            opacity: 0.5;
        }

        .ver {
            font-family: var(--font-m);
            font-size: 0.6rem;
            opacity: 0.4;
            letter-spacing: 2px;
        }

        /* PROGRESS STEPPER */
        .stepper {
            display: flex;
            gap: 20px;
            padding: 20px 40px;
            background: #080808;
            border-bottom: 1px solid var(--border);
            z-index: 90;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0.3;
            transition: opacity 0.3s;
        }

        .step.active {
            opacity: 1;
        }

        .step-num {
            width: 20px;
            height: 20px;
            border: 1px solid var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-m);
            font-size: 0.6rem;
            color: var(--accent);
        }

        .step-label {
            font-family: var(--font-h);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        main {
            flex: 1;
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 2px;
            background: var(--border);
            overflow: hidden;
            position: relative;
            z-index: 20;
        }

        .forge-panel {
            background: var(--bg);
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            min-height: 0;
            /* Important for flex scrolling */
        }

        /* CURRICULUM SELECTOR */
        .curriculum-selector {
            background: #0a0a0a;
            border: 1px solid #222;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        select {
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 10px;
            font-family: var(--font-m);
            font-size: 0.8rem;
            width: 100%;
            border-radius: 4px;
        }

        .outcome-list {
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 10px;
        }

        .outcome-item {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            font-size: 0.75rem;
            color: #888;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .outcome-item:hover {
            background: #151515;
            color: #fff;
        }

        .outcome-item input {
            margin-top: 2px;
            accent-color: var(--accent);
        }

        .output-panel {
            background: #080808;
            padding: 0;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            /* Constrain the chat */
            min-height: 0;
        }

        .panel-label {
            font-family: var(--font-m);
            font-size: 0.6rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        h2 {
            font-family: var(--font-h);
            font-size: 1.1rem;
            margin: 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #fff;
        }

        textarea {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 15px;
            font-family: var(--font-p);
            font-size: 0.9rem;
            min-height: 300px;
            resize: vertical;
            border-radius: 4px;
            box-sizing: border-box;
            transition: border-color 0.3s;
            flex-grow: 1;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        input[type="text"] {
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 10px 15px;
            font-family: var(--font-m);
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .btn-forge {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 18px 25px;
            font-family: var(--font-h);
            font-size: 1rem;
            line-height: 1;
            letter-spacing: 2px;
            cursor: pointer;
            text-transform: uppercase;
            border-radius: 4px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-forge:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px var(--accent-glow);
        }

        .btn-forge:disabled {
            background: #333;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* CHAT / STATUS VIEWER */
        #chat-display {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        .chat-msg {
            max-width: 85%;
            padding: 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.6;
            animation: fadeIn 0.5s ease-out;
        }

        .msg-ai {
            background: #111;
            border-left: 3px solid var(--accent);
            color: #ccc;
        }

        .msg-user {
            background: #1a1a1a;
            align-self: flex-end;
            border-right: 3px solid #444;
            color: #fff;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(5px);
        }

        .loader {
            width: 40px;
            height: 40px;
            border: 2px solid var(--accent);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-family: var(--font-m);
            font-size: 0.7rem;
            letter-spacing: 4px;
            color: var(--accent);
            text-transform: uppercase;
        }

        .toolbar {
            padding: 15px 30px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 15px;
            background: #0a0a0a;
        }

        .btn-secondary {
            background: transparent;
            color: #fff;
            border: 1px solid #444;
            padding: 8px 15px;
            font-family: var(--font-m);
            font-size: 0.65rem;
            cursor: pointer;
            text-transform: uppercase;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* CODE DISPLAY (Phase 4) */
        #code-display {
            display: none;
            background: #050505;
            padding: 30px;
            font-family: var(--font-m);
            font-size: 0.8rem;
            color: #888;
            overflow: auto;
            white-space: pre-wrap;
            flex: 1;
        }

        .markdown h1,
        .markdown h2,
        .markdown h3 {
            font-family: var(--font-h);
            color: var(--accent);
            margin-top: 0;
        }

        .markdown ul {
            padding-left: 20px;
        }

        .markdown code {
            background: #222;
            padding: 2px 5px;
            border-radius: 3px;
        }

        /* SETTINGS MODAL */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .settings-content {
            background: #111;
            border: 1px solid #333;
            padding: 40px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        .settings-close {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .settings-close:hover {
            opacity: 1;
        }

        .settings-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .settings-item label {
            font-family: var(--font-m);
            font-size: 0.7rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-settings-toggle {
            background: transparent;
            border: 1px solid #333;
            color: #888;
            padding: 5px 12px;
            font-family: var(--font-m);
            font-size: 0.6rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .btn-settings-toggle:hover {
            border-color: var(--accent);
            color: #fff;
        }

        /* HOSPITAL INTEGRATION */
        #hospital-view {
            display: none;
            height: 100%;
            grid-template-columns: 250px 1fr;
            background: #0a0a0a;
            border: 1px solid #1a3c3c;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }

        .hospital-sidebar {
            background: #111;
            border-right: 1px solid #1a3c3c;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
        }

        .hospital-main {
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .surgical-tab {
            padding: 10px;
            margin-bottom: 5px;
            background: #111;
            border: 1px solid #222;
            font-family: var(--font-h);
            font-size: 0.7rem;
            cursor: pointer;
            text-align: left;
            opacity: 0.6;
            transition: 0.3s;
        }

        .surgical-tab:hover,
        .surgical-tab.active {
            opacity: 1;
            border-color: #00ffcc;
            color: #00ffcc;
        }

        .custom-course-list {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid #222;
            padding: 5px;
            margin-top: 10px;
            background: #050505;
        }

        .custom-course-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            font-size: 0.6rem;
            border-bottom: 1px solid #111;
        }

        .custom-course-item:last-child {
            border-bottom: none;
        }

        .btn-mini-del {
            background: #400;
            color: #fff;
            border: none;
            padding: 2px 6px;
            font-size: 0.5rem;
            cursor: pointer;
            border-radius: 2px;
        }
    </style>
</head>

<body>

    <header>
        <div class="logo">BLOB <span>FACTORY</span></div>
        <div style="display:flex; align-items:center; gap:20px;">
            <button class="btn-settings-toggle" onclick="toggleSettings()">CORE SETTINGS</button>
            <div style="text-align:right;">
                <div class="ver">MASTER FORGE v65.97</div>
                <div id="header-model-status"
                    style="font-size:0.5rem; color:var(--accent); text-transform:uppercase; letter-spacing:1px; opacity:0.8; margin-top:2px;">
                    Brain: Xiaomi MiMo V2</div>
            </div>
        </div>
    </header>

    <div class="stepper">
        <div class="step active" id="step-1">
            <div class="step-num">1</div>
            <div class="step-label">Concept</div>
        </div>
        <div class="step" id="step-2">
            <div class="step-num">2</div>
            <div class="step-label">Deep Search</div>
        </div>
        <div class="step" id="step-3">
            <div class="step-num">3</div>
            <div class="step-label">Story</div>
        </div>
        <div class="step" id="step-4">
            <div class="step-num">4</div>
            <div class="step-label">Assets</div>
        </div>
        <div class="step" id="step-5">
            <div class="step-num">5</div>
            <div class="step-label">Birth</div>
        </div>
        <div class="step" id="step-6">
            <div class="step-num">6</div>
            <div class="step-label">Review</div>
        </div>
    </div>

    <main>
        <div class="forge-panel">
            <div class="input-group">
                <div class="panel-label">Current Step Context</div>
                <h2 id="stage-title">Commence Conception</h2>
                <p id="stage-desc" style="font-size:0.8rem; opacity:0.6;">Select a course and outcomes to target.</p>
            </div>

            <div class="curriculum-selector">
                <div class="panel-label">Nova Scotia Curriculum</div>
                <select id="course-select" onchange="updateOutcomes()">
                    <option value="">-- SELECT COURSE --</option>
                </select>
                <div id="outcome-checklist" class="outcome-list" style="margin-top:10px;">
                    <p style="font-size:0.6rem; opacity:0.3; text-align:center;">SELECT A COURSE TO LOAD OUTCOMES</p>
                </div>
            </div>

            <textarea id="forge-input" rows="12" placeholder="ADDITIONAL COMMANDS / CONTEXT..."></textarea>

            <button class="btn-forge" id="forge-btn" onclick="processForgeStep()">Submit Command</button>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-secondary" id="back-btn" onclick="goBack()" style="flex:1;">Back Step</button>
                <button class="btn-secondary" id="reset-btn" onclick="resetForge()" style="flex:1;">Reset Core</button>
            </div>
        </div>

        <div class="output-panel">
            <div class="status-overlay" id="status-overlay">
                <div class="loader"></div>
                <div class="loading-text" id="status-text">INITIALIZING CORE...</div>
            </div>

            <div id="chat-display">
                <div class="chat-msg msg-ai">
                    <strong>COREGINE v65.97 ONLINE.</strong><br>
                    Please provide the initial mission parameters or learning outcomes to begin Phase 1: Concept Arrive.
                </div>
            </div>

            <div id="code-display"></div>

            <!-- HOSPITAL INTEGRATION PANEL -->
            <div id="hospital-view">
                <div class="hospital-sidebar" id="hospital-nav">
                    <div class="hospital-label">Patient Nodes</div>
                    <!-- Nodes will be injected here -->
                </div>
                <div class="hospital-main">
                    <div class="hospital-label">Surgical Interface</div>
                    <div id="hospital-editor-container">
                        <div id="hospital-path"
                            style="font-family:var(--font-m); font-size:0.8rem; margin-bottom:10px; color:#00ffcc;">[
                            AWAITING SELECTION ]</div>
                        <textarea id="hospital-raw-editor"
                            style="width:100%; height:400px; background:#050505; color:#eee; border:1px solid #1a3c3c; padding:15px; font-family:var(--font-m); font-size:0.9rem;"></textarea>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn-forge" onclick="saveHospitalEdit()"
                                style="flex:1; background:#00ffcc; color:#000;">STABILIZE NODE</button>
                            <button id="btn-push-teacher" class="btn-forge" onclick="pushToTeacherMode()"
                                style="flex:1; display:none; background:#ffcc00; color:#000;">PUSH TO COMMAND
                                CENTER</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="toolbar" id="toolbar" style="display:none;">
                <button class="btn-secondary" onclick="copyCode()">Copy to Clipboard</button>
                <button class="btn-secondary" onclick="downloadBlob()">Download .blob</button>
                <button class="btn-secondary" onclick="openInHospital()"
                    style="border-color:#00ffcc; color:#00ffcc;">Start Clinical Review</button>
            </div>
        </div>
    </main>

    <!-- SETTINGS MODAL -->
    <div class="settings-overlay" id="settings-overlay">
        <div class="settings-content">
            <div class="settings-close" onclick="toggleSettings()">[CLOSE]</div>
            <h2 style="margin-bottom:10px;">CORE SETTINGS</h2>

            <div class="settings-item">
                <label>AI MODEL ARCHITECT</label>
                <select id="model-select">
                    <option value="xiaomi/mimo-v2-flash:free">Xiaomi MiMo V2 Flash (Default)</option>
                    <option value="tngtech/deepseek-r1t2-chimera:free">TNG: Deepseek R1T2 Chimera</option>
                    <option value="z-ai/glm-4.5-air:free">Z.AI GLM 4.5 Air</option>
                    <option value="allenai/olmo-3.1-32b-think:free">AllenAI Olmo 3.1</option>
                    <option value="nvidia/nemotron-nano-9b-v2:free">NVidia Nemotron Nano 9b</option>
                    <option value="nex-agi/deepseek-v3.1-nex-n1:free">Nex AGI Deepseek V3.1</option>
                    <option value="google/gemini-2.0-flash-exp:free">Google Gemini 2.0 Flash</option>
                </select>
            </div>

            <div class="settings-item">
                <label>STUDENT CALIBRATION (OFFSET)</label>
                <select id="complexity-select-settings" onchange="syncComplexity()">
                    <option value="Medium / Grade-Level">Medium (Standard Grade-Level)</option>
                    <option value="Low / Foundational">Low (Foundational Literacy)</option>
                    <option value="High / Advanced">High (Advanced Narrative/Nuance)</option>
                </select>
                <p style="font-size:0.6rem; opacity:0.4; margin:0;">Adjusts the concepts relative to the course grade.
                </p>
            </div>

            <div class="settings-item" style="border-top: 1px solid #222; padding-top: 15px;">
                <label>TEACHER MODE SYNC</label>
                <div style="display:flex; gap:5px; margin-bottom: 5px;">
                    <input type="password" id="teacher-pin" placeholder="ENTER TEACHER PIN (e.g. 8812)"
                        style="flex:1; background:#050505; border:1px solid #222; color:#fff; font-size:0.7rem; padding:5px;">
                    <button class="btn-forge" onclick="syncWithTeacherMode()"
                        style="font-size:0.6rem; padding:5px 10px;">SYNC</button>
                </div>
                <div id="sync-status"
                    style="font-size:0.5rem; color:#888; text-transform:uppercase; letter-spacing:1px;">Cloud Link:
                    Disconnected</div>
            </div>

            <div class="settings-item" style="border-top: 1px solid #222; padding-top: 15px;">
                <label>CUSTOM CURRICULUM LAB</label>
                <div style="display:flex; gap:5px; margin-bottom: 5px;">
                    <input type="text" id="custom-course-name" placeholder="CLASS NAME (e.g., Geo 11)"
                        style="flex:1; background:#050505; border:1px solid #222; color:#fff; font-size:0.7rem; padding:5px;">
                    <button class="btn-forge" onclick="addCustomCourse()"
                        style="font-size:0.6rem; padding:5px 10px;">ADD</button>
                </div>
                <textarea id="custom-course-outcomes" placeholder="OUTCOMES (ONE PER LINE)"
                    style="width:100%; height:80px; background:#050505; border:1px solid #222; color:#eee; font-size:0.7rem; padding:8px; font-family:var(--font-p);"></textarea>

                <div id="custom-course-list" class="custom-course-list">
                    <!-- Custom courses will appear here -->
                </div>
            </div>

            <button class="btn-forge" onclick="toggleSettings()" style="margin-top:10px;">CONFIRM PARAMETERS</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const PROXY_URL = 'https://nextjs-basic-lemon-one.vercel.app/api/chat';
        let currentStep = 1;
        let history = [];
        let accumulatedData = {};

        const NS_OUTCOMES = {
            "African Canadian Studies 11": [
                "Diversity and Identity: Understand diversity of Africa/cultures in shaping Canadian identity.",
                "Pre-Colonial History: History of pre-colonial African kingdoms leading to Transatlantic Slave Trade.",
                "Colonial Impact and Resistance: Impact of colonial expansion, enslavement, and resistance.",
                "Research and Communication: Historical research methods and clear communication.",
                "Civil Rights: Persistent struggle of peoples of African descent for equality.",
                "Empowerment: Collective consciousness as a strategy for empowerment."
            ],
            "Canadian History 11": [
                "G1: Pre-contact and post-contact First Nations governing structures.",
                "G2: French, British, and American governing philosophies merging in BNA.",
                "G3: Political and economic structures leading to Confederation.",
                "G4: Evolution of federalism from Confederation to Patriation.",
                "G5: Shift from two-party to multi-party process.",
                "J5: Evolution of the struggle to achieve rights and freedoms."
            ],
            "Contemporary Canadian Studies 11": [
                "Equity Advocacy: How Black Nova Scotians advocate for rights/reforms.",
                "Sustaining Communities: Impacts of encroachment/gentrification on Black communities.",
                "Community Priorities: How individuals/organizations support sustainability.",
                "Systemic Barriers: Impact on education, healthcare, housing, and church support."
            ],
            "Economics 11": [
                "SCO 8: Supply, demand, and price relationship in a market economy.",
                "SCO 10: Business organizations in the Canadian market.",
                "SCO 11: Impact of market structures (monopoly) on consumers.",
                "SCO 12: Role of governments (regulation, taxation) in the market.",
                "SCO 13: Measurement of Canadian economy (GDP)."
            ],
            "Global Sustainable Solutions 12": [
                "Indigenous Relationships: Relationships with land and colonial decisions.",
                "Water Security: Link between sanitation and public health.",
                "Food Security: Factors impacting food production and security.",
                "Disaster Management: Mitigation, preparedness, response, and recovery.",
                "Forced Migration: Conflict-induced and disaster-induced patterns."
            ],
            "Social Studies 7": [
                "Treaty Rights: Impact of policies/denial on Mi'kmaw communities.",
                "Indian Act: Impact on geographic, civic, and economic conditions.",
                "Mi'kmaq Resilience: Response to discriminatory policies.",
                "Resistance: Resisting assimilation and segregation attempts.",
                "Confederation: Impact on Mi'kmaq from multiple perspectives."
            ],
            "Social Studies 8": [
                "Assimilation Policies: Indian Act and residential school system impacts.",
                "Rights Advocacy: 1982 constitution and Truth and Reconciliation.",
                "Inequity Issues: Historical and contemporary injustice in Canada.",
                "First-Voice Perspectives: Understanding issues and inspiring resistance.",
                "Reconciliation: Role and purpose in addressing conflicts."
            ],
            "Sociology 12": [
                "Theories: Functionalism, conflict theory, symbolic interactionism, feminism.",
                "Culture: Core elements (symbols, language, norms, values).",
                "Socialization: Agents that shape the socialization process.",
                "Stratification: Gender, race, and socio-economic status.",
                "Social Control: Formal and informal ways to achieve conformity."
            ],
            "Tourism 11": ["Trends in Tourism: Research trends, issues, and innovations."],
            "IB Global Politics SL/HL": [
                "Power: Nature of power in shaping political outcomes.",
                "Rights: Theory and practice of human rights and justice.",
                "Sustainability: Approaches to development and challenges.",
                "Conflict: Causes of conflict and strategies for peace."
            ],
            "Citizenship 9": [
                "Engaged Citizenship: Collaboratively-designed service learning projects.",
                "Who Am I?: Citizenship rights of Mi'kmaw and traditionally disempowered people.",
                "Governance: Structure/selection of federal, provincial, indigenous governments."
            ],
            "Law 12": [
                "F5: Impact of Charter of Rights and Freedoms on justice.",
                "CR1: What constitutes a criminal offense in Canada.",
                "AB2: Legal effects of Indian Act (1876) and Constitution Act (1982).",
                "HR2: Safeguarding human rights in Canada."
            ],
            "Mi'kmaw Studies 11": [
                "12: Pre-contact society governance and oral culture.",
                "G4: Nationhood and Treaties (Concordat 1610).",
                "G5: Discriminatory Policies (Indian Act) adverse effects.",
                "E2: Residential Schools traumatizing impacts."
            ]
        };

        const SYSTEM_PROMPTS = {
            1: `You are the BLOB FACTORY COREGINE. We are in PHASE 1: CONCEPT ARRIVE.
Identify SCO + Ethical Audit. Propose 3 detailed Scenario Concepts based on the user's input, TARGET LEARNING OUTCOMES, and the specific STUDENT CALIBRATION.

OUTCOME REFERENCING:
Do not redefine or paraphrase the official Department of Education 'Learning Outcomes'. The official outcomes are provided to you as a list. Instead, for each concept, include a section called "THEMES TARGETING SELECTED OUTCOMES" to show how the simulation bridges the specific official outcomes provided.

CLASSIFICATION RULE: 
For each concept, explicitly state if the setting is "FICTIONAL" (hypothetical/imagined) or "BASED ON REAL WORLD EVENTS" (historical/current data).

CALIBRATION RULES:
1. BASELINE: Automatically calibrate narrative depth for the Grade Level of the course (e.g., Social 7 vs Econ 12).
2. STUDENT OFFSET: Use the 'FORGE COMPLEXITY' variable to adjust for the specific students in that class:
   - "Low": Foundational literacy, direct cause/effect, clear stakes.
   - "Medium": Typical grade-level analysis and vocabulary.
   - "High": Sophisticated nuance, complex ethical dilemmas, advanced reading level.

Rules: Standard Sentence Case. No All-Caps sections. Use Markdown.
End your response with: "WHICH CONCEPT SHALL WE FORGE? (Select 1-3 or provide feedback)"`,

            2: `We are in PHASE 2: DEEP SEARCH.
Take the chosen concept and expand it into a detailed mission outline.
List: 
1. The 10 Slide Titles and their high-level narrative purpose.
2. The 'Intel' data strategy (Primary, Legal, Intel tabs) for the core slides.
3. The Learning Outcomes and Intelligence Glossary terms.
Rules: Standard Sentence Case. No All-Caps. 
End your response with: "SHALL WE PROCEED TO FULL STORY DRAFTING?"`,

            3: `We are in PHASE 3: STORY CONFIRM.
Draft the FULL immersive prose for all 10 slides, including the sidebars (Intel, Legal, Primary tabs).
Rules: High stakes, immersive, dramatic. Use standard sentence case. 200-400 words per slide.
Identify the interaction choice and consequences.
End your response with: "READY TO SECURE ASSETS?"`,

            4: `We are in PHASE 4: ASSET SECURE.
Based on the story, propose a Visual Strategy for the mission.
List each slide and its associated 'Unsplash Keyword' for the mediaURL.
Keywords should be evocative and high-quality (e.g., 'cyberpunk city' vs 'city').
End your response with: "SHALL WE COMMENCE BLOB BIRTH CONTENTION?"`,

            5: `We are in PHASE 5: BLOB BIRTH.
Compile the confirmed story and assets into a valid Situation Room JSON (.blob).
Ensure all keywords from Phase 4 are formatted as "https://source.unsplash.com/featured/?keyword".
OUTPUT ONLY THE JSON CODE BLOCK.`,

            6: `We are in PHASE 6: CLINICAL REVIEW.
The mission is forged. We are now entering the Hospital for surgical refinement.
You are now the SURGEON AI.
Ask the user: "WOULD YOU LIKE TO BEGIN THE CLINICAL REVIEW OR DOWNLOAD THE SOURCE?"`
        };

        const MASTER_SYSTEM_PROMPT_CORE = `
You are the BLOB FACTORY COREGINE (v65.97), the multi-stage mission architect.
GOAL: Guide the user from a seed concept to a fully realized .blob mission.

CONTEXT BASELINE:
- Unless explicitly told otherwise, assume you are working within the Nova Scotia (CANADIAN) curriculum.
- By default, references to topics like "The Constitution", "1982", or "Truth and Reconciliation" refer to the Canadian context.
- However, if the user specifies a different nation or international context (e.g., IB Global Politics, Ecuador), adapt your knowledge base to that specific region immediately.

STYLE RULES:
- Use a PUNCHY, ACTIVE writing style like modern journalism.
- MANDATORY: Short paragraphs (MAX 3-4 sentences each).
- No fluff or overly academic language.

SCHEMA RULES:
- metadata: { title, id, author, thumb, description, simulationType, learningOutcomes }
- slides: Array of objects { id, type, title, content, mediaURL, intel: { primary, legal, intel }, interactionPrompt, options, outcomes }
- intelligenceGlossary: Array of terms.

FORMATTING: Use Standard Sentence Case. NO ALL-CAPS paragraphs. No escaped newlines.
`;

        function updateOutcomes() {
            const courseSelect = document.getElementById('course-select');
            const container = document.getElementById('outcome-checklist');
            if (!courseSelect || !container) return;

            const course = courseSelect.value;
            container.innerHTML = "";

            const allOutcomes = { ...NS_OUTCOMES, ...getCustomOutcomes() };
            if (!course || !allOutcomes[course]) {
                container.innerHTML = '<p style="font-size:0.6rem; opacity:0.3; text-align:center;">SELECT A COURSE TO LOAD OUTCOMES</p>';
                return;
            }

            allOutcomes[course].forEach((outcome, i) => {
                const div = document.createElement('div');
                div.className = 'outcome-item';
                div.innerHTML = `<input type="checkbox" id="out-${i}" value="${outcome}"> <label for="out-${i}">${outcome}</label>`;
                container.appendChild(div);
            });
        }

        window.onload = () => {
            initializeCurriculum();
        };

        function initializeCurriculum() {
            const sel = document.getElementById('course-select');
            if (sel) {
                sel.innerHTML = '<option value="">-- SELECT COURSE --</option>';
                const allOutcomes = { ...NS_OUTCOMES, ...getCustomOutcomes() };
                Object.keys(allOutcomes).sort().forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c; opt.innerText = c; sel.appendChild(opt);
                });
            }
            renderCustomCourseList();
        }

        const CLOUD_URL = "https://script.google.com/macros/s/AKfycbxmJmFtT2E9OEPtFdTx2O3nBlz2zCoSQz69N37jRipWMpKd52iB_beF34cqUQbfo4MJ/exec";
        let isTeacherLinked = false;
        let teacherPin = "";

        async function syncWithTeacherMode() {
            const pin = document.getElementById('teacher-pin').value;
            if (!pin) return alert("PIN REQUIRED.");

            document.getElementById('sync-status').innerText = "Cloud Link: Syncing...";
            try {
                // We'll use a specific action name for outcomes, but first we test the PIN via a generic fetch if possible
                // For now, we'll try to fetch custom curriculum from the sheet
                const res = await fetch(CLOUD_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_curriculum', pin: pin })
                });
                const j = await res.json();

                if (j.status === "success") {
                    isTeacherLinked = true;
                    teacherPin = pin;
                    document.getElementById('sync-status').innerText = "Cloud Link: Linked (Ready)";
                    document.getElementById('sync-status').style.color = "var(--accent)";
                    document.getElementById('btn-push-teacher').style.display = 'block';

                    if (j.curriculum) {
                        localStorage.setItem('blob_custom_curriculum', JSON.stringify(j.curriculum));
                        initializeCurriculum();
                    }
                    alert("COMMAND CENTER LINK ESTABLISHED.");
                } else {
                    throw new Error(j.message || "Invalid PIN or Connection Error.");
                }
            } catch (e) {
                document.getElementById('sync-status').innerText = "Cloud Link: Auth Failed";
                document.getElementById('sync-status').style.color = "#ff4444";
                alert(`SYNC ERROR: ${e.message}`);
            }
        }

        async function pushToTeacherMode() {
            if (!isTeacherLinked) return alert("TEACHER MODE NOT LINKED.");
            if (!accumulatedData || !accumulatedData.metadata) return alert("NO BLOBS DETECTED IN THEATER.");

            const id = accumulatedData.metadata.id || "GENERIC";
            const name = accumulatedData.metadata.title || "Unnamed Mission";

            if (!confirm(`PUSH MISSION [${name}] TO COMMAND CENTER?`)) return;

            showLoader(true, "TRANSMITTING TO COMMAND CENTER...");
            try {
                const res = await fetch(CLOUD_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'update_content',
                        pin: teacherPin,
                        id: id,
                        name: name,
                        payload: accumulatedData
                    })
                });
                const j = await res.json();
                if (j.status === "success") {
                    alert("CAPSULE COMMITTED TO COMMAND CENTER.");
                } else {
                    throw new Error(j.message);
                }
            } catch (e) {
                alert(`PUSH FAILED: ${e.message}`);
            } finally {
                showLoader(false);
            }
        }

        function getCustomOutcomes() {
            const stored = localStorage.getItem('blob_custom_curriculum');
            const local = stored ? JSON.parse(stored) : {};
            return local;
        }

        async function saveCustomCourseToCloud(name, outcomes) {
            if (!isTeacherLinked) return;
            try {
                const custom = getCustomOutcomes();
                await fetch(CLOUD_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'save_curriculum',
                        pin: teacherPin,
                        curriculum: custom
                    })
                });
            } catch (e) { console.error("Cloud save failed", e); }
        }

        function addCustomCourse() {
            const name = document.getElementById('custom-course-name').value.trim();
            const outcomesRaw = document.getElementById('custom-course-outcomes').value.trim();
            if (!name || !outcomesRaw) return alert("NAME AND OUTCOMES REQUIRED.");

            const outcomes = outcomesRaw.split('\n').map(o => o.trim()).filter(o => o.length > 0);
            if (outcomes.length === 0) return alert("AT LEAST ONE VALID OUTCOME REQUIRED.");

            const custom = getCustomOutcomes();
            custom[name] = outcomes;
            localStorage.setItem('blob_custom_curriculum', JSON.stringify(custom));

            if (isTeacherLinked) saveCustomCourseToCloud(name, outcomes);

            document.getElementById('custom-course-name').value = "";
            document.getElementById('custom-course-outcomes').value = "";
            initializeCurriculum();
            alert(`COURSE '${name}' ADMITTED TO LAB.`);
        }

        function deleteCustomCourse(name) {
            if (!confirm(`PURGE '${name}' FROM LAB?`)) return;
            const custom = getCustomOutcomes();
            delete custom[name];
            localStorage.setItem('blob_custom_curriculum', JSON.stringify(custom));
            initializeCurriculum();
        }

        function renderCustomCourseList() {
            const listContainer = document.getElementById('custom-course-list');
            if (!listContainer) return;
            const custom = getCustomOutcomes();
            const keys = Object.keys(custom);

            if (keys.length === 0) {
                listContainer.innerHTML = '<p style="font-size:0.5rem; opacity:0.3; padding:10px; text-align:center;">NO CUSTOM COURSES DEFINED</p>';
                return;
            }

            listContainer.innerHTML = "";
            keys.sort().forEach(name => {
                const item = document.createElement('div');
                item.className = 'custom-course-item';
                item.innerHTML = `
                    <span>${name} (${custom[name].length} Outcomes)</span>
                    <button class="btn-mini-del" onclick="deleteCustomCourse('${name}')">DEL</button>
                `;
                listContainer.appendChild(item);
            });
        }

        function toggleSettings() {
            const overlay = document.getElementById('settings-overlay');
            const isClosing = overlay.style.display === 'flex';
            overlay.style.display = isClosing ? 'none' : 'flex';

            if (isClosing) {
                // Update header status on confirm/close
                const modelSel = document.getElementById('model-select');
                const modelName = modelSel.options[modelSel.selectedIndex].text.split(' (')[0];
                document.getElementById('header-model-status').innerText = `Brain: ${modelName}`;
            }
        }

        function syncComplexity() {
            // Sync settings select to panel select
            const settingsVal = document.getElementById('complexity-select-settings').value;
            const panelSelect = document.getElementById('complexity-select');
            if (panelSelect) panelSelect.value = settingsVal;
        }

        async function processForgeStep() {
            let rawInputInput = document.getElementById('forge-input');
            let rawInput = rawInputInput ? rawInputInput.value.trim() : "";
            const course = document.getElementById('course-select').value;
            const checkedOutcomes = Array.from(document.querySelectorAll('#outcome-checklist input:checked')).map(v => v.value);

            // Get current and model complexity
            const complexity = document.getElementById('complexity-select-settings').value;
            const model = document.getElementById('model-select').value;

            let input = rawInput;
            if (currentStep === 1) {
                if (course && checkedOutcomes.length > 0) {
                    input = `COURSE: ${course}\nFORGE COMPLEXITY: ${complexity}\nTARGET OUTCOMES:\n- ${checkedOutcomes.join('\n- ')}\n\nUSER CONTEXT: ${rawInput || "(Generic Concept Generation Based on Outcomes)"}`;
                } else if (!rawInput) {
                    return alert("COMMAND INPUT REQUIRED OR SELECT COURSE/OUTCOMES.");
                }
                document.querySelector('.curriculum-selector').style.display = 'none';
            }

            addMessage(input, 'user');
            document.getElementById('forge-input').value = "";
            showLoader(true, getLoadingMessage());

            // Prepare history for AI (Xiaomi Total Stability: Collapse everything into 'message')
            let context = `${MASTER_SYSTEM_PROMPT_CORE}\n${SYSTEM_PROMPTS[currentStep]}\n\n`;
            history.forEach(m => {
                context += `${m.role.toUpperCase()}: ${m.content}\n\n`;
            });
            context += `CURRENT USER INPUT: ${input}`;

            try {
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: context,
                        model: model
                    })
                });

                const data = await response.json();
                console.log("RAW COREGINE RESPONSE:", data);

                if (data.error || !data.choices || !data.choices[0]) {
                    const rawErr = data.error || data;
                    const errMsg = rawErr.message ? rawErr.message : JSON.stringify(rawErr);
                    throw new Error(`API ERROR: ${errMsg}`);
                }

                const reply = data.choices[0].message.content;

                history.push({ role: "user", content: input });
                history.push({ role: "assistant", content: reply });

                if (currentStep === 5) {
                    handleBirth(reply);
                } else {
                    addMessage(reply, 'ai');

                    // Dynamic Guidance Update
                    if (currentStep === 1 && (reply.includes("PROPOSE") || reply.includes("WHICH CONCEPT"))) {
                        document.getElementById('stage-desc').innerText = "SELECT A CONCEPT (1-3) OR PROVIDE FEEDBACK.";
                        document.getElementById('forge-input').placeholder = "ENTER CHOICE (e.g., 'CONCEPT 2')...";
                    }

                    checkForStepIncrement(input, reply);
                }

            } catch (err) {
                console.error(err);
                addMessage("CORE ERROR: Connection link severed. " + err.message, 'ai');
            } finally {
                showLoader(false);
            }
        }

        function checkForStepIncrement(input, reply) {
            const up = reply.toUpperCase();
            if (currentStep === 1 && (up.includes("WHICH CONCEPT") || up.includes("FORGE?"))) {
                // Stay until chosen
            } else if (currentStep === 1 && (input.toUpperCase().includes("CONCEPT") || input.length <= 2)) {
                moveToStep(2);
            } else if (currentStep === 2 && up.includes("PROCEED")) {
                moveToStep(3);
            } else if (currentStep === 3 && up.includes("SECURE ASSETS")) {
                moveToStep(4);
            } else if (currentStep === 4 && up.includes("COMMENCE BLOB BIRTH")) {
                moveToStep(5);
            }
        }

        function goBack() {
            if (currentStep > 1) {
                moveToStep(currentStep - 1);
            }
        }

        function moveToStep(step) {
            currentStep = step;
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.toggle('active', (i + 1) <= currentStep);
            });

            const titles = ["CONCEPT ARRIVE", "DEEP SEARCH", "STORY CONFIRM", "ASSET SECURE", "BLOB BIRTH", "CLINICAL REVIEW"];
            const descs = [
                "Lock in the historical mission context.",
                "Expand the intel database and slide map.",
                "Review and finalize the narrative prose.",
                "Establish visual language and media keywords.",
                "Transmuting story into data.",
                "Final surgical review and medical stabilization."
            ];

            const placeholders = [
                "DESCRIBE MISSION CONTEXT...",
                "FEEDBACK ON OUTLINE / INTEL...",
                "FINAL NARRATIVE ADJUSTMENTS...",
                "FEEDBACK ON ASSET KEYWORDS...",
                "BIRTHING...",
                "REVIEWING..."
            ];
            document.getElementById('forge-input').placeholder = placeholders[step - 1];

            document.getElementById('stage-title').innerText = titles[step - 1];
            document.getElementById('stage-desc').innerText = descs[step - 1];


            // Show/Hide selector based on step
            if (step === 1) {
                document.querySelector('.curriculum-selector').style.display = 'flex';
                document.getElementById('forge-input').disabled = false;
            } else if (step === 5) {
                document.getElementById('forge-input').placeholder = "BIRTHING...";
                document.getElementById('forge-input').disabled = true;
                document.getElementById('forge-btn').innerText = "BIRTHING...";
                document.getElementById('forge-btn').disabled = true;
                // Auto-trigger step 5
                processForgeStep();
            } else if (step === 6) {
                document.getElementById('forge-input').disabled = true;
                document.getElementById('forge-btn').innerText = "SURGERY IN PROGRESS";
                document.getElementById('forge-btn').disabled = true;
                document.getElementById('stage-desc').innerText = "MISSION FORGED. READY FOR HOSPITAL REVIEW.";
            } else {
                document.querySelector('.curriculum-selector').style.display = 'none';
                document.getElementById('forge-input').disabled = false;
                document.getElementById('forge-btn').innerText = "FORGE";
                document.getElementById('forge-btn').disabled = false;
            }
        }

        function handleBirth(reply) {
            let jsonStr = reply;
            if (reply.includes("```json")) {
                jsonStr = reply.split("```json")[1].split("```")[0].trim();
            } else if (reply.includes("```")) {
                jsonStr = reply.split("```")[1].split("```")[0].trim();
            }

            try {
                accumulatedData = JSON.parse(jsonStr);
                document.getElementById('chat-display').style.display = 'none';
                document.getElementById('code-display').style.display = 'block';
                document.getElementById('code-display').innerText = JSON.stringify(accumulatedData, null, 4);
                document.getElementById('toolbar').style.display = 'flex';
                document.getElementById('status-text').innerText = "BIRTH SUCCESSFUL.";
                gsap.from("#code-display", { opacity: 0, y: 20, duration: 1 });
                moveToStep(6);
            } catch (e) {
                addMessage("BIRTH DEFECT: JSON parsing failed. Please check the output manually below.", 'ai');
                document.getElementById('code-display').style.display = 'block';
                document.getElementById('code-display').innerText = reply;
            }
        }

        function addMessage(text, role) {
            const chat = document.getElementById('chat-display');
            const div = document.createElement('div');
            div.className = `chat-msg msg-${role}`;
            div.innerHTML = role === 'ai' ? marked.parse(text) : text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function showLoader(show, text) {
            document.getElementById('status-overlay').style.display = show ? 'flex' : 'none';
            if (text) document.getElementById('status-text').innerText = text;
        }

        function getLoadingMessage() {
            const msgs = {
                1: "FORGING CONCEPTS...",
                2: "DEEP SEARCHING HISTORY...",
                3: "DRAFTING NARRATIVE...",
                4: "SECURING ASSETS...",
                5: "INCUBATING BLOB...",
                6: "PREPPING SURGERY..."
            };
            return msgs[currentStep];
        }

        function resetForge() {
            if (confirm("PURGE CORE MEMORY? THIS WILL RESET THE FORGE.")) {
                location.reload();
            }
        }

        // TOOLBAR ACTIONS
        function copyCode() {
            const code = document.getElementById('code-display').innerText;
            navigator.clipboard.writeText(code);
            alert("SOURCE COPIED TO CLIPBOARD.");
        }

        function downloadBlob() {
            if (!accumulatedData) return;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(accumulatedData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", (accumulatedData.metadata.title || "mission") + ".blob");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // HOSPITAL INTEGRATION LOGIC
        let currentHospitalPath = null;

        function initHospital() {
            document.getElementById('hospital-view').style.display = 'grid';
            document.getElementById('code-display').style.display = 'none';
            renderHospitalNav();
        }

        function renderHospitalNav() {
            const nav = document.getElementById('hospital-nav');
            nav.innerHTML = '<div class="hospital-label">Patient Nodes</div>';

            // Metadata
            const meta = document.createElement('div');
            meta.className = 'surgical-tab';
            meta.innerText = 'CORE METADATA';
            meta.onclick = () => selectHospitalNode('metadata');
            nav.appendChild(meta);

            // Slides
            if (accumulatedData.slides) {
                accumulatedData.slides.forEach((slide, idx) => {
                    const s = document.createElement('div');
                    s.className = 'surgical-tab';
                    s.innerText = `SLIDE ${idx + 1}: ${slide.title}`;
                    s.onclick = () => selectHospitalNode(`slides[${idx}]`);
                    nav.appendChild(s);
                });
            }

            // Glossary
            const glos = document.createElement('div');
            glos.className = 'surgical-tab';
            glos.innerText = 'INTELLIGENCE GLOSSARY';
            glos.onclick = () => selectHospitalNode('intelligenceGlossary');
            nav.appendChild(glos);
        }

        function selectHospitalNode(path) {
            currentHospitalPath = path;
            document.getElementById('hospital-path').innerText = `NODE: ${path.toUpperCase()}`;

            let data = null;
            if (path === 'metadata') data = accumulatedData.metadata;
            else if (path === 'intelligenceGlossary') data = accumulatedData.intelligenceGlossary;
            else if (path.startsWith('slides[')) {
                const idx = parseInt(path.match(/\d+/)[0]);
                data = accumulatedData.slides[idx];
            }

            document.getElementById('hospital-raw-editor').value = JSON.stringify(data, null, 4);

            // Highlight active tab
            document.querySelectorAll('.surgical-tab').forEach(t => {
                t.classList.toggle('active', t.innerText.includes(path.toUpperCase()) || (path.startsWith('slides') && t.innerText.includes(`SLIDE ${parseInt(path.match(/\d+/)[0]) + 1}`)));
            });
        }

        function saveHospitalEdit() {
            if (!currentHospitalPath) return;
            try {
                const newVal = JSON.parse(document.getElementById('hospital-raw-editor').value);

                if (currentHospitalPath === 'metadata') accumulatedData.metadata = newVal;
                else if (currentHospitalPath === 'intelligenceGlossary') accumulatedData.intelligenceGlossary = newVal;
                else if (currentHospitalPath.startsWith('slides[')) {
                    const idx = parseInt(currentHospitalPath.match(/\d+/)[0]);
                    accumulatedData.slides[idx] = newVal;
                }

                alert("NODE STABILIZED.");
                // Update code display if they switch back
                document.getElementById('code-display').innerText = JSON.stringify(accumulatedData, null, 4);
                renderHospitalNav();
            } catch (e) {
                alert("SURGICAL ERROR: Invalid JSON format.");
            }
        }

        function openInHospital() {
            initHospital();
        }
    </script>
</body>

</html>