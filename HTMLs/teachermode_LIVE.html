<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>MISSION CONTROL // TEACHER MODE</title>
    <script>const URL = "https://script.google.com/macros/s/AKfycbxbbQixDBQaGRAvoT9dNiJJ6UnfjOrGd0uyXiWNo8HcQ_afQW69jp2yvVr0Gp7_z2LS/exec"; const PIN = "8812";</script>
    <style>
        :root {
            --bg: #f4f4f4;
            --accent: #222;
            --success: #28a745;
            --err: #dc3545;
            --terminal: #000;
            --term-txt: #0f0;
        }

        body {
            font-family: 'Courier New', monospace;
            padding: 40px;
            background: var(--bg);
            color: #333;
            margin: 0;
        }

        #status-bar {
            background: #1a1a1a;
            color: #fff;
            padding: 15px 25px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 5px solid var(--accent);
        }

        .status-light {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #666;
            display: inline-block;
            margin-right: 10px;
        }

        .status-light.online {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .status-light.offline {
            background: var(--err);
            box-shadow: 0 0 10px var(--err);
        }

        h1 {
            text-transform: uppercase;
            letter-spacing: 5px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 10px;
            margin-bottom: 30px;
            font-size: 1.5rem;
        }

        #console {
            background: var(--terminal);
            color: var(--term-txt);
            padding: 15px;
            height: 180px;
            overflow-y: auto;
            font-size: 0.8rem;
            border: 1px solid #333;
            margin-bottom: 30px;
        }

        .panel {
            background: #fff;
            padding: 30px;
            border: 1px solid #ddd;
            border-top: 5px solid var(--accent);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
        }

        input,
        textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            font-family: inherit;
            box-sizing: border-box;
        }

        .btn {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            transition: 0.2s;
        }

        .btn:hover {
            background: #444;
        }

        .btn-del {
            color: var(--err);
            cursor: pointer;
            font-weight: bold;
            font-size: 0.6rem;
            text-decoration: underline;
            border: none;
            background: none;
            padding: 0;
        }

        .btn-del:hover {
            color: #8b0000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            text-align: left;
            font-size: 0.75rem;
            vertical-align: middle;
        }

        th {
            background: var(--accent);
            color: #fff;
            text-transform: uppercase;
            font-size: 0.6rem;
            letter-spacing: 1px;
        }

        .thumb {
            width: 46px;
            height: 46px;
            background-size: cover;
            background-position: center;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        label {
            font-size: 0.6rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
            font-weight: bold;
        }

        /* PROJECTOR MODE */
        #projector-view {
            display: none;
            position: fixed;
            inset: 0;
            background: #050505;
            z-index: 2000;
            padding: 40px;
            overflow-y: auto;
        }

        #projector-view.active {
            display: block;
        }

        .proj-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #d2b48c;
            padding-bottom: 20px;
            margin-bottom: 40px;
        }

        .proj-header h1 {
            margin: 0;
            letter-spacing: 8px;
            font-size: 2rem;
            color: #d2b48c;
            text-transform: uppercase;
        }

        .proj-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .proj-card {
            background: #111;
            border: 1px solid #333;
            padding: 25px;
            transition: 0.3s;
        }

        .proj-card.active {
            border-color: #d2b48c;
            box-shadow: 0 0 20px rgba(210, 180, 140, 0.1);
        }

        .proj-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: #d2b48c;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .proj-class {
            font-size: 0.8rem;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        .proj-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            border-top: 1px solid #333;
            padding-top: 15px;
        }

        .proj-bar {
            height: 4px;
            background: #222;
            margin-top: 20px;
        }

        .proj-fill {
            height: 100%;
            background: #d2b48c;
            transition: width 1s ease;
        }
    </style>
</head>

<div id="projector-view">
    <header class="proj-header">
        <h1>COMMAND PROGRESS BOARD</h1>
        <div style="display:flex; gap:20px; align-items:center;">
            <span id="proj-sync" style="font-size:0.8rem; color:#666; letter-spacing:2px;">[SYNCING]</span>
            <button onclick="toggleProjector()"
                style="background:#d2b48c; color:#000; border:none; padding:10px 20px; cursor:pointer; font-weight:bold; letter-spacing:1px;">EXIT
                PROJECTOR</button>
        </div>
    </header>
    <div id="proj-board" class="proj-grid"></div>
</div>

<div id="status-bar">
    <div><span id="s-light" class="status-light"></span> <span id="s-text"
            style="letter-spacing: 2px;">VINTAGE_LINK_OFFLINE</span></div>
    <div style="display:flex; gap:20px; align-items:center;">
        <button onclick="toggleProjector()"
            style="background:#333; color:#d2b48c; font-size:0.6rem; border:1px solid #d2b48c; padding:6px 15px; border-radius:3px; cursor:pointer; font-weight:bold; letter-spacing:1px;">üì∫
            PROJECTOR VIEW</button>
        <a href="projector.html" target="_blank"
            style="color:var(--accent); font-size:0.6rem; text-decoration:none; border:1px solid var(--accent); padding:5px 10px; border-radius:3px;">NEW
            WINDOW</a>
        <button onclick="toggleLibrary()"
            style="background:var(--accent); color:#fff; font-size:0.6rem; border:none; padding:6px 15px; border-radius:3px; cursor:pointer; font-weight:bold; letter-spacing:1px;">üìö
            OPEN COMMUNITY HUB</button>
        <div style="font-size: 0.7rem; opacity: 0.7;">TEACHER MODE // v62.6</div>
    </div>
</div>
<h1 style="margin: 0 40px 30px 40px;">COMMAND CENTER // MISSION CONTROL</h1>
<div class="grid" style="grid-template-columns: 1fr 1.5fr 1fr; padding: 0 40px;">
    <div class="panel">
        <h3
            style="margin-top:0; letter-spacing:2px; font-size:0.8rem; border-bottom:1px solid #ddd; padding-bottom:10px;">
            CAPSULE INJECTION</h3>
        <div id="upload-zone"
            style="border:2px dashed #ccc; padding:20px; text-align:center; margin-bottom:20px; cursor:pointer;"
            onclick="document.getElementById('file-input').click()">
            <div style="font-size:1.5rem; margin-bottom:5px;">üìÅ</div>
            <div style="font-size:0.5rem; color:#666; font-weight:bold;">LOAD .BLOB CAPSULE</div>
            <input type="file" id="file-input" accept=".blob" style="display:none" onchange="handleFile(this.files[0])">
        </div>
        <label>Mission ID</label><input id="m-id" placeholder="e.g. CUBA62">
        <label>Public Name</label><input id="m-name" placeholder="Operation Anadyr">
        <label>Raw Payload</label><textarea id="json-input" style="height: 60px; font-size:0.6rem;"
            placeholder="..."></textarea>
        <button class="btn" style="padding:10px; font-size:0.75rem;" onclick="upload()">INITIALIZE ARCHIVE</button>
    </div>

    <div class="panel">
        <div
            style="display:flex; justify-content:space-between; align-items:flex-start; border-bottom:1px solid #ddd; padding-bottom:10px; margin-bottom:20px;">
            <h3 style="margin:0; letter-spacing:2px; font-size:0.8rem;">LIVE PROGRESS BOARD</h3>
            <div id="sync-tick" style="font-size:0.55rem; color:#888;">[SYNC_IDLE]</div>
        </div>
        <div style="margin-bottom:15px; display:flex; gap:10px;">
            <select id="class-filter" style="flex:1; padding:8px; font-family:inherit; font-size:0.75rem;"
                onchange="renderProgress()">
                <option value="ALL">ALL CLASSES</option>
            </select>
            <button class="btn" style="width:auto; padding:0 15px; font-size:0.6rem;"
                onclick="fetchProgress()">REFRESH</button>
        </div>
        <div id="progress-list" style="max-height:500px; overflow-y:auto; border:1px solid #eee;"></div>
    </div>

    <div style="display:flex; flex-direction:column; gap:20px;">
        <div class="panel" style="padding:20px; background:var(--terminal); border-top:none;">
            <h3 style="margin-top:0; color:#fff; font-size:0.6rem; letter-spacing:1px; opacity:0.6;">SYSTEM LOG</h3>
            <div id="console" style="height:150px; overflow-y:auto; font-size:0.65rem; color:var(--term-txt);">
            </div>
        </div>
        <div class="panel" style="flex:1;">
            <h3
                style="margin-top:0; letter-spacing:2px; font-size:0.8rem; border-bottom:1px solid #ddd; padding-bottom:10px;">
                LIVE DIRECTORY</h3>
            <div id="lib-log" style="font-size: 0.55rem; color: #888; margin-bottom: 10px;">Scanning...</div>
            <div id="library-list"></div>
        </div>
    </div>
</div>

<div id="library-hub"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:3000; padding:60px; overflow-y:auto;">
    <div
        style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--accent); padding-bottom:20px; margin-bottom:40px;">
        <h1 style="margin:0; color:var(--accent); letter-spacing:5px; border-bottom:none;">COMMUNITY ARCHIVE HUB
        </h1>
        <button onclick="toggleLibrary()"
            style="background:transparent; border:1px solid #666; color:#666; padding:10px 20px; cursor:pointer; font-family:inherit;">[CLOSE_HUB]</button>
    </div>
    <div id="hub-grid" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
        <div style="grid-column:1/-1; text-align:center; padding:100px; opacity:0.5; color:#fff;">LOADING MISSION
            CATALOG...</div>
    </div>
</div>
<script>
    let allProgress = [];
    const fetchWithTimeout = async (url, options = {}, timeout = 10000) => {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        const response = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(id); return response;
    };

    function log(m, t = "info") {
        const c = document.getElementById('console'); const color = t === "success" ? "lime" : t === "error" ? "red" : "#0f0";
        if (!c) return;
        c.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${m}</div>`;
        c.scrollTop = c.scrollHeight;
    }
    function setStatus(s, t) { document.getElementById('s-light').className = "status-light " + s; document.getElementById('s-text').innerText = t; }

    // COMMUNITY HUB LOGIC
    const LIB_URL = "https://raw.githubusercontent.com/dwaugh-edsim/projectimages/main/capsule-library/index.json";
    function toggleLibrary() {
        const h = document.getElementById('library-hub');
        const show = h.style.display === 'none';
        h.style.display = show ? 'block' : 'none';
        if (show) fetchLibrary();
    }
    async function fetchLibrary() {
        try {
            const res = await fetch(LIB_URL);
            if (!res.ok) throw new Error("Catalog not found.");
            const j = await res.json(); renderLibrary(j.capsules);
        } catch (e) { document.getElementById('hub-grid').innerHTML = `<div style="grid-column:1/-1; text-align:center; color:red; padding:100px;">CONNECTION_ERROR: Failed to fetch Community Archive.</div>`; }
    }
    function renderLibrary(caps) {
        let h = "";
        caps.forEach(c => {
            h += `<div class="panel" style="border-top-color:#666;">
                    <div style="height:150px; background-image:url('${c.thumb}'); background-size:cover; background-position:center; margin-bottom:15px; border-radius:4px; border:1px solid #333;"></div>
                    <h4 style="margin:0; letter-spacing:1px; font-size:0.85rem;">${c.title}</h4>
                    <div style="font-size:0.6rem; color:#888; margin-bottom:15px; text-transform:uppercase;">AUTHOR: ${c.author}</div>
                    <p style="font-size:0.7rem; height:45px; overflow:hidden; opacity:0.7; line-height:1.4;">${c.description}</p>
                    <button class="btn" onclick="importMission('${c.downloadUrl}', '${c.id}', '${c.title}')" style="background:transparent; border:1px solid var(--accent); color:var(--accent); padding:8px; font-size:0.6rem; width:100%; margin-top:10px;">IMPORT TO ARCHIVE</button>
                </div>`;
        });
        document.getElementById('hub-grid').innerHTML = h || "<div style='grid-column:1/-1; text-align:center; opacity:0.5; padding:100px; color:#fff;'>NO MISSIONS IN CATALOG.</div>";
    }
    async function importMission(url, id, name) {
        log(`Syncing Remote Capsule [${id}]...`);
        try {
            const res = await fetch(url); const payload = await res.json();
            const res2 = await fetch(URL, { method: 'POST', body: JSON.stringify({ action: 'update_content', pin: PIN, id: id, name: name, payload: payload }) });
            const j = await res2.json();
            if (j.status === "success") { log(`Remote Capsule [${id}] committed to local record.`, "success"); fetchMissions(); alert(`Mission [${name}] successfully imported!`); }
            else log(j.message, "error");
        } catch (e) { log(`Import failed: ${e.message}`, "error"); }
    }

    async function fetchMissions() {
        log("Pinging Archive Server...");
        try {
            const res = await fetchWithTimeout(URL + "?action=list_missions");
            if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
            const j = await res.json();
            if (j.status === "success") {
                setStatus("online", "ENCRYPTED_LINK_ACTIVE");
                renderMissions(j.missions); fetchProgress();
                log("Handshake successful. Directory synchronized.", "success");
            } else { throw new Error(j.message || "Unknown server error"); }
        } catch (e) {
            setStatus("offline", "CONNECTION_FAILURE");
            log(`CRITICAL: ${e.message}`, "error");
            log("HINT: Ensure the Apps Script URL and TEACHER_PIN are correctly configured.");
            renderMissions([]); // Show empty table so UI isn't empty
        }
    }

    async function upload() {
        const id = document.getElementById('m-id').value.toUpperCase().replace(/\s/g, ''), name = document.getElementById('m-name').value, raw = document.getElementById('json-input').value;
        if (!id || !name || !raw) return log("ABORTED: Missing required parameters.", "error");
        log(`Opening stream for Capsule [${id}]...`);
        try {
            const res = await fetch(URL, { method: 'POST', body: JSON.stringify({ action: 'update_content', pin: PIN, id: id, name: name, payload: JSON.parse(raw) }) });
            const j = await res.json();
            if (j.status === "success") {
                log("CAPSULE COMMITTED TO RECORD.", "success");
                document.getElementById('m-id').value = ""; document.getElementById('m-name').value = ""; document.getElementById('json-input').value = "";
                fetchMissions();
            } else log(j.message, "error");
        } catch (e) { log(e.message, "error"); }
    }

    function handleFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                // SCHEMA v1.0 SUPPORT
                const id = (data.metadata && data.metadata.id) ? data.metadata.id : data.missionId || "";
                const name = (data.metadata && data.metadata.title) ? data.metadata.title : (data.meta && data.meta.title) ? data.meta.title : "";

                document.getElementById('m-id').value = id;
                document.getElementById('m-name').value = name;
                document.getElementById('json-input').value = e.target.result;

                log(`Capsule [${file.name}] loaded into staging.`, "success");
                document.getElementById('upload-zone').style.borderColor = "var(--success)";
            } catch (ex) { log("INVALID CAPSULE: Not a valid .blob/JSON file.", "error"); }
        };
        reader.readAsText(file);
    }

    async function fetchProgress() {
        document.getElementById('sync-tick').innerText = "[SYNC_BUSY]";
        try {
            const res = await fetchWithTimeout(URL, { method: 'POST', body: JSON.stringify({ action: 'fetch_progress', pin: PIN }) });
            const j = await res.json();
            if (j.status === "success") {
                allProgress = j.progress;
                updateClassFilter(); renderProgress();
                document.getElementById('sync-tick').innerText = "[SYNC_OK]";
                setTimeout(() => document.getElementById('sync-tick').innerText = "[SYNC_IDLE]", 3000);
            }
        } catch (e) {
            log("Progress sync failed: " + e.message, "error");
            document.getElementById('sync-tick').innerText = "[SYNC_FAIL]";
        }
    }

    function updateClassFilter() {
        const f = document.getElementById('class-filter'); const val = f.value;
        const classes = [...new Set(allProgress.map(p => p.class))].sort();
        let h = `<option value="ALL">ALL CLASSES</option>`;
        classes.forEach(c => { h += `<option value="${c}">${c}</option>`; });
        f.innerHTML = h; if (f.innerHTML.includes(val)) f.value = val;
    }

    function renderProgress() {
        const filter = document.getElementById('class-filter').value;
        const filtered = filter === "ALL" ? allProgress : allProgress.filter(p => p.class === filter);
        let h = "";
        filtered.forEach(p => {
            const missions = Object.keys(p.missionData || {});
            missions.forEach(mid => {
                const st = p.missionData[mid]; if (!st) return;
                const decs = st.dec ? Object.keys(st.dec).length : 0;
                const pre = st.preDone ? "‚úì" : "√ó";
                const feedback = st.aiFeedback ? "‚úì AI FEEDBACK READY" : "";
                h += `<div style="padding:15px; border-bottom:1px solid #eee; font-size:0.75rem; background:${st.aiFeedback ? '#f9fff9' : 'none'}">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <strong>${p.name}</strong> <span style="color:#888;">${p.class}</span>
                            </div>
                            <div style="color:#666;">MISSION: ${mid} | STEP: ${decs} | BRIEF: ${pre}</div>
                            <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                                <button class="btn" style="padding:5px 10px; font-size:0.55rem; width:auto; background:#444;" onclick="runAI('${p.id}', '${mid}')">ANALYZE WITH AI</button>
                                <span style="font-size:0.55rem; color:var(--success); font-weight:bold;">${feedback}</span>
                            </div>
                          </div>`;
            });
        });
        document.getElementById('progress-list').innerHTML = h || "<p style='color:#ccc; padding:20px;'>No student data detected.</p>";
    }

    async function runAI(uid, mid) {
        log(`Initiating AI Analysis for Archive [${uid}]...`);
        // Find student data
        const student = allProgress.find(p => p.id === uid); if (!student) return log("User not found", "error");
        const mData = student.missionData[mid]; if (!mData) return log("Mission data not found", "error");

        try {
            const res = await fetch(URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'generate_ai_feedback',
                    pin: PIN,
                    rationales: mData.rat,
                    context: { title: mid }
                })
            });
            const j = await res.json();
            if (j.status === "success") {
                log("AI Feedback generated successfully.", "success");
                // Save feedback back to student state
                mData.aiFeedback = j.feedback;
                await fetch(URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'save_state',
                        id: uid,
                        missionId: mid,
                        state: mData
                    })
                });
                log("Feedback committed to student record.", "success");
                fetchProgress();
            } else log(j.message, "error");
        } catch (e) { log(e.message, "error"); }
    }

    async function deleteMission(id) {
        if (!confirm(`PERMANENT DELETION: Are you sure you want to scrub mission [${id}] from the record?`)) return;
        log(`DELETING CAPSULE [${id}]...`);
        try {
            const res = await fetch(URL, { method: 'POST', body: JSON.stringify({ action: 'delete_content', pin: PIN, id: id }) });
            const j = await res.json();
            if (j.status === "success") { log("CAPSULE DELETED.", "success"); fetchMissions(); } else log(j.message, "error");
        } catch (e) { log(e.message, "error"); }
    }

    function renderMissions(ms) {
        document.getElementById('lib-log').innerText = `${ms.length} Capsules Detected.`;
        let h = "<table><tr><th>Visual</th><th>Dossier Name</th><th>ID</th><th>Action</th></tr>";
        ms.forEach(m => {
            const thumb = m.thumb || "https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=1000&auto=format&fit=crop";
            h += `<tr>
                        <td><div class="thumb" style="background-image:url('${thumb}')"></div></td>
                        <td><strong>${m.name}</strong></td>
                        <td><code>${m.id}</code></td>
                        <td><button class="btn-del" onclick="deleteMission('${m.id}')">SCRUB RECORD</button></td>
                      </tr>`;
        });
        document.getElementById('library-list').innerHTML = (ms.length > 0) ? h + "</table>" : "<p style='color:#ccc; padding:20px;'>No missions found.</p>";
    }

    // FAILSAFE: Ensure UI renders even if handshake is slow
    window.onload = () => {
        log("BOOT SEQUENCE INITIATED...");
        fetchMissions();
        setInterval(fetchProgress, 30000);
    };

    // PROJECTOR VIEW
    function toggleProjector() {
        const pv = document.getElementById('projector-view');
        pv.classList.toggle('active');
        if (pv.classList.contains('active')) renderProjectorBoard();
    }

    function renderProjectorBoard() {
        const board = document.getElementById('proj-board');
        document.getElementById('proj-sync').innerText = "[LOG_ACTIVE]";
        let h = "";
        const entries = [];
        allProgress.forEach(p => {
            Object.keys(p.missionData || {}).forEach(mid => {
                const st = p.missionData[mid];
                if (st) entries.push({ name: p.name, class: p.class, mission: mid, steps: st.dec ? Object.keys(st.dec).length : 0, brief: st.preDone ? "READY" : "BRIEFING" });
            });
        });
        entries.sort((a, b) => (a.class > b.class) ? 1 : (a.name > b.name) ? 1 : -1);
        entries.forEach(e => {
            const pct = (e.steps / 18) * 100;
            h += `<div class="proj-card ${e.steps > 0 ? 'active' : ''}">
                <div class="proj-name">${e.name}</div>
                <div class="proj-class">${e.class} // ${e.mission}</div>
                <div class="proj-stats">
                    <div><div style="opacity:0.5; font-size:0.65rem; text-transform:uppercase; margin-bottom:5px;">Exhibit</div><div style="font-size:1.1rem; color:#fff;">0${e.steps}</div></div>
                    <div><div style="opacity:0.5; font-size:0.65rem; text-transform:uppercase; margin-bottom:5px;">Briefing</div><div style="font-size:1.1rem; color:${e.brief === 'READY' ? '#0f0' : '#666'};">${e.brief}</div></div>
                </div>
                <div class="proj-bar"><div class="proj-fill" style="width:${pct}%"></div></div>
            </div>`;
        });
        board.innerHTML = h || "<div style='grid-column:1/-1; text-align:center; opacity:0.3; padding:100px; color:#d2b48c;'>WAITING FOR FIELD AGENTS...</div>";
    }
</script>
</body>

</html>