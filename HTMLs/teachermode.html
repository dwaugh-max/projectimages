<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MISSION CONTROL // SITUATION ROOM (0.50)</title>
    <script>
        // --- BOOTSTRAP CONFIGURATION ---
        (function bootstrap() {
            // Supabase Credentials (Empty by default)
            if (!localStorage.getItem('TM_SUPABASE_URL')) localStorage.setItem('TM_SUPABASE_URL', '');
            if (!localStorage.getItem('TM_SUPABASE_KEY')) localStorage.setItem('TM_SUPABASE_KEY', '');
        })();

        const SB_URL = localStorage.getItem('TM_SUPABASE_URL');
        const SB_KEY = localStorage.getItem('TM_SUPABASE_KEY');
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Oswald:wght@700&display=swap"
        rel="stylesheet">
    <script src="critical_crypto.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Quill Rich Text Editor (Legacy Port) -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="supabase_bridge.js"></script>
    <link rel="icon" type="image/png" href="images/logic_gear_logo.png">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --accent: #00ffcc;
            --accent-dim: rgba(0, 255, 204, 0.1);
            --secondary: #0a2a2a;
            --success: #00ff88;
            --err: #ff3366;
            --font-main: 'Inter', sans-serif;
            --font-h: 'Oswald', sans-serif;
            --font-tech: 'JetBrains Mono', monospace;
            --forge-accent: #0088ff;
        }

        /* --- BLOB HOSPITAL SURGICAL STYLES (PORTED v0.50) --- */
        .surgical-theater {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 600px;
            /* Fixed height for editor area */
        }

        .visual-monitor {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #000;
            padding: 20px;
            border: 1px solid #222;
            border-radius: 4px;
            overflow-y: auto;
        }

        .data-input-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        /* TACTICAL TABS */
        .tactical-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .t-tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            background: #111;
            border: 1px solid #333;
            font-family: var(--font-h);
            font-size: 0.7rem;
            letter-spacing: 1px;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.2s;
            color: #888;
        }

        .t-tab:hover {
            background: #1a1a1a;
            opacity: 0.8;
            color: #fff;
        }

        .t-tab.active {
            background: var(--forge-accent);
            color: #000;
            opacity: 1;
            border-color: var(--forge-accent);
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.2);
        }

        /* QUILL OVERRIDES */
        .ql-toolbar.ql-snow {
            border: 1px solid #333 !important;
            background: #111;
        }

        .ql-container.ql-snow {
            border: 1px solid #333 !important;
            background: #080808;
            font-family: var(--font-main) !important;
            font-size: 0.9rem !important;
            color: #ddd !important;
        }

        .ql-editor {
            min-height: 250px;
        }

        /* MEDICAL FORM ELEMENTS */
        .med-label {
            display: block;
            color: #666;
            font-size: 0.6rem;
            margin-bottom: 4px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .med-input {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 8px;
            font-family: var(--font-main);
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        .med-input:focus {
            border-color: var(--forge-accent);
            outline: none;
        }

        /* MEDICAL SCANLINE OVERLAY */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.01), rgba(0, 255, 0, 0.005), rgba(0, 0, 255, 0.01));
            background-size: 100% 4px, 4px 100%;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.4;
        }

        /* NARROW TECH SCROLLBARS */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: var(--font-main);
            padding: 0;
            margin: 0;
            background: radial-gradient(ellipse at top, #0a1a1a 0%, #050505 50%);
            color: #fff;
            min-height: 100vh;
        }

        #status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 40px;
            background: linear-gradient(90deg, rgba(0, 255, 204, 0.08) 0%, rgba(0, 0, 0, 0.9) 50%, rgba(0, 136, 255, 0.08) 100%);
            border-bottom: 1px solid var(--secondary);
            font-size: 0.7rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        /* v73 UDL: Focus Indicators */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 4px;
        }

        .status-light {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            background: #333;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .status-light.online {
            background: var(--success);
            box-shadow: 0 0 20px var(--success), 0 0 40px var(--success);
        }

        .status-light.offline {
            background: var(--err);
            box-shadow: 0 0 20px var(--err), 0 0 40px var(--err);
        }

        .status-light.online {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .status-light.offline {
            background: var(--err);
            box-shadow: 0 0 10px var(--err);
        }

        h1 {
            font-family: var(--font-h);
            text-transform: uppercase;
            letter-spacing: 8px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 1.8rem;
            color: var(--accent);
            text-shadow: 0 0 20px rgba(0, 255, 204, 0.3);
        }

        #console {
            background: #000;
            color: var(--accent);
            padding: 20px;
            height: 180px;
            overflow-y: auto;
            font-size: 0.75rem;
            font-family: var(--font-tech);
            border: 1px solid var(--secondary);
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.02);
            padding: 30px;
            border: 1px solid var(--secondary);
            border-top: 3px solid var(--accent);
            box-shadow: 0 0 30px rgba(0, 255, 204, 0.05);
            backdrop-filter: blur(5px);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
        }

        input,
        textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--secondary);
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-family: inherit;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.2);
        }

        .btn {
            background: none;
            color: var(--accent);
            border: 1px solid var(--accent);
            padding: 15px 25px;
            cursor: pointer;
            font-family: var(--font-h);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            background: var(--accent);
            color: #000;
            box-shadow: 0 0 30px var(--accent);
        }

        .btn-del {
            color: var(--err);
            cursor: pointer;
            font-weight: bold;
            font-size: 0.6rem;
            text-decoration: underline;
            border: none;
            background: none;
            padding: 0;
        }

        .btn-del:hover {
            color: #ff6699;
            text-shadow: 0 0 10px var(--err);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 12px;
            border-bottom: 1px solid var(--secondary);
            text-align: left;
            font-size: 0.75rem;
            vertical-align: middle;
        }

        th {
            background: linear-gradient(90deg, var(--accent), rgba(0, 255, 204, 0.3));
            color: #000;
            text-transform: uppercase;
            font-family: var(--font-h);
            font-size: 0.65rem;
            letter-spacing: 2px;
        }

        .thumb {
            width: 46px;
            height: 46px;
            background-size: cover;
            background-position: center;
            border-radius: 4px;
            border: 1px solid var(--secondary);
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.1);
        }

        label {
            font-size: 0.6rem;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* PROJECTOR MODE */
        #projector-view {
            display: none;
            position: fixed;
            inset: 0;
            background: #050505;
            z-index: 2000;
            padding: 40px;
            overflow-y: auto;
        }

        #projector-view.active {
            display: block;
        }

        .proj-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #d2b48c;
            padding-bottom: 20px;
            margin-bottom: 40px;
        }

        .proj-header h1 {
            margin: 0;
            letter-spacing: 8px;
            font-size: 2rem;
            color: #d2b48c;
            text-transform: uppercase;
        }

        .proj-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .proj-card {
            background: #111;
            border: 1px solid #333;
            padding: 8px;
            transition: 0.3s;
        }

        .proj-card.active {
            border-color: #d2b48c;
            box-shadow: 0 0 20px rgba(210, 180, 140, 0.1);
        }

        .proj-name {
            font-size: 0.85rem;
            font-weight: bold;
            color: #d2b48c;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .guidance-text {
            font-size: 0.55rem;
            color: #666;
            margin-top: -8px;
            margin-bottom: 10px;
            font-style: italic;
            line-height: 1.2;
        }

        #settings-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .settings-card {
            background: #111;
            border: 1px solid #333;
            padding: 30px;
            border-radius: 8px;
            width: 400px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .settings-card label {
            display: block;
            font-size: 0.6rem;
            color: var(--forge-accent);
            letter-spacing: 1px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .settings-input {
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            font-size: 0.7rem;
            margin-bottom: 20px;
            font-family: var(--font-main);
        }

        .settings-toggle {
            font-size: 0.6rem;
            color: var(--forge-accent);
            cursor: pointer;
            text-decoration: underline;
            margin-bottom: 10px;
            display: inline-block;
            font-weight: bold;
            letter-spacing: 1px;
        }

        #gen-settings-content {
            display: none;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid #222;
            border-radius: 4px;
        }

        #gen-settings-content.active {
            display: block;
        }

        .proj-class {
            font-size: 0.55rem;
            color: #d2b48c;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .proj-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            border-top: 1px solid #333;
            padding-top: 6px;
        }

        .proj-bar {
            height: 3px;
            background: #222;
            margin-top: 8px;
        }

        .proj-fill {
            height: 100%;
            background: #d2b48c;
            transition: width 1s ease;
        }

        /* FORGE & HOSPITAL OVERLAY */
        #forge-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: #050505;
            z-index: 4000;
            flex-direction: column;
            color: #eee;
        }

        #forge-overlay.active {
            display: flex;
        }

        .forge-header {
            padding: 20px 40px;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .forge-main {
            flex: 1;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2px;
            background: #222;
            overflow: hidden;
        }

        .forge-panel {
            background: #050505;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .forge-output {
            background: #080808;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        #forge-chat {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .msg {
            max-width: 85%;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .msg-ai {
            background: #111;
            border-left: 3px solid var(--forge-accent);
        }

        .msg-user {
            background: #1a1a1a;
            align-self: flex-end;
            border-right: 3px solid #444;
        }

        .stepper {
            display: flex;
            gap: 15px;
            padding: 15px 40px;
            background: #080808;
            border-bottom: 1px solid #222;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0.3;
        }

        .step.active {
            opacity: 1;
        }

        .step-num {
            width: 18px;
            height: 18px;
            border: 1px solid var(--forge-accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            color: var(--forge-accent);
        }

        /* V70 PIPELINE STEPPER - FUTURISTIC DESIGN */
        #pipeline-stepper {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 40px;
            background: linear-gradient(180deg, #0a1215 0%, #050808 100%);
            border-bottom: 1px solid rgba(0, 255, 204, 0.2);
            overflow-x: auto;
            flex-wrap: nowrap;
            position: relative;
        }

        #pipeline-stepper::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0.5;
        }

        .pipeline-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 25px;
            background: linear-gradient(135deg, #0a1515 0%, #050a0a 100%);
            border: 1px solid rgba(0, 136, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            min-width: 110px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .pipeline-node::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 6px;
            background: linear-gradient(135deg, rgba(0, 136, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }

        .pipeline-node:hover {
            border-color: var(--forge-accent);
            background: linear-gradient(135deg, #0f1a1a 0%, #080c0c 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 136, 255, 0.2);
        }

        .pipeline-node.active {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(0, 255, 204, 0.15) 0%, rgba(0, 50, 40, 0.3) 100%);
            box-shadow: 0 0 25px rgba(0, 255, 204, 0.3), inset 0 0 20px rgba(0, 255, 204, 0.05);
        }

        .pipeline-node.active::after {
            content: "";
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid var(--accent);
        }

        .pipeline-node.locked {
            cursor: default;
            border-color: rgba(255, 200, 50, 0.3);
        }

        .pipeline-node.locked::before {
            background: linear-gradient(135deg, rgba(255, 200, 50, 0.05) 0%, transparent 50%);
        }

        .node-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 5px rgba(0, 255, 204, 0.3));
        }

        .pipeline-node.active .node-icon {
            filter: drop-shadow(0 0 10px rgba(0, 255, 204, 0.6));
        }

        .node-label {
            font-size: 0.65rem;
            letter-spacing: 2px;
            color: #666;
            font-family: var(--font-h);
            text-transform: uppercase;
        }

        .pipeline-node:hover .node-label {
            color: var(--forge-accent);
        }

        .pipeline-node.active .node-label {
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent);
        }

        .node-grip {
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 0.8rem;
            color: #333;
            cursor: grab;
            transition: color 0.2s;
        }

        .pipeline-node:hover .node-grip {
            color: var(--forge-accent);
        }

        .node-grip:active {
            cursor: grabbing;
        }

        .node-lock {
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 0.6rem;
            opacity: 0.6;
        }

        .pipeline-arrow {
            color: rgba(0, 136, 255, 0.4);
            font-size: 1.5rem;
            text-shadow: 0 0 10px rgba(0, 136, 255, 0.3);
        }

        .pipeline-controls {
            display: flex;
            gap: 15px;
            padding: 10px 40px 20px;
            background: linear-gradient(180deg, #050808 0%, #0a0a0a 100%);
            border-bottom: 1px solid #1a1a1a;
        }

        .pipeline-controls button {
            font-size: 0.65rem;
            font-family: var(--font-h);
            padding: 8px 18px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            color: #555;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s;
            border-radius: 3px;
        }

        .pipeline-controls button:hover {
            border-color: var(--forge-accent);
            color: var(--forge-accent);
            box-shadow: 0 0 15px rgba(0, 136, 255, 0.2);
        }

        /* HOSPITAL STYLES */
        #hospital-view {
            display: none;
            height: 100%;
            grid-template-columns: 250px 1fr;
            background: #080808;
        }

        .hosp-sidebar {
            background: #111;
            border-right: 1px solid #222;
            padding: 15px;
            overflow-y: auto;
        }

        .hosp-main {
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .hosp-tab {
            padding: 10px;
            margin-bottom: 5px;
            background: #0a0a0a;
            border: 1px solid #222;
            font-size: 0.65rem;
            cursor: pointer;
            color: #888;
        }

        .hosp-tab.active {
            border-color: #00ffcc;
            color: #00ffcc;
        }

        /* ENHANCED CONTROLS */
        .forge-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .settings-select {
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 8px;
            font-size: 0.65rem;
            width: 100%;
        }

        #f-outcomes label {
            text-transform: none !important;
        }

        /* --- AUTH OVERLAY --- */
        #auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9900;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: opacity 0.5s ease;
        }

        #login-card {
            background: #111;
            border: 1px solid #333;
            padding: 40px;
            text-align: center;
            width: 400px;
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        /* LANDING SCREEN */
        #landing-screen {
            display: none;
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, #0a1a1a 0%, #050505 70%);
            z-index: 4500;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .landing-logo {
            font-family: 'Oswald', sans-serif;
            font-size: 6rem;
            font-weight: 700;
            color: #00ffcc;
            letter-spacing: 20px;
            margin-bottom: 10px;
            text-transform: uppercase;
            text-shadow: 0 0 40px rgba(0, 255, 204, 0.4);
            animation: glitch 5s infinite;
        }

        .landing-subtitle {
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: #00ffcc;
            letter-spacing: 8px;
            text-transform: uppercase;
            margin-bottom: 80px;
            opacity: 0.7;
        }

        @keyframes glitch {
            0% {
                transform: translate(0);
            }

            1% {
                transform: translate(-2px, 2px);
            }

            2% {
                transform: translate(2px, -2px);
            }

            3% {
                transform: translate(0);
            }

            100% {
                transform: translate(0);
            }
        }

        .landing-actions {
            display: flex;
            gap: 40px;
        }

        .landing-btn {
            width: 260px;
            height: 200px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid #0a2a2a;
            border-radius: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .landing-btn:hover {
            background: rgba(0, 255, 204, 0.05);
            border-color: #00ffcc;
            transform: translateY(-10px);
            box-shadow: 0 0 30px rgba(0, 255, 204, 0.2);
        }

        .landing-btn .icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
        }

        .landing-btn .label {
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            color: #00ffcc;
            font-weight: 700;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .landing-btn .desc {
            font-size: 0.6rem;
            color: #666;
            margin-top: 12px;
            text-align: center;
            max-width: 200px;
            line-height: 1.5;
        }

        /* --- BRANDED HEADER --- */
        .branded-header {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 18px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid #0a2a2a;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .branded-header:hover {
            border-color: #00ffcc;
            background: rgba(0, 255, 204, 0.05);
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
        }

        .branded-header img {
            width: 32px;
            height: 32px;
            filter: brightness(0) invert(1);
            opacity: 0.9;
        }

        .branded-header .title {
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
            color: #00ffcc;
            letter-spacing: 3px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* --- ABOUT MODAL --- */
        .about-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .about-modal-overlay.active {
            display: flex;
        }

        .about-modal {
            background: #0a0a0a;
            border: 2px solid #00ffcc;
            border-radius: 8px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 0 40px rgba(0, 255, 204, 0.3);
        }

        .about-modal h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 2rem;
            color: #00ffcc;
            letter-spacing: 5px;
            text-align: center;
            margin-bottom: 10px;
        }

        .about-modal .version {
            text-align: center;
            font-size: 0.8rem;
            color: #666;
            letter-spacing: 2px;
            margin-bottom: 30px;
        }

        .about-modal .section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid #222;
        }

        .about-modal .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .about-modal .section-title {
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
            color: #00ffcc;
            letter-spacing: 2px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .about-modal .section-content {
            font-size: 0.85rem;
            color: #ccc;
            line-height: 1.6;
        }

        .about-modal a {
            color: #00ffcc;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .about-modal a:hover {
            color: #00ff88;
            text-decoration: underline;
        }

        .about-modal .close-btn {
            display: block;
            margin: 30px auto 0;
            padding: 12px 30px;
            background: transparent;
            border: 1px solid #00ffcc;
            color: #00ffcc;
            font-family: 'Oswald', sans-serif;
            font-size: 0.8rem;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .about-modal .close-btn:hover {
            background: #00ffcc;
            color: #000;
        }
    </style>
</head>

<body>
    <!-- AUTHENTICATION OVERLAY -->
    <div id="auth-overlay">
        <div id="login-card" style="width:520px;">
            <h1 class="landing-logo" style="font-size:3rem; letter-spacing:10px; margin-bottom:20px;">SITUATION ROOM
            </h1>
            <div style="width:60px; height:2px; background:#00ffcc; margin:0 auto 25px;"></div>
            <div
                style="font-size:0.7rem; color:#00ffcc; letter-spacing:4px; margin-bottom:40px; text-transform:uppercase;">
                Teacher Authorization Required</div>

            <div id="google-signin-container" style="display:flex; justify-content:center; margin-bottom:25px;"></div>

            <div id="auth-status" style="font-size:0.6rem; color:#666; margin-top:10px; letter-spacing:2px;">PENDING
                IDENTITY VERIFICATION...</div>
        </div>
    </div>

    <!-- LANDING SCREEN -->
    <div id="landing-screen">
        <div class="landing-logo">THE SITUATION ROOM</div>
        <div class="landing-subtitle">teachermode</div>
        <div class="landing-actions">
            <div class="landing-btn" onclick="enterCreate()">
                <div class="icon">‚ú®</div>
                <div class="label">Create Sim</div>
                <div class="desc">Build a new mission from scratch using AI-assisted workflows.</div>
            </div>
            <div class="landing-btn" onclick="enterManage()">
                <div class="icon">üõ†Ô∏è</div>
                <div class="label">Deploy / Manage</div>
                <div class="desc">Upload, monitor progress, and manage your existing simulations.</div>
            </div>
            <div class="landing-btn" onclick="enterHospitalMode()">
                <div class="icon">‚öïÔ∏è</div>
                <div class="label">Hospital Mode</div>
                <div class="desc">Surgical repair. Manually edit .blob files or fine-tune generated missions.</div>
            </div>
        </div>
    </div>

    <div id="projector-view">
        <header class="proj-header">
            <h1>COMMAND PROGRESS BOARD</h1>
            <div style="display:flex; gap:15px; align-items:center;">
                <select id="proj-class-filter" onchange="renderProjectorBoard()"
                    style="padding:8px 12px; font-family:inherit; font-size:0.7rem; background:#222; color:#d2b48c; border:1px solid #444;">
                    <option value="ALL">ALL CLASSES</option>
                </select>
                <select id="proj-mission-filter" onchange="renderProjectorBoard()"
                    style="padding:8px 12px; font-family:inherit; font-size:0.7rem; background:#222; color:#d2b48c; border:1px solid #444;">
                    <option value="ALL">ALL MISSIONS</option>
                </select>
                <span id="proj-sync" style="font-size:0.7rem; color:#888; letter-spacing:2px;">[SYNCING]</span>
                <button onclick="toggleProjector()"
                    style="background:#d2b48c; color:#000; border:none; padding:8px 15px; cursor:pointer; font-weight:bold; letter-spacing:1px; font-size:0.7rem;">EXIT
                    PROJECTOR</button>
            </div>
        </header>
        <div id="proj-board" class="proj-grid"></div>
    </div>

    <div id="status-bar" role="status" aria-live="polite">
        <div style="display:flex; align-items:center; gap:15px;">
            <span
                style="font-family:'Oswald',sans-serif; font-size:1.2rem; color:#00ffcc; letter-spacing:3px; text-shadow:0 0 10px rgba(0,255,204,0.3);">SITUATION
                ROOM</span>
            <span style="color:#444;">|</span>
            <span id="s-light" class="status-light"></span>
            <div id="sb-status"
                style="font-family:'Oswald',sans-serif; font-size:0.65rem; color:#444; letter-spacing:1px; border:1px solid #333; padding:2px 6px; border-radius:3px;">
                SB_OFFLINE</div>
            <div id="cl-status"
                style="font-family:'Oswald',sans-serif; font-size:0.65rem; color:#444; letter-spacing:1px; border:1px solid #333; padding:2px 6px; border-radius:3px;">
                CL_LOCAL</div>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <button onclick="toggleProjector()"
                style="background:none; color:#00ffcc; font-size:0.6rem; border:1px solid #00ffcc; padding:6px 15px; cursor:pointer; font-family:'Oswald',sans-serif; letter-spacing:1px;"
                aria-label="Open Projector View">üì∫
                PROJECTOR</button>
            <button onclick="toggleForge()"
                style="background:var(--forge-accent); color:#fff; font-size:0.6rem; border:none; padding:6px 15px; cursor:pointer; font-family:'Oswald',sans-serif; letter-spacing:1px;"
                aria-label="Open Mission Forge">‚ú®
                CREATE</button>
            <button onclick="toggleSettings()"
                style="background:transparent; border:1px solid #444; color:#666; font-size:0.8rem; padding:5px 8px; cursor:pointer;"
                aria-label="Open Connection Settings">‚öôÔ∏è</button>
            <button onclick="toggleLibrary()"
                style="background:none; color:#00ffcc; font-size:0.6rem; border:1px solid #00ffcc; padding:6px 15px; cursor:pointer; font-family:'Oswald',sans-serif; letter-spacing:1px;"
                aria-label="Open Mission Archive Hub">üìö
                HUB</button>
            <div style="font-size:0.6rem; opacity:0.5; letter-spacing:1px;">0.50</div>
        </div>
    </div>
    <main>
        <div style="display:flex; align-items:center; margin:30px 40px; gap:20px;">
            <img src="images/logic_gear_logo.png" alt="Logic-Gear"
                style="height: 50px; filter: drop-shadow(0 0 10px var(--accent));">
            <h1 style="margin:0; font-size:1.5rem;">COMMAND CENTER // MISSION CONTROL</h1>
        </div>
        <div class="grid" style="grid-template-columns: 1fr 1.5fr 1fr; padding: 0 40px;">
            <div class="panel">
                <h3
                    style="margin-top:0; letter-spacing:2px; font-size:0.8rem; border-bottom:1px solid #ddd; padding-bottom:10px;">
                    CAPSULE INJECTION</h3>
                <div id="upload-zone"
                    style="border:2px dashed #ccc; padding:20px; text-align:center; margin-bottom:20px; cursor:pointer;"
                    onclick="document.getElementById('file-input').click()">
                    <div style="font-size:1.5rem; margin-bottom:5px;">üìÅ</div>
                    <div style="font-size:0.5rem; color:#666; font-weight:bold;">LOAD .BLOB CAPSULE</div>
                    <input type="file" id="file-input" accept=".blob" style="display:none"
                        onchange="handleFile(this.files[0])">
                </div>
                <label>Mission ID</label><input id="m-id" placeholder="e.g. CUBA62">
                <label>Public Name</label><input id="m-name" placeholder="Operation Anadyr">
                <label>Raw Payload</label><textarea id="json-input" style="height: 60px; font-size:0.6rem;"
                    placeholder="..."></textarea>
                <button class="btn" style="padding:10px; font-size:0.75rem;" onclick="upload()">INITIALIZE
                    ARCHIVE</button>
            </div>

            <div class="panel">
                <div
                    style="display:flex; justify-content:space-between; align-items:flex-start; border-bottom:1px solid #ddd; padding-bottom:10px; margin-bottom:20px;">
                    <h3 style="margin:0; letter-spacing:2px; font-size:0.8rem;">STUDENT PROGRESS</h3>
                    <div id="sync-tick" style="font-size:0.55rem; color:#888;">[SYNC_IDLE]</div>
                </div>
                <div style="margin-bottom:15px; display:flex; gap:10px;">
                    <select id="class-filter" style="flex:1; padding:8px; font-family:inherit; font-size:0.75rem;"
                        onchange="renderProgress()">
                        <option value="ALL">ALL CLASSES</option>
                    </select>
                    <button class="btn" style="width:auto; padding:0 15px; font-size:0.6rem;"
                        onclick="fetchProgress()">REFRESH</button>
                </div>
                <div id="progress-list" style="max-height:500px; overflow-y:auto; border:1px solid #eee;"></div>
            </div>

            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="panel" style="flex:1;">
                    <h3
                        style="margin-top:0; letter-spacing:2px; font-size:0.8rem; border-bottom:1px solid #ddd; padding-bottom:10px;">
                        LIVE DIRECTORY</h3>
                    <div id="lib-log" style="font-size: 0.55rem; color: #888; margin-bottom: 10px;">Scanning...</div>
                    <div id="library-list"></div>
                </div>
                <div class="panel" style="padding:20px; background:var(--terminal); border-top:none;">
                    <h3 style="margin-top:0; color:#fff; font-size:0.6rem; letter-spacing:1px; opacity:0.6;">SYSTEM LOG
                    </h3>
                    <div id="console" style="height:150px; overflow-y:auto; font-size:0.65rem; color:var(--term-txt);">
                    </div>
                </div>
            </div>
        </div>

        <div id="library-hub"
            style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:3000; padding:60px; overflow-y:auto;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--accent); padding-bottom:20px; margin-bottom:40px;">
                <h1 style="margin:0; color:var(--accent); letter-spacing:5px; border-bottom:none;">COMMUNITY ARCHIVE HUB
                </h1>
                <div style="display:flex; gap:10px;">
                    <button onclick="fetchMissions()"
                        style="background:none; border:1px solid #00ffcc; color:#00ffcc; padding:10px 20px; cursor:pointer; font-family:inherit;">[
                        REFRESH ARCHIVE ]</button>
                    <button onclick="toggleLibrary()"
                        style="background:transparent; border:1px solid #666; color:#666; padding:10px 20px; cursor:pointer; font-family:inherit;">[CLOSE_HUB]</button>
                </div>
            </div>
            <div id="hub-grid" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                <div style="grid-column:1/-1; text-align:center; padding:100px; opacity:0.5; color:#fff;">LOADING
                    MISSION
                    CATALOG...</div>
            </div>
        </div>

        <div id="forge-overlay">
            <header class="forge-header">
                <div style="display:flex; align-items:center; gap:20px;">
                    <span
                        style="font-family:'Oswald',sans-serif; font-size:1rem; color:#00ffcc; letter-spacing:3px; opacity:0.8;">SITUATION
                        ROOM</span>
                    <span
                        style="color:#00ffcc; background: #c00; padding: 2px 10px; font-size: 0.6rem; font-weight: bold; border-radius: 3px; animation: blink 1s infinite;">v74
                        ACTIVE</span>
                    <span style="color:#333;">|</span>
                    <div
                        style="font-family:'Oswald',sans-serif; font-size:1.2rem; color:var(--forge-accent); letter-spacing:4px;">
                        MISSION CREATE</div>
                    <div style="font-size:0.5rem; opacity:0.5; letter-spacing:2px; margin-top:5px;">0.50</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="saveIdea()"
                        style="background:#234; border:1px solid #0af; color:#0af; padding:8px 15px; cursor:pointer; font-family:inherit; font-size:0.7rem; font-weight:bold;">üíæ
                        SAVE IDEA</button>
                    <button onclick="openIdeaLoader()"
                        style="background:transparent; border:1px solid #f80; color:#f80; padding:8px 15px; cursor:pointer; font-family:inherit; font-size:0.7rem;">üìÇ
                        LOAD IDEA</button>
                    <button onclick="resetForge()"
                        style="background:transparent; border:1px solid var(--forge-accent); color:var(--forge-accent); padding:8px 15px; cursor:pointer; font-family:inherit; font-size:0.7rem; font-weight:bold;">RESTART</button>
                    <button onclick="toggleForge()"
                        style="background:transparent; border:1px solid #444; color:#888; padding:8px 15px; cursor:pointer; font-family:inherit; font-size:0.7rem;">EXIT</button>
                </div>
            </header>

            <!-- V70 MODULAR PIPELINE STEPPER -->
            <div id="pipeline-stepper">
                <!-- Rendered dynamically by renderPipelineStepper() -->
            </div>
            <div class="pipeline-controls">
                <button onclick="resetPipeline()">‚Ü∫ RESET DEFAULT</button>
                <button onclick="document.getElementById('import-file').click()"
                    style="border-color:#00ffcc; color:#00ffcc;">üìÅ IMPORT FROM DISK</button>
                <input type="file" id="import-file" style="display:none" accept=".blob,.json"
                    onchange="handleLocalImport(this)">
                <button onclick="jumpToPhase(forgePipeline.length - 1)"
                    style="margin-left:auto; border-color:var(--accent); color:var(--accent);">SKIP TO BIRTH ‚Üí</button>
            </div>

            <main class="forge-main">
                <div id="forge-panel" class="forge-panel">
                    <div style="margin-bottom:20px;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:10px;">
                            <label
                                style="color:#00ffcc; font-family:'Oswald',sans-serif; font-size:0.9rem; letter-spacing:2px; margin:0;">CURRENT
                                PHASE</label>
                            <div class="settings-toggle" onclick="toggleGenSettings()"
                                style="margin:0; font-size:1rem; opacity:0.7; cursor:pointer;"
                                title="Advanced Configuration">‚öôÔ∏è</div>
                        </div>
                        <h2 id="forge-title"
                            style="margin:0; font-family:'Oswald',sans-serif; font-size:1.8rem; text-transform:uppercase; color:#fff; letter-spacing:3px;">
                            LOADING...
                        </h2>
                        <p id="forge-desc"
                            style="font-size:0.7rem; color:#888; margin-top:5px; font-family:'Inter',sans-serif; line-height:1.4;">
                            Bounce mission ideas off of the AI! Select (or add) your course outcomes to help tell the AI
                            your class context. Then give the AI general direction in the text box below, and press
                            submit.<br><br>Don't feel like you have to take its first choices! Spend some time refining
                            ("a
                            little more this, a little less that...") until you have a solid concept.</p>

                        <div id="gen-settings-content"
                            style="margin-top:10px; border-left:2px solid var(--forge-accent); background:rgba(0,0,0,0.3);">
                            <div class="forge-settings" style="grid-template-columns:1fr; gap:5px;">
                                <div style="display:flex; gap:10px;">
                                    <div style="flex:1;">
                                        <label>Model</label>
                                        <select id="f-model" class="settings-select">
                                            <option value="xiaomi/mimo-v2-flash:free">Xiaomi MiMo V2 (China)</option>
                                            <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (US)
                                            </option>
                                            <option value="mistralai/devstral-2512:free">Mistral 2512 (France)</option>
                                            <option value="nvidia/nemotron-nano-9b-v2:free">Nemotron Nano (US)</option>
                                            <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (US)
                                            </option>
                                        </select>
                                    </div>
                                    <div style="width:120px;">
                                        <label>Complexity</label>
                                        <select id="f-complexity" class="settings-select">
                                            <option value="Low">Low</option>
                                            <option value="Medium" selected>Standard</option>
                                            <option value="High">Elite</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="curriculum-zone"
                        style="background:rgba(255,255,255,0.03); padding:15px; border-radius:4px; border:1px solid #222;">
                        <label
                            style="color:#00ffcc; font-family:'Oswald',sans-serif; font-size:0.9rem; letter-spacing:2px;">CHOOSE/ADD
                            COURSE OUTCOMES</label>
                        <div class="guidance-text"
                            style="color:#888; font-style:italic; font-size:0.7rem; margin-top:3px;">
                            Look for your class & outcomes here. The list is incomplete! Go ahead and add your own for
                            your
                            future reference.</div>
                        <div id="f-favorites-shelf"
                            style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:15px; border-bottom:1px solid #222; padding-bottom:10px; display:none;">
                            <!-- Pinned favorites go here -->
                        </div>

                        <select id="f-country" onchange="updateForgeRegions()"
                            style="background:#000; border:1px solid #333; color:#fff; padding:8px; font-size:0.7rem; width:100%; margin-bottom:10px;">
                            <option value="">-- SELECT COUNTRY --</option>
                        </select>
                        <select id="f-region" onchange="updateForgeCourses()"
                            style="background:#000; border:1px solid #333; color:#fff; padding:8px; font-size:0.7rem; width:100%; margin-bottom:10px; display:none;">
                        </select>
                        <div style="display:flex; gap:10px; margin-bottom:10px; width:100%;">
                            <select id="f-course" onchange="updateForgeOutcomes()"
                                style="background:#000; border:1px solid #333; color:#fff; padding:8px; font-family:'Inter',sans-serif; font-size:0.7rem; flex:1; min-width:0; display:none;">
                            </select>
                            <button id="f-fav-btn" onclick="toggleFavorite()"
                                style="flex:0 0 40px; background:transparent; border:1px solid #333; color:#444; padding:0; display:flex; align-items:center; justify-content:center; border-radius:3px; cursor:pointer; display:none; transition:all 0.2s;">‚≠ê</button>
                        </div>
                        <div id="f-outcomes"
                            style="max-height:400px; overflow-y:auto; font-size:0.65rem; color:#888; border-top:1px solid #222; padding-top:10px; margin-top:10px;">
                            <p style="text-align:center; opacity:0.4;">SELECT COURSE TO LOAD OUTCOMES</p>
                        </div>

                        <div id="custom-add-zone"
                            style="margin-top:15px; border-top:1px solid #333; padding-top:10px; display:none;">
                            <input id="custom-country" placeholder="COUNTRY (e.g. Canada)"
                                style="background:#000; border:1px solid #444; color:#fff; font-size:0.65rem; width:100%; margin-bottom:5px; padding:5px;">
                            <input id="custom-region" placeholder="REGION (e.g. Nova Scotia)"
                                style="background:#000; border:1px solid #444; color:#fff; font-size:0.65rem; width:100%; margin-bottom:5px; padding:5px;">
                            <input id="custom-course-name" placeholder="COURSE NAME"
                                style="background:#000; border:1px solid #444; color:#fff; font-size:0.65rem; width:100%; margin-bottom:5px; padding:5px;">
                            <textarea id="custom-outcomes-raw" placeholder="OUTCOMES (ONE PER LINE)"
                                style="background:#000; border:1px solid #444; color:#fff; font-size:0.65rem; width:100%; height:60px; padding:5px;"></textarea>
                            <button class="btn"
                                style="background:var(--forge-accent); font-size:0.6rem; padding:5px; width:100%; margin-top:5px;"
                                onclick="saveCustomCourse()">SAVE TO LOCAL LAB</button>
                        </div>
                        <div style="text-align:center; margin-top:10px;">
                            <button id="custom-toggle-btn" onclick="toggleCustomAdd()"
                                style="background:transparent; border:none; color:var(--forge-accent); font-size:0.55rem; cursor:pointer; text-decoration:underline;">+
                                ADD CUSTOM COURSE</button>
                        </div>
                    </div>

                    <div style="margin-top:10px;">
                        <label
                            style="color:#00ffcc; font-family:'Oswald',sans-serif; font-size:0.9rem; letter-spacing:2px;">IDEA
                            BOX</label>
                        <div class="guidance-text" style="color:#666; font-style:italic; font-size:0.65rem;">What are we
                            making today? Give the AI something to start with.</div>
                        <textarea id="f-input"
                            style="height:120px; flex:none; background:#111; border:1px solid #333; color:#fff; font-size:0.85rem; padding:15px; width:100%;"
                            placeholder="ENTER COMMAND CONTEXT..."></textarea>
                    </div>

                    <div style="display:flex; gap:10px;">
                        <button class="btn" style="flex:1; background:#333; font-size:0.7rem; padding:12px;"
                            onclick="forgeBack()">BACK</button>
                        <button class="btn" id="f-submit"
                            style="flex:2; background:var(--forge-accent); font-size:0.7rem; padding:12px;"
                            onclick="processForge()">SUBMIT COMMAND</button>
                        <button class="btn" id="f-next-phase"
                            style="flex:1; background:#060; font-size:0.65rem; padding:12px; border:1px solid #0a0;"
                            onclick="advancePhase()">AUTHORIZE NEXT PHASE ‚Üí</button>
                    </div>
                </div>

                <div id="forge-output" class="forge-output">
                    <div id="forge-chat" style="font-size:0.75rem; line-height:1.6; color:#ccc;">
                        <strong>CREATE SYSTEM ONLINE.</strong><br>
                        Welcome to the integrated conceive-birth-finetune machine. Select your curriculum context to
                        begin.
                    </div>
                </div>

                <!-- HOSPITAL INTERFACE -->
                <div id="hospital-view">
                    <div class="hosp-sidebar" id="hosp-nav">
                        <div
                            style="font-size:0.6rem; color:var(--forge-accent); margin-bottom:15px; letter-spacing:1px; font-weight:bold;">
                            SURGICAL NODES</div>
                    </div>
                    <div class="hosp-main">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <div style="display:flex; flex-direction:column;">
                                <div id="hosp-path"
                                    style="font-family:var(--font-tech); font-size:0.7rem; color:#00ffcc;">NODE:
                                    SELECTION_REQUIRED</div>
                                <div style="display:flex; gap:10px; margin-top:5px;">
                                    <label
                                        style="color:#888; font-size:0.6rem; cursor:pointer; display:flex; align-items:center; gap:5px;">
                                        <input type="radio" name="editor-mode" value="visual" checked
                                            onchange="toggleEditorMode('visual')"> VISUAL FORM
                                    </label>
                                    <label
                                        style="color:#888; font-size:0.6rem; cursor:pointer; display:flex; align-items:center; gap:5px;">
                                        <input type="radio" name="editor-mode" value="code"
                                            onchange="toggleEditorMode('code')"> RAW JSON
                                    </label>
                                </div>
                            </div>
                            <button class="btn" onclick="saveHospEdit()"
                                style="width:auto; padding:5px 15px; font-size:0.65rem; background:#00ffcc; color:#000;">STABILIZE
                                NODE</button>
                        </div>

                        <!-- VISUAL EDITOR CONTAINER -->
                        <div id="hosp-visual"
                            style="flex:1; background:#111; border:1px solid #333; overflow-y:auto; padding:20px; display:block;">
                            <div style="color:#666; font-size:0.8rem; text-align:center; padding-top:20px;">Select a
                                node to edit.</div>
                        </div>

                        <!-- CODE EDITOR -->
                        <textarea id="hosp-editor"
                            style="flex:1; background:#050505; color:#eee; border:1px solid #222; font-family:var(--font-main); font-size:0.85rem; line-height:1.5; padding:20px; resize:none; display:none;"></textarea>
                        <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
                            <button class="btn"
                                style="width:auto; background:transparent; border:1px solid #444; color:#888; padding:10px 20px; font-size:0.7rem;"
                                onclick="downloadBirthedBlob()">DOWNLOAD .BLOB SOURCE</button>
                            <button class="btn"
                                style="width:auto; background:#ffcc00; color:#000; padding:12px 30px; font-size:0.8rem;"
                                onclick="finalizeForge()">FINALIZE & PUSH TO COMMAND CENTER</button>
                        </div>
                    </div>
                </div>

                <!-- ASSETS SCREEN (Image Forge Style Grid) -->
                <div id="forge-screen-assets"
                    style="display:none; grid-column:1/-1; background:#050505; padding:30px; overflow-y:auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <div>
                            <h2
                                style="font-family:'Oswald',sans-serif; font-size:1.5rem; color:#00ffcc; margin:0; letter-spacing:3px;">
                                <span style="font-size:0.8rem; opacity:0.7; display:block;">PHASE 4:</span> ASSET FORGE
                            </h2>
                            <p style="font-size:0.7rem; color:#666; margin-top:5px;">Generate or paste image URLs for
                                each slide. 19 assets needed: 1 Hero + 18 Exhibits.</p>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn" style="padding:8px 15px; font-size:0.65rem;"
                                onclick="generateAllAssets()">‚ö° GENERATE ALL</button>
                            <button class="btn" style="padding:8px 15px; font-size:0.65rem; background:#333;"
                                onclick="advancePhase()">NEXT: BIRTH ‚Üí</button>
                        </div>
                    </div>
                    <div id="assets-grid"
                        style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
                        <!-- Populated by renderAssetsScreen() -->
                    </div>
                </div>

                <!-- BIRTH SCREEN (Review + Deploy) -->
                <div id="forge-screen-birth"
                    style="display:none; grid-column:1/-1; background:#050505; padding:30px; overflow-y:auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <div>
                            <h2
                                style="font-family:'Oswald',sans-serif; font-size:1.5rem; color:#00ffcc; margin:0; letter-spacing:3px;">
                                <span style="font-size:0.8rem; opacity:0.7; display:block;">PHASE 5:</span> BIRTH
                                PROTOCOL
                            </h2>
                            <p style="font-size:0.7rem; color:#666; margin-top:5px;">Review the compiled mission. Fix
                                any issues, then deploy or download.</p>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:300px 1fr; gap:20px; height:calc(100vh - 250px);">
                        <div
                            style="background:#111; border:1px solid #333; padding:20px; border-radius:4px; overflow-y:auto;">
                            <h3 style="color:#0af; font-size:0.8rem; margin-top:0; letter-spacing:2px;">VALIDATION</h3>
                            <div id="birth-validation" style="font-size:0.7rem; color:#888;">
                                Loading...
                            </div>
                            <div style="margin-top:20px; display:flex; flex-direction:column; gap:10px;">
                                <button class="btn" style="background:#060; font-size:0.7rem;"
                                    onclick="birthMission()">üß¨ BIRTH TO JSON</button>
                                <button class="btn" style="background:#234; font-size:0.7rem;"
                                    onclick="downloadBirthedBlob()">üíæ DOWNLOAD .BLOB</button>
                                <button class="btn" style="background:#640; font-size:0.7rem;"
                                    onclick="finalizeForge()">üöÄ DEPLOY TO COMMAND CENTER</button>
                            </div>
                        </div>
                        <div
                            style="background:#080808; border:1px solid #222; padding:15px; border-radius:4px; overflow:auto;">
                            <h3 style="color:#0af; font-size:0.8rem; margin-top:0; letter-spacing:2px;">MISSION PREVIEW
                            </h3>
                            <pre id="birth-json-preview"
                                style="font-size:0.65rem; color:#0f0; white-space:pre-wrap; word-break:break-all; font-family:'JetBrains Mono', monospace;">
Loading accumulated data...
                            </pre>
                        </div>
                    </div>
                </div>

                <div id="forge-loader"
                    style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.8); flex-direction:column; align-items:center; justify-content:center; z-index:10;">
                    <div
                        style="width:30px; height:30px; border:2px solid var(--forge-accent); border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite;">
                    </div>
                    <div id="forge-loader-text"
                        style="font-size:0.6rem; color:var(--forge-accent); margin-top:15px; letter-spacing:2px;">
                        PROCESSING...</div>
                </div>
        </div>
    </main>
    </div>
    <script>
        let allProgress = [];
        let googleUser = null;
        let GOOGLE_CLIENT_ID = "503537759984-imeg79p1djl1csnselh3jaqqofmi5gem.apps.googleusercontent.com";

        function handleCredentialResponse(response) {
            try {
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                googleUser = JSON.parse(jsonPayload);
                console.log("Authenticated as:", googleUser.name, "Email:", googleUser.email);

                // --- SECURITY: TEACHER ALLOWLIST ---
                // Add authorised emails here. Anyone else gets Read-Only access.
                const AUTHORIZED_TEACHERS = [
                    "dwaugh@gmail.com",
                    "david.waugh@gmail.com",
                    "mr.waugh@school.edu" // Example
                ];

                const isAuthorized = AUTHORIZED_TEACHERS.includes(googleUser.email) || googleUser.email === "dwaugh@gmail.com"; // Keep hardcoded admin backup

                if (!isAuthorized) {
                    console.warn("SECURITY: Unauthorized Teacher Access Attempt:", googleUser.email);
                    alert("ACCESS RESTRICTED: Your email is not on the authorized teacher list.\n\nYou will have READ-ONLY access to public missions.");
                    // Optional: Disable creation controls here if needed, but RLS is the real gatekeeper.
                    document.getElementById('m-auth-display').innerText = "GUEST / READ-ONLY";
                }

                // FADE OUT OVERLAY AND SHOW LANDING
                const overlay = document.getElementById('auth-overlay');
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    document.getElementById('landing-screen').style.display = 'flex';
                }, 500);

                if (isAuthorized) {
                    log(`IDENTITY VERIFIED: Welcome, ${googleUser.name}`, "success");
                } else {
                    log(`GUEST ACCESS: Welcome, ${googleUser.name} (Read-Only)`, "warning");
                }

                // Re-render missions now that we know admin status
                fetchMissions();
            } catch (e) {
                document.getElementById('auth-status').style.color = "var(--err)";
            }
        }

        function enterCreate() {
            document.getElementById('landing-screen').style.display = 'none';
            toggleForge();
        }

        function toggleAboutModal() {
            const modal = document.getElementById('about-modal');
            modal.classList.toggle('active');
        }

        function enterManage() {
            document.getElementById('landing-screen').style.display = 'none';
        }

        function enterHospitalMode() {
            document.getElementById('landing-screen').style.display = 'none';
            toggleForge();

            // Initialize skeleton if empty to prevent UI errors
            if (!accumulatedData || Object.keys(accumulatedData).length === 0) {
                accumulatedData = {
                    metadata: { title: "UNTITLED OPERATION", id: "NEW_OP" },
                    slides: [],
                    intelligenceGlossary: {}
                };
            }

            openHospital();
        }

        function initGoogleAuth() {
            log("GSI_ENGINE: Establishing Secure Identity Link...");
            try {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleCredentialResponse
                });
                google.accounts.id.renderButton(
                    document.getElementById("google-signin-container"),
                    { theme: "outline", size: "large", width: 250 }
                );
            } catch (e) {
                console.error("GSI Init Error:", e);
                document.getElementById('auth-status').innerText = "GSI_INITIALIZATION_ERROR";
            }
        }

        // --- SYNC MANAGER ---
        // Sync Manager removed as part of Supabase migration.
        const syncManager = {
            async toggle() { alert("Legacy Sync is disabled. Supabase is now active."); }
        };
        const FORGE_PROXY = "https://nextjs-basic-lemon-one.vercel.app/api/chat";
        let forgeHistory = [];
        let accumulatedData = {};
        let curriculumData = {};
        let forgeModel = "xiaomi/mimo-v2-flash:free";

        // === V70 MODULAR PIPELINE ===
        const FORGE_PHASES = {
            brainstorm: {
                id: 'brainstorm',
                label: 'BRAINSTORM',
                icon: 'üí°',
                title: "<span style='font-size:1rem; opacity:0.7; letter-spacing:2px; display:block;'>PHASE 1:</span> BRAINSTORM",
                desc: "Bounce mission ideas off of the AI! Select curricular outcomes to anchor the context. The AI will propose 3 scenario options‚Äîrefine and pick one solid, compelling direction.",
                prompt: "PHASE: CONCEPT ARRIVE. Identify SCO + Ethical Audit. Propose 3 detailed Scenario Concepts. Include 'THEMES TARGETING SELECTED OUTCOMES'. End with: 'Review these concepts. Request changes or authorize next phase.'",
                showCurriculum: true,
                skippable: true
            },
            deepsearch: {
                id: 'deepsearch',
                label: 'DEEP SEARCH',
                icon: 'üîç',
                title: "<span style='font-size:1rem; opacity:0.7; letter-spacing:2px; display:block;'>PHASE 2:</span> INTEL FRAMEWORK",
                desc: "Establish the 10-slide architecture and technical data strategy.",
                prompt: "PHASE: DEEP SEARCH. Expand chosen concept into 10 Slide Titles and Intel data strategy. End with: 'Awaiting review of architecture.'",
                showCurriculum: false,
                skippable: true
            },
            narrative: {
                id: 'narrative',
                label: 'NARRATIVE',
                icon: 'üìù',
                title: "<span style='font-size:1rem; opacity:0.7; letter-spacing:2px; display:block;'>PHASE 3:</span> STORY CONFIRM",
                desc: "Generating full immersive prose and intelligence files (200-400 words per node).",
                prompt: "PHASE: STORY CONFIRM. Draft FULL immersive prose. REQUIRED: 200-400 words MINIMUM per slide section (Combined Slide Text + Intel data). Do not summarize; expand. End with: 'Narrative draft complete. Awaiting asset authorization.'",
                showCurriculum: false,
                skippable: true
            },
            assets: {
                id: 'assets',
                label: 'ASSETS',
                icon: 'üñºÔ∏è',
                title: "<span style='font-size:1rem; opacity:0.7; letter-spacing:2px; display:block;'>PHASE 4:</span> ASSET SECURE",
                desc: "Mapping visual keywords (Unsplash) for all nodes (19 images needed).",
                prompt: "PHASE: ASSET SECURE. Propose Visual Strategy. MANDATORY: You MUST provide a 6-column Markdown table [ID | Item Name | Context/Description | Visual Style | AI Prompt | Source (URL)]. INVENTORY: You MUST list exactly 19 images (1 Hero/Splash + 18 exhibits for the 10 slides). End with: 'Awaiting final birth command.'",
                showCurriculum: false,
                skippable: true
            },
            birth: {
                id: 'birth',
                label: 'BIRTH',
                icon: 'üß¨',
                title: "<span style='font-size:1rem; opacity:0.7; letter-spacing:2px; display:block;'>PHASE 5:</span> BLOB BIRTH",
                desc: "Compiling the final .blob mission package for deployment.",
                prompt: "PHASE: BLOB BIRTH. Compile the fully realized mission into a valid JSON .blob package. CRITICAL: Output the RAW JSON block ONLY. Start with '{' and end with '}'. No conversational text, no markdown fences, no padding. This is a machine-to-machine transfer.",
                showCurriculum: false,
                skippable: true,
                locked: true
            }
        };

        const DEFAULT_PIPELINE = ['brainstorm', 'deepsearch', 'narrative', 'assets', 'birth'];
        let forgePipeline = JSON.parse(localStorage.getItem('TM_FORGE_PIPELINE')) || [...DEFAULT_PIPELINE];
        let currentPhaseIndex = 0;

        // Legacy compatibility shim
        function getCurrentPhase() {
            return FORGE_PHASES[forgePipeline[currentPhaseIndex]];
        }


        // --- DYNAMIC FORGE CONFIG SYSTEM ---
        const FORGE_SYSTEM_CORE_FALLBACK = `
You are the BLOB FACTORY COREGINE (0.50), the multi-stage mission architect.
LANGUAGE PROTOCOL: STRICTLY ENGLISH ONLY. Do not use Chinese characters or any non-English script. Translate all internal logic or model defaults to English immediately.
GOAL: Guide the user from a seed context to a fully realized educational .blob mission.
STYLE: Punchy, active journalism. Short paragraphs (MAX 3-4 sentences).
SCHEMA: metadata, slides(id, type, title, content, mediaURL, intel: { primary, legal, intel }, interactionPrompt, options, outcomes), intelligenceGlossary.

CALIBRATION RULES:
1. BASELINE: Automatically calibrate narrative depth for the Grade Level of the course provided in COURSE CONTEXT.
2. STUDENT OFFSET: Use the 'FORGE COMPLEXITY' variable to adjust for the specific students in that class:
   - "Low": Foundational literacy, direct cause/effect, clear stakes.
   - "Medium": Typical grade-level analysis and vocabulary.
   - "High": Sophisticated nuance, complex ethical dilemmas, advanced reading level.

PEDAGOGICAL DEPTH:
Word count targets (e.g., 200-400 words) are NON-NEGOTIABLE pedagogical requirements for mission immersion. You MUST meet or exceed these targets for every section. "Per section" means the combined prose of the Slide Content and its associated Intelligence Tabs. Failure to meet volume targets is a failure of the architecture.

You MUST maintain strict continuity between phases. Use the provided ARCHIVE HISTORY to anchor your next steps. For example, if Concept C was chosen in Phase 1, Phase 2 MUST expand ONLY that concept. Do not invent new topics or switch contexts.

PHASE TRANSITION PROTOCOL:
You are an architect, not a conductor. DO NOT suggest moving to the next phase. DO NOT say "Shall we proceed?". Present your work for the current phase and wait for the user to explicitly Authorize the next stage via the UI controls. Stay in the current phase until the context variable changes.

TAB STRUCTURE (CRITICAL):
EVERY Exhibit MUST have exactly 3 intelligence tabs with topic-appropriate labels:
- LEGAL CASES: Use "Crown" (or "Prosecution" for US), "Defense", and "Legal" tabs
- HISTORICAL EVENTS: Use contextually appropriate labels (e.g., "Allied", "Axis", "Neutral" OR "North", "South", "International")
- POLICY DEBATES: Use "For", "Against", and "Analysis" tabs
- ETHICAL DILEMMAS: Use "Stakeholder A", "Stakeholder B", and "Context" tabs
The tab labels MUST reflect the specific topic and provide balanced perspectives. Each tab should contain 150-250 words of distinct intelligence.

DECISION-MAKING (MANDATORY):
EVERY Exhibit MUST require the student to make a decision and justify it:
1. interactionPrompt: A clear question that forces a choice (e.g., "Should the court rule in favor of the Crown or the Defense?")
2. options: An array of 2-4 decision choices that map to the perspectives in the tabs (e.g., ["Rule for Crown", "Rule for Defense", "Declare Mistrial"])
3. The student MUST write a 50+ word rationale citing evidence from the tabs BEFORE they can select their decision
4. NO Exhibit should be purely informational - every single one demands analysis and choice

Rules: Standard Sentence Case. No All-Caps sections. Use Markdown.
`;

        let FORGE_SYSTEM_CORE = FORGE_SYSTEM_CORE_FALLBACK; // Will be updated from DB

        // Fetch Forge config from Supabase with caching
        async function loadForgeConfig() {
            const CACHE_KEY = 'TM_FORGE_CONFIG';
            const CACHE_TIMESTAMP_KEY = 'TM_FORGE_CONFIG_TIMESTAMP';
            const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours

            try {
                // Check cache first
                const cachedConfig = localStorage.getItem(CACHE_KEY);
                const cacheTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                const now = Date.now();

                const ageH = cacheTimestamp ? Math.round((now - parseInt(cacheTimestamp)) / 3600000) : 0;
                if (cachedConfig && cacheTimestamp && (now - parseInt(cacheTimestamp)) < CACHE_DURATION) {
                    FORGE_SYSTEM_CORE = cachedConfig;
                    console.log('[FORGE CONFIG] Using cached version (age: ' + ageH + 'h)');
                    return;
                }

                // Fetch from Supabase
                if (!SupabaseBridge || !SupabaseBridge.client) {
                    return;
                }

                const data = await SupabaseBridge.fetchForgeConfig();
                if (!data) return;

                if (data && data.content) {
                    FORGE_SYSTEM_CORE = data.content;
                    localStorage.setItem(CACHE_KEY, data.content);
                    localStorage.setItem(CACHE_TIMESTAMP_KEY, now.toString());
                    console.log(`[FORGE CONFIG] Updated from cloud (v${data.version})`);
                } else {
                    console.warn('[FORGE CONFIG] No active config found, using fallback');
                }
            } catch (err) {
                console.error('[FORGE CONFIG] Error loading config:', err);
                console.log('[FORGE CONFIG] Using fallback version');
            }
        }

        // Force refresh config (for admin panel later)
        function refreshForgeConfig() {
            localStorage.removeItem('TM_FORGE_CONFIG');
            localStorage.removeItem('TM_FORGE_CONFIG_TIMESTAMP');
            return loadForgeConfig();
        }

        // Load config on page load
        loadForgeConfig();

        // --- END FORGE CONFIG ---
        const fetchWithTimeout = async (url, options = {}, timeout = 10000) => {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(url, { ...options, signal: controller.signal });
            clearTimeout(id); return response;
        };

        function log(m, t = "info") {
            const c = document.getElementById('console'); const color = t === "success" ? "lime" : t === "error" ? "red" : "#0f0";
            if (!c) return;
            c.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${m}</div>`;
            c.scrollTop = c.scrollHeight;
        }
        function setStatus(s, t) {
            const light = document.getElementById('s-light');
            const text = document.getElementById('s-text');
            if (light) light.className = "status-light " + s;
            if (text) text.innerText = t;
        }

        // COMMUNITY HUB LOGIC
        const LIB_URL = "https://raw.githubusercontent.com/dwaugh-edsim/projectimages/main/capsule-library/index.json";
        function toggleLibrary() {
            const h = document.getElementById('library-hub');
            const show = h.style.display === 'none';
            h.style.display = show ? 'block' : 'none';
            if (show) fetchLibrary();
        }
        // --- FORGE UI CONTROLS ---
        function toggleForge() {
            const f = document.getElementById('forge-overlay');
            f.classList.toggle('active');
            if (f.classList.contains('active')) {
                if (!curriculumData.countries) fetchCurriculum();
                updateForgeUI(); // V70: Render pipeline on open
            }
        }

        function updateForgeUI() {
            const phase = getCurrentPhase();

            // Hide ALL screens first
            document.getElementById('hospital-view').style.display = 'none';
            document.getElementById('forge-panel').style.display = 'none';
            document.getElementById('forge-output').style.display = 'none';
            document.getElementById('forge-screen-assets').style.display = 'none';
            document.getElementById('forge-screen-birth').style.display = 'none';

            // Show screen based on phase type
            if (phase.id === 'assets') {
                // ASSETS: Show grid screen
                document.getElementById('forge-screen-assets').style.display = 'block';
                renderAssetsScreen();
            } else if (phase.id === 'birth') {
                // BIRTH: Show review screen
                document.getElementById('forge-screen-birth').style.display = 'block';
                renderBirthScreen();
            } else {
                // BRAINSTORM, DEEPSEARCH, NARRATIVE: Show chat layout
                document.getElementById('forge-panel').style.display = 'flex';
                document.getElementById('forge-output').style.display = 'flex';
                document.getElementById('forge-chat').style.display = 'block';
            }

            // Update pipeline stepper visual
            renderPipelineStepper();

            // Update title and description from registry
            document.getElementById('forge-title').innerHTML = phase.title;
            document.getElementById('forge-desc').innerHTML = phase.desc;

            // Update submit button
            const isBirth = phase.id === 'birth';
            document.getElementById('f-submit').innerText = isBirth ? "BIRTH MISSION" : "SUBMIT COMMAND";
            document.getElementById('f-submit').onclick = isBirth ? birthMission : processForge;

            // Show curriculum zone only for phases that need it
            document.getElementById('curriculum-zone').style.display = phase.showCurriculum ? 'block' : 'none';
        }

        function renderPipelineStepper() {
            const container = document.getElementById('pipeline-stepper');
            if (!container) return;

            let html = '';
            forgePipeline.forEach((phaseId, idx) => {
                const p = FORGE_PHASES[phaseId];
                const isActive = idx === currentPhaseIndex;
                const isLocked = p.locked;

                html += `
                <div class="pipeline-node ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}"
                    draggable="${!isLocked}"
                    data-phase="${phaseId}"
                    data-index="${idx}"
                    onclick="jumpToPhase(${idx})">
                    <span class="node-icon">${p.icon}</span>
                    <span class="node-label">${p.label}</span>
                    ${!isLocked ? '<span class="node-grip">‚â°</span>' : '<span class="node-lock">üîí</span>'}
                </div>
                ${idx < forgePipeline.length - 1 ? '<span class="pipeline-arrow">‚Üí</span>' : ''}
            `;
            });
            container.innerHTML = html;

            // Attach drag handlers
            attachPipelineDragHandlers();
        }

        function jumpToPhase(idx) {
            if (idx < 0 || idx >= forgePipeline.length) return;
            if (idx > currentPhaseIndex && !confirm(`Skip ahead to ${FORGE_PHASES[forgePipeline[idx]].label}? Some phases will be bypassed.`)) return;

            currentPhaseIndex = idx;
            updateForgeUI();
            addForgeChat("ai", `Jumped to ${getCurrentPhase().label}. Context preserved.`);
        }

        function toggleGenSettings() {
            const content = document.getElementById('gen-settings-content');
            content.classList.toggle('active');
        }

        // --- IDEA SAVE/LOAD SYSTEM ---
        async function saveIdea() {
            const teacherId = googleUser?.email || 'GUEST';

            // Prompt for idea name
            const defaultName = accumulatedData?.metadata?.title || `Idea_${Date.now()}`;
            const ideaName = window.prompt("Name this idea (for later reference):", defaultName);
            if (!ideaName) return;

            const ideaId = `IDEA_${Date.now()}`;

            // Capture full forge state
            const ideaData = {
                name: ideaName,
                savedAt: new Date().toISOString(),
                forgeHistory: forgeHistory,
                currentPhaseIndex: currentPhaseIndex,
                accumulatedData: accumulatedData,
                curriculum: {
                    country: document.getElementById('f-country')?.value || '',
                    region: document.getElementById('f-region')?.value || '',
                    course: document.getElementById('f-course')?.value || '',
                    selectedOutcomes: Array.from(document.querySelectorAll('#f-outcomes input:checked')).map(c => c.value)
                },
                settings: {
                    model: document.getElementById('f-model')?.value || '',
                    complexity: document.getElementById('f-complexity')?.value || 'Medium'
                }
            };

            try {
                await SupabaseBridge.saveIdea(ideaId, teacherId, ideaData);
                log(`IDEA SAVED: "${ideaName}" [${ideaId}]`, 'success');
                addForgeChat('ai', `üíæ **Idea Saved!** You can close this session and resume later via "LOAD IDEA".`);
            } catch (e) {
                log(`IDEA SAVE FAILED: ${e.message}`, 'error');
                alert(`Failed to save idea: ${e.message}`);
            }
        }

        async function openIdeaLoader() {
            const teacherId = googleUser?.email || 'GUEST';

            try {
                const ideas = await SupabaseBridge.fetchIdeas(teacherId);

                if (!ideas || ideas.length === 0) {
                    alert("No saved ideas found. Start creating and use SAVE IDEA to preserve your progress.");
                    return;
                }

                // Build selection list
                let msg = "SAVED IDEAS:\\n\\n";
                ideas.forEach((idea, i) => {
                    const date = new Date(idea.updated).toLocaleDateString();
                    msg += `${i + 1}. ${idea.name} (${date})\\n`;
                });
                msg += "\\nEnter the number to load, or 0 to cancel:";

                const selection = window.prompt(msg);
                if (!selection || selection === '0') return;

                const idx = parseInt(selection) - 1;
                if (idx < 0 || idx >= ideas.length) {
                    alert("Invalid selection.");
                    return;
                }

                await loadIdea(ideas[idx].id, teacherId);
            } catch (e) {
                log(`IDEA LOAD FAILED: ${e.message}`, 'error');
                alert(`Failed to load ideas: ${e.message}`);
            }
        }

        async function loadIdea(ideaId, teacherId) {
            try {
                const ideaData = await SupabaseBridge.loadIdea(ideaId, teacherId);

                if (!ideaData) {
                    alert("Idea data not found.");
                    return;
                }

                // Restore forge state
                forgeHistory = ideaData.forgeHistory || [];
                currentPhaseIndex = ideaData.currentPhaseIndex || 0;
                accumulatedData = ideaData.accumulatedData || {};

                // Restore curriculum selections (if curriculum is loaded)
                if (ideaData.curriculum) {
                    const c = ideaData.curriculum;
                    if (c.country && document.getElementById('f-country')) {
                        document.getElementById('f-country').value = c.country;
                        updateForgeRegions();
                        setTimeout(() => {
                            if (c.region) {
                                document.getElementById('f-region').value = c.region;
                                updateForgeCourses();
                                setTimeout(() => {
                                    if (c.course) {
                                        document.getElementById('f-course').value = c.course;
                                        updateForgeOutcomes();
                                    }
                                }, 100);
                            }
                        }, 100);
                    }
                }

                // Restore settings
                if (ideaData.settings) {
                    if (ideaData.settings.model) document.getElementById('f-model').value = ideaData.settings.model;
                    if (ideaData.settings.complexity) document.getElementById('f-complexity').value = ideaData.settings.complexity;
                }

                // Rebuild chat from history
                const chat = document.getElementById('forge-chat');
                chat.innerHTML = `<div style="font-family:monospace; font-size:0.6rem; color:#888;"><strong>SESSION RESTORED</strong><br>Loaded idea: ${ideaData.name}</div>`;

                forgeHistory.forEach(msg => {
                    addForgeChat(msg.role === 'assistant' ? 'ai' : 'user', msg.content);
                });

                updateForgeUI();
                log(`IDEA LOADED: "${ideaData.name}" at Phase ${currentPhaseIndex + 1}`, 'success');
                addForgeChat('ai', `‚úì **Session Restored!** You are at Phase ${currentPhaseIndex + 1}: ${getCurrentPhase().label}. Continue where you left off.`);
            } catch (e) {
                log(`IDEA RESTORE FAILED: ${e.message}`, 'error');
                alert(`Failed to restore idea: ${e.message}`);
            }
        }

        function resetForge() {
            if (!confirm("Are you sure you want to RESTART? This will clear all AI progress and history for this mission.")) return;
            currentPhaseIndex = 0;
            forgeHistory = [];
            accumulatedData = {};
            const chat = document.getElementById('forge-chat');
            chat.innerHTML = `
                <div style="font-family:monospace; font-size:0.6rem; color:#888;">
                    <strong>CREATE SYSTEM ONLINE (v70).</strong><br>
                    Welcome to the modular mission architect. Configure your pipeline, then begin.
                </div>
            `;
            document.getElementById('f-input').value = "";
            document.getElementById('hospital-view').style.display = 'none';
            chat.style.display = 'flex';
            updateForgeUI();
            log("FORGE_ENGINE: System Reset Complete.", "warning");
        }

        // --- ASSETS SCREEN FUNCTIONS ---
        function renderAssetsScreen() {
            const grid = document.getElementById('assets-grid');
            if (!grid) return;

            // Build 19 slots: 1 Hero + 18 exhibits (2 per slide for 9 content slides)
            const slides = accumulatedData?.slides || [];
            let html = '';

            // Hero image slot
            html += `
                <div class="asset-slot" style="background:#111; border:1px solid #333; padding:15px; border-radius:4px;">
                    <div style="font-size:0.65rem; color:#0af; margin-bottom:8px; letter-spacing:1px;">üé¨ HERO / SPLASH</div>
                    <input type="text" id="asset-hero-prompt" placeholder="AI prompt for hero image..."
                        style="width:100%; background:#080808; border:1px solid #222; color:#fff; padding:8px; font-size:0.7rem; margin-bottom:8px;"
                        value="${accumulatedData?.metadata?.heroPrompt || ''}">
                    <div id="asset-hero-preview" style="min-height:100px; background:#050505; border:1px solid #222; display:flex; align-items:center; justify-content:center; margin-bottom:8px;">
                        ${accumulatedData?.metadata?.heroImage ? `<img src="${accumulatedData.metadata.heroImage}" style="max-width:100%;">` : '<span style="color:#333; font-size:0.6rem;">NO IMAGE</span>'}
                    </div>
                    <input type="text" id="asset-hero-url" placeholder="Or paste URL..."
                        style="width:100%; background:#080808; border:1px solid #222; color:#0f0; padding:6px; font-size:0.6rem; margin-bottom:8px;"
                        value="${accumulatedData?.metadata?.heroImage || ''}"
                        onchange="updateAssetUrl('hero', this.value)">
                    <div style="display:flex; gap:5px;">
                        <button class="btn secondary" style="flex:1; font-size:0.6rem; padding:6px;" onclick="generateAsset('hero')">‚ö° GENERATE</button>
                        <button class="btn secondary" style="flex:1; font-size:0.6rem; padding:6px; background:#234;" onclick="saveAssetToGit('hero')">R2</button>
                    </div>
                </div>
            `;

            // Slide assets: 18 exhibits (2 per slide for 9 content slides, or 1 per slide for 10 + extras)
            // Using 2 images per slide approach: primary + alternate perspective
            for (let i = 0; i < 9; i++) {
                const slide = slides[i] || { shortTitle: `Slide ${i + 1}` };
                const slideTitle = slide.shortTitle || slide.title || `Slide ${i + 1}`;
                const primaryImg = slide.tabs?.primary?.image || slide.image || '';
                const altImg = slide.tabs?.intel?.image || slide.tabs?.legal?.image || slide.tabs?.secondary?.image || '';

                // Primary image for this slide
                html += `
                    <div class="asset-slot" style="background:#111; border:1px solid #333; padding:15px; border-radius:4px;">
                        <div style="font-size:0.65rem; color:#0af; margin-bottom:8px; letter-spacing:1px;">S${i + 1}A: ${slideTitle.substring(0, 15)}</div>
                        <input type="text" id="asset-${i}-a-prompt" placeholder="Primary image prompt..."
                            style="width:100%; background:#080808; border:1px solid #222; color:#fff; padding:8px; font-size:0.7rem; margin-bottom:8px;"
                            value="${slide.imagePrompt || ''}">
                        <div id="asset-${i}-a-preview" style="min-height:80px; background:#050505; border:1px solid #222; display:flex; align-items:center; justify-content:center; margin-bottom:8px;">
                            ${primaryImg ? `<img src="${primaryImg}" style="max-width:100%;">` : '<span style="color:#333; font-size:0.55rem;">NO IMAGE</span>'}
                        </div>
                        <input type="text" id="asset-${i}-a-url" placeholder="URL..."
                            style="width:100%; background:#080808; border:1px solid #222; color:#0f0; padding:6px; font-size:0.6rem; margin-bottom:8px;"
                            value="${primaryImg}"
                            onchange="updateAssetUrl('${i}-a', this.value)">
                        <div style="display:flex; gap:5px;">
                            <button class="btn secondary" style="flex:1; font-size:0.6rem; padding:6px;" onclick="generateAsset('${i}-a')">‚ö° GEN</button>
                            <button class="btn secondary" style="flex:1; font-size:0.6rem; padding:6px; background:#234;" onclick="saveAssetToGit('${i}-a')">R2</button>
                        </div>
                    </div>
                `;

                // Alternate/Intel image for this slide
                html += `
                    <div class="asset-slot" style="background:#0a0a0a; border:1px solid #222; padding:15px; border-radius:4px;">
                        <div style="font-size:0.65rem; color:#f80; margin-bottom:8px; letter-spacing:1px;">S${i + 1}B: Alt/Intel</div>
                        <input type="text" id="asset-${i}-b-prompt" placeholder="Alternate perspective..."
                            style="width:100%; background:#080808; border:1px solid #222; color:#fff; padding:8px; font-size:0.7rem; margin-bottom:8px;"
                            value="${slide.altImagePrompt || ''}">
                        <div id="asset-${i}-b-preview" style="min-height:80px; background:#050505; border:1px solid #222; display:flex; align-items:center; justify-content:center; margin-bottom:8px;">
                            ${altImg ? `<img src="${altImg}" style="max-width:100%;">` : '<span style="color:#333; font-size:0.55rem;">NO IMAGE</span>'}
                        </div>
                        <input type="text" id="asset-${i}-b-url" placeholder="URL..."
                            style="width:100%; background:#080808; border:1px solid #222; color:#f80; padding:6px; font-size:0.6rem; margin-bottom:8px;"
                            value="${altImg}"
                            onchange="updateAssetUrl('${i}-b', this.value)">
                        <div style="display:flex; gap:5px;">
                            <button class="btn secondary" style="flex:1; font-size:0.6rem; padding:6px;" onclick="generateAsset('${i}-b')">‚ö° GEN</button>
                            <button class="btn secondary" style="flex:1; font-size:0.6rem; padding:6px; background:#234;" onclick="saveAssetToGit('${i}-b')">R2</button>
                        </div>
                    </div>
                `;
            }

            grid.innerHTML = html;
        }

        function updateAssetUrl(slotId, url) {
            if (slotId === 'hero') {
                if (!accumulatedData.metadata) accumulatedData.metadata = {};
                accumulatedData.metadata.heroImage = url;
                document.getElementById('asset-hero-preview').innerHTML = url ? `<img src="${url}" style="max-width:100%;">` : '<span style="color:#333;">NO IMAGE</span>';
            } else if (typeof slotId === 'string' && slotId.includes('-')) {
                // New format: "3-a" or "5-b"
                const [slideIdx, variant] = slotId.split('-');
                const idx = parseInt(slideIdx);

                if (!accumulatedData.slides) accumulatedData.slides = [];
                if (!accumulatedData.slides[idx]) accumulatedData.slides[idx] = {};
                if (!accumulatedData.slides[idx].tabs) accumulatedData.slides[idx].tabs = { primary: {}, intel: {} };

                if (variant === 'a') {
                    // Primary image
                    if (!accumulatedData.slides[idx].tabs.primary) accumulatedData.slides[idx].tabs.primary = {};
                    accumulatedData.slides[idx].tabs.primary.image = url;
                    accumulatedData.slides[idx].image = url;
                } else {
                    // Alternate/Intel image
                    if (!accumulatedData.slides[idx].tabs.intel) accumulatedData.slides[idx].tabs.intel = {};
                    accumulatedData.slides[idx].tabs.intel.image = url;
                }

                document.getElementById(`asset-${slotId}-preview`).innerHTML = url ? `<img src="${url}" style="max-width:100%;">` : '<span style="color:#333;">NO IMAGE</span>';
            } else {
                // Legacy numeric format
                const idx = parseInt(slotId);
                if (!accumulatedData.slides) accumulatedData.slides = [];
                if (!accumulatedData.slides[idx]) accumulatedData.slides[idx] = {};
                if (!accumulatedData.slides[idx].tabs) accumulatedData.slides[idx].tabs = { primary: {} };
                if (!accumulatedData.slides[idx].tabs.primary) accumulatedData.slides[idx].tabs.primary = {};
                accumulatedData.slides[idx].tabs.primary.image = url;
                accumulatedData.slides[idx].image = url;
                document.getElementById(`asset-${slotId}-preview`).innerHTML = url ? `<img src="${url}" style="max-width:100%;">` : '<span style="color:#333;">NO IMAGE</span>';
            }
            log(`Asset URL updated for slot ${slotId}`, 'success');
        }

        async function generateAsset(slotId) {
            const promptEl = document.getElementById(slotId === 'hero' ? 'asset-hero-prompt' : `asset-${slotId}-prompt`);
            const urlEl = document.getElementById(slotId === 'hero' ? 'asset-hero-url' : `asset-${slotId}-url`);
            const previewEl = document.getElementById(slotId === 'hero' ? 'asset-hero-preview' : `asset-${slotId}-preview`);

            const prompt = promptEl?.value;
            if (!prompt) {
                alert('Enter a prompt first!');
                return;
            }

            // Get OpenRouter key
            let orKey = localStorage.getItem('TM_OPENROUTER_KEY');
            if (!orKey) {
                orKey = window.prompt("Enter your OpenRouter API Key (get one at openrouter.ai):");
                if (!orKey) return;
                localStorage.setItem('TM_OPENROUTER_KEY', orKey.trim());
            }

            try {
                previewEl.innerHTML = '<span style="color:#0af; font-size:0.6rem;">‚è≥ GENERATING...</span>';
                log(`Asset GEN [${slotId}]: "${prompt.substring(0, 50)}..."`, 'OUTBOUND');

                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${orKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "black-forest-labs/flux-1.1-pro",
                        "messages": [{ "role": "user", "content": prompt }]
                    })
                });

                const data = await response.json();
                log(`Asset GEN [${slotId}] response: ${JSON.stringify(data).substring(0, 500)}...`, 'INBOUND');

                if (data.error) {
                    if (data.error.message?.includes('401') || data.error.message?.includes('invalid')) {
                        localStorage.removeItem('TM_OPENROUTER_KEY');
                    }
                    throw new Error(data.error.message);
                }

                const message = data.choices[0].message;
                let imageUrl = null;

                // Check for OpenRouter/Flux image object format
                if (message.images && message.images.length > 0) {
                    const img = message.images[0];
                    if (img.image_url) imageUrl = img.image_url.url;
                    else if (typeof img === 'string') imageUrl = img;
                }

                // Fallback: look for URL in content
                if (!imageUrl) {
                    const content = message.content || "";
                    const urlMatch = content.match(/https?:\/\/[^\s\)]+/g);
                    if (urlMatch) imageUrl = urlMatch[0];

                    if (!imageUrl && content.includes('data:image')) {
                        const base64Match = content.match(/data:image\/[a-zA-Z]*;base64,[^\s\n]+/);
                        if (base64Match) imageUrl = base64Match[0];
                    }
                }

                if (!imageUrl) throw new Error("Could not extract image URL from response");

                // Update UI
                previewEl.innerHTML = `<img src="${imageUrl}" style="max-width:100%;">`;
                urlEl.value = imageUrl;
                updateAssetUrl(slotId, imageUrl);
                log(`Asset GEN [${slotId}] SUCCESS`, 'success');

            } catch (e) {
                log(`Asset GEN [${slotId}] FAILED: ${e.message}`, 'error');
                previewEl.innerHTML = `<span style="color:#f44; font-size:0.55rem;">ERROR: ${e.message}</span>`;
            }
        }

        async function generateAllAssets() {
            const orKey = localStorage.getItem('TM_OPENROUTER_KEY');
            if (!orKey) {
                const key = window.prompt("Enter your OpenRouter API Key to batch generate:");
                if (!key) return;
                localStorage.setItem('TM_OPENROUTER_KEY', key.trim());
            }

            if (!confirm("Generate images for ALL slots with prompts? This will use your OpenRouter credits.")) return;

            // Collect all slots with prompts
            const slots = ['hero'];
            for (let i = 0; i < 9; i++) {
                slots.push(`${i}-a`, `${i}-b`);
            }

            let generated = 0;
            for (const slotId of slots) {
                const promptEl = document.getElementById(slotId === 'hero' ? 'asset-hero-prompt' : `asset-${slotId}-prompt`);
                if (promptEl?.value?.trim()) {
                    await generateAsset(slotId);
                    generated++;
                    // Small delay to avoid rate limiting
                    await new Promise(r => setTimeout(r, 500));
                }
            }

            alert(`Generated ${generated} images.`);
        }

        async function saveAssetToGit(slotId) {
            // Now uses Cloudflare R2 via worker (renamed from Git for backwards compat)
            const urlEl = document.getElementById(slotId === 'hero' ? 'asset-hero-url' : `asset-${slotId}-url`);
            const previewEl = document.getElementById(slotId === 'hero' ? 'asset-hero-preview' : `asset-${slotId}-preview`);
            const url = urlEl?.value;

            if (!url) {
                alert('No image URL to save. Generate or paste an image first.');
                return;
            }

            const R2_WORKER_URL = 'https://proud-tooth-42cf.icumusicvideo.workers.dev';
            const missionId = accumulatedData?.metadata?.id || 'unnamed';
            const filename = `${missionId}_${slotId}_${Date.now()}.jpg`;

            try {
                log(`R2 Save [${slotId}]: Converting to JPG...`, 'OUTBOUND');
                previewEl.innerHTML = '<span style="color:#0af; font-size:0.6rem;">‚è≥ UPLOADING TO R2...</span>';

                // Convert to JPG via canvas
                const img = new Image();
                img.crossOrigin = "anonymous";

                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = () => reject(new Error("Failed to load image - may be CORS blocked"));
                    img.src = url;
                });

                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);

                const jpgDataUrl = canvas.toDataURL('image/jpeg', 0.85);

                log(`R2 Save [${slotId}]: Uploading ${filename}...`, 'OUTBOUND');

                const res = await fetch(`${R2_WORKER_URL}?filename=${encodeURIComponent(filename)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image: jpgDataUrl })
                });

                const data = await res.json();

                if (!data.success) {
                    throw new Error(data.error || 'Upload failed');
                }

                // Update URL field with R2 public URL
                urlEl.value = data.url;
                updateAssetUrl(slotId, data.url);
                previewEl.innerHTML = `<img src="${data.url}" style="max-width:100%;">`;

                log(`R2 Save [${slotId}]: SUCCESS - ${data.url}`, 'success');
                alert(`Saved to R2 as JPG!\n${data.filename}`);

            } catch (e) {
                log(`R2 Save [${slotId}] FAILED: ${e.message}`, 'error');
                previewEl.innerHTML = `<span style="color:#f44; font-size:0.55rem;">ERROR: ${e.message}</span>`;
                alert(`R2 save failed: ${e.message}`);
            }
        }

        // --- BIRTH SCREEN FUNCTIONS ---
        function renderBirthScreen() {
            const validationEl = document.getElementById('birth-validation');
            const previewEl = document.getElementById('birth-json-preview');

            // Validate accumulated data
            let validationHtml = '';
            const slides = accumulatedData?.slides || [];
            const metadata = accumulatedData?.metadata || {};

            // Check metadata
            const hasTitle = !!metadata.title;
            const hasId = !!metadata.id;
            validationHtml += `<div style="color:${hasTitle ? '#0f0' : '#f44'};">${hasTitle ? '‚úì' : '‚úó'} Mission Title</div>`;
            validationHtml += `<div style="color:${hasId ? '#0f0' : '#f44'};">${hasId ? '‚úì' : '‚úó'} Mission ID</div>`;

            // Check slides
            validationHtml += `<div style="color:${slides.length >= 10 ? '#0f0' : '#f80'};">${slides.length >= 10 ? '‚úì' : '‚ö†'} Slides: ${slides.length}/10</div>`;

            // Check images
            let imageCount = 0;
            slides.forEach(s => {
                if (s.image || s.tabs?.primary?.image) imageCount++;
            });
            validationHtml += `<div style="color:${imageCount >= 8 ? '#0f0' : '#f80'};">${imageCount >= 8 ? '‚úì' : '‚ö†'} Slide Images: ${imageCount}/10</div>`;

            // Check glossary
            const hasGlossary = Array.isArray(accumulatedData?.intelligenceGlossary) && accumulatedData.intelligenceGlossary.length > 0;
            validationHtml += `<div style="color:${hasGlossary ? '#0f0' : '#888'};">${hasGlossary ? '‚úì' : '‚óã'} Intelligence Glossary</div>`;

            validationEl.innerHTML = validationHtml;

            // Show JSON preview
            try {
                previewEl.textContent = JSON.stringify(accumulatedData, null, 2);
            } catch (e) {
                previewEl.textContent = 'Error rendering JSON: ' + e.message;
            }
        }

        function resetPipeline() {
            if (!confirm("Reset pipeline to default order?")) return;
            forgePipeline = [...DEFAULT_PIPELINE];
            localStorage.removeItem('TM_FORGE_PIPELINE');
            renderPipelineStepper();
            log("Pipeline reset to default.", "success");
        }

        function savePipeline() {
            localStorage.setItem('TM_FORGE_PIPELINE', JSON.stringify(forgePipeline));
        }

        // V70 Drag-and-Drop Pipeline Reordering
        function attachPipelineDragHandlers() {
            const nodes = document.querySelectorAll('.pipeline-node[draggable="true"]');
            let draggedIdx = null;

            nodes.forEach(node => {
                node.addEventListener('dragstart', (e) => {
                    draggedIdx = parseInt(node.dataset.index);
                    e.dataTransfer.effectAllowed = 'move';
                    node.style.opacity = '0.4';
                });

                node.addEventListener('dragend', () => {
                    node.style.opacity = '1';
                    draggedIdx = null;
                });

                node.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                node.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const targetIdx = parseInt(node.dataset.index);
                    const targetPhase = FORGE_PHASES[forgePipeline[targetIdx]];

                    // Don't allow dropping onto locked phase
                    if (targetPhase.locked || draggedIdx === null || draggedIdx === targetIdx) return;

                    // Reorder pipeline
                    const [removed] = forgePipeline.splice(draggedIdx, 1);

                    // Ensure 'birth' stays at end
                    const birthIdx = forgePipeline.indexOf('birth');
                    const insertIdx = targetIdx > birthIdx ? birthIdx : targetIdx;

                    forgePipeline.splice(insertIdx, 0, removed);

                    // Ensure birth is always last
                    const newBirthIdx = forgePipeline.indexOf('birth');
                    if (newBirthIdx !== forgePipeline.length - 1) {
                        forgePipeline.splice(newBirthIdx, 1);
                        forgePipeline.push('birth');
                    }

                    savePipeline();
                    renderPipelineStepper();
                    log(`Pipeline reordered.New order: ${forgePipeline.join(' ‚Üí ')} `, 'success');
                });
            });
        }

        function forgeBack() {
            if (currentPhaseIndex > 0) {
                currentPhaseIndex--;
                updateForgeUI();
                addForgeChat("ai", `Reverting to ${getCurrentPhase().label}. Command parameters preserved.`);
            }
        }

        function advancePhase() {
            if (currentPhaseIndex >= forgePipeline.length - 1) {
                addForgeChat("ai", "You are already at the final phase. Use BIRTH MISSION to complete.");
                return;
            }
            const nextPhase = FORGE_PHASES[forgePipeline[currentPhaseIndex + 1]];
            if (confirm(`Ready to advance to "${nextPhase.label}"?\n\nMake sure you're satisfied with the current phase before proceeding.`)) {
                currentPhaseIndex++;
                updateForgeUI();
                addForgeChat("ai", `‚úì Advanced to **${nextPhase.label}**. ${nextPhase.desc}`);

                // Clear input and provide helpful hint
                document.getElementById('f-input').value = "";
                document.getElementById('f-input').placeholder = `Type a command for ${nextPhase.label}...`;
                log(`Authorized transition to ${nextPhase.label}`, "success");
            }
        }

        function addForgeChat(side, msg) {
            const c = document.getElementById('forge-chat');
            const div = document.createElement('div');
            div.className = `msg msg-${side}`;
            div.innerHTML = typeof marked !== 'undefined' ? marked.parse(msg) : msg;
            c.appendChild(div);
            c.scrollTop = c.scrollHeight;
        }

        function setForgeLoading(show, txt = "PROCESSING...") {
            const l = document.getElementById('forge-loader');
            l.style.display = show ? 'flex' : 'none';
            document.getElementById('forge-loader-text').innerText = txt;
        }

        function toggleSettings() {
            const overlay = document.getElementById('settings-overlay');
            const isVisible = overlay.style.display === 'flex';
            overlay.style.display = isVisible ? 'none' : 'flex';

            if (!isVisible) {
                // Supabase
                document.getElementById('set-sb-url').value = localStorage.getItem('TM_SUPABASE_URL') || "";
                document.getElementById('set-sb-key').value = localStorage.getItem('TM_SUPABASE_KEY') || "";
            }
        }

        function saveSettings() {
            const sbUrl = document.getElementById('set-sb-url').value.trim();
            const sbKey = document.getElementById('set-sb-key').value.trim();

            localStorage.setItem('TM_SUPABASE_URL', sbUrl);
            localStorage.setItem('TM_SUPABASE_KEY', sbKey);

            alert("Settings Saved. Refreshing to apply changes.");
            location.reload();
        }

        // --- END UI CONTROLS ---

        async function fetchLibrary() {
            try {
                // Use static GitHub library by default
                const res = await fetch(LIB_URL);
                if (!res.ok) throw new Error("No capsules found.");
                const j = await res.json();
                renderLibrary(j.capsules, false);
            } catch (e) { document.getElementById('hub-grid').innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#888; padding:100px;"> COMMUNITY_CATALOG_OFFLINE <br><br><span style="font-size:0.5rem; opacity:0.5;">Manual Import Recommended for now.</span></div>`; }
        }
        function renderLibrary(caps, fromBackend) {
            const isUserAdmin = googleUser && ["dwaugh@gmail.com"].includes(googleUser.email);
            let h = "";
            caps.forEach(c => {
                const removeBtn = (isUserAdmin && fromBackend) ? `<button onclick="removeFromHub('${c.id}')" style="font-size:0.5rem; padding:4px 8px; background:#c00; color:#fff; border:none; cursor:pointer; margin-top:5px; width:100%;"> REMOVE FROM HUB</button>` : "";
                const importBtn = c.downloadUrl ? `<button class="btn" onclick="importMission('${c.downloadUrl}', '${c.id}', '${c.title}')" style="background:transparent; border:1px solid var(--accent); color:var(--accent); padding:8px; font-size:0.6rem; width:100%; margin-top:10px;"> IMPORT TO ARCHIVE</button>` : "";

                h += `<div class="panel" style="border-top-color:#666;">
                    <div style="height:150px; background-image:url('${c.thumb}'); background-size:cover; background-position:center; margin-bottom:15px; border-radius:4px; border:1px solid #333;"></div>
                    <h4 style="margin:0; letter-spacing:1px; font-size:0.85rem;">${c.title}</h4>
                    <div style="font-size:0.6rem; color:#888; margin-bottom:15px; text-transform:uppercase;">AUTHOR: ${c.author}</div>
                    <p style="font-size:0.7rem; height:45px; overflow:hidden; opacity:0.7; line-height:1.4;">${c.description || 'An interactive educational simulation.'}</p>
                    ${importBtn}
                    ${removeBtn}
                </div> `;
            });
            document.getElementById('hub-grid').innerHTML = h || "<div style='grid-column:1/-1; text-align:center; opacity:0.5; padding:100px; color:#fff;'>NO MISSIONS IN CATALOG.</div>";
        }
        async function publishToHub(id, title, thumb, description) {
            alert("Community Hub publishing is disabled.");
        }
        async function removeFromHub(id) {
            alert("Community Hub management is disabled.");
        }
        async function importMission(url, id, name) {
            log(`Syncing Remote Capsule[${id}]...`);
            try {
                const res = await fetch(url);
                const payload = await res.json();
                const teacherId = (typeof googleUser !== 'undefined') ? googleUser.email : 'GUEST';

                if (SupabaseBridge.client) {
                    await SupabaseBridge.saveMission(id, name, payload, teacherId);
                    log(`Remote Capsule[${id}] committed to cloud record.`, "success");
                    fetchMissions();
                    alert(`Mission[${name}] successfully imported!`);
                } else {
                    log("Supabase not configured. Cannot import.", "error");
                }
            } catch (e) { log(`Import failed: ${e.message} `, "error"); }
        }

        // --- FORGE AI ENGINE ---
        async function processForge() {
            let input = document.getElementById('f-input').value;

            // v73.SB Auto-Advance Logic: If user input strongly suggests phase change, trigger it.
            const nextWords = ['next phase', 'proceed', 'advance phase', 'go to phase', 'authorize next'];
            if (input && nextWords.some(w => input.toLowerCase().includes(w))) {
                if (currentPhaseIndex < forgePipeline.length - 1) {
                    const nextPhase = FORGE_PHASES[forgePipeline[currentPhaseIndex + 1]];
                    if (confirm(`You mentioned wanting to progress. Authorize transition to ${nextPhase.label}?`)) {
                        currentPhaseIndex++;
                        updateForgeUI();
                        log(`Phase advanced via chat command to ${nextPhase.label}`, "success");
                        input = "(Proceeding to authorized phase: " + nextPhase.label + ")";
                    }
                }
            }

            // Allow empty input if outcomes are selected or if the user wants to try "Auto-Pilot" Phase 1
            if (!input && currentPhaseIndex === 0) {
                const checks = document.querySelectorAll('#f-outcomes input[type="checkbox"]:checked');
                if (checks.length === 0 && !confirm("No command context or outcomes selected. Proceed with pure course-based generation?")) {
                    return;
                }
            }

            const selectedModel = document.getElementById('f-model').value;
            const selectedComplexity = document.getElementById('f-complexity').value;
            const phase = getCurrentPhase();

            setForgeLoading(true, `THINKING(${phase.label})...`);
            addForgeChat("user", input || "(Proceed to next phase)");
            document.getElementById('f-input').value = "";

            let context = `${FORGE_SYSTEM_CORE} \n`;
            context += `STUDENT OFFSET(FORGE COMPLEXITY): ${selectedComplexity} \n`;

            // Add Course/Curriculum Context (Persistent)
            const country = document.getElementById('f-country').value;
            const region = document.getElementById('f-region').value;
            const course = document.getElementById('f-course').value;
            const checks = document.querySelectorAll('#f-outcomes input[type="checkbox"]:checked');
            const selectedOutcomes = Array.from(checks).map(c => c.value);

            context += `COURSE CONTEXT: ${course} (${region}, ${country}) \n`;
            context += `TARGET CURRICULUM OUTCOMES: ${selectedOutcomes.length > 0 ? selectedOutcomes.join(" | ") : "Drive purely from system knowledge."} \n\n`;

            // Add History for continuity
            if (forgeHistory.length > 0) {
                context += `-- - ARCHIVE HISTORY(DO NOT DEVIATE)-- -\n`;
                forgeHistory.forEach(msg => {
                    context += `[${msg.role.toUpperCase()}]: ${msg.content} \n\n`;
                });
                context += `-- - END HISTORY-- -\n\n`;
            }

            context += `CURRENT PHASE: ${phase.label} \nINSTRUCTION: ${phase.prompt} \n\nUSER INPUT: ${input || "(Proceed based on previous phase)"} `;

            try {
                const res = await fetch(FORGE_PROXY, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: context, model: selectedModel })
                });
                const data = await res.json();
                const reply = data.choices[0].message.content;

                addForgeChat("ai", reply);

                // Store cleaned history
                forgeHistory.push({ role: "user", content: input || "(Next Phase Request)" });
                forgeHistory.push({ role: "assistant", content: reply });

                // IMPORTANT: NO AUTO-ADVANCE! User must explicitly confirm phase transitions.
                // The iterative collaboration is the core value of this tool.
                // Phase advancement is handled by explicit user action (clicking phase or NEXT button).
            } catch (e) {
                addForgeChat("ai", `!! ERROR: ${e.message}. Check Vercel Proxy connectivity.`);
            } finally {
                setForgeLoading(false);
            }
        }

        function getForgeContext(userInput) {
            // [DEPRECATED - MERGED INTO processForge for better parameter sync]
        }

        // --- CURRICULUM HUB ---
        function getCustomOutcomes() {
            const stored = localStorage.getItem('blob_custom_curriculum');
            return stored ? JSON.parse(stored) : {};
        }

        async function saveCustomCourse() {
            const country = document.getElementById('custom-country').value.trim() || "CUSTOM_LAB";
            const region = document.getElementById('custom-region').value.trim() || "LOCAL";
            const name = document.getElementById('custom-course-name').value.trim();
            const raw = document.getElementById('custom-outcomes-raw').value;

            if (!name || !raw) return alert("MISSING PARAMETERS: Course Name and Outcomes are required.");

            const outcomes = raw.split("\n").map(o => o.trim()).filter(o => o.length > 0);

            // Save to localStorage (local backup)
            const custom = getCustomOutcomes();
            if (!custom[country]) custom[country] = {};
            if (!custom[country][region]) custom[country][region] = {};
            custom[country][region][name] = outcomes;
            localStorage.setItem('blob_custom_curriculum', JSON.stringify(custom));

            // Push to Supabase (cloud sync)
            if (SupabaseBridge.client) {
                try {
                    for (const outcome of outcomes) {
                        await SupabaseBridge.saveCustomOutcome(country, region, name, outcome);
                    }
                    log(`Custom Course [${name}] synced to Supabase Cloud.`, "success");
                } catch (e) {
                    log(`Supabase Sync Warning: ${e.message}`, "error");
                }
            }

            // Clear inputs
            document.getElementById('custom-course-name').value = "";
            document.getElementById('custom-outcomes-raw').value = "";
            document.getElementById('custom-country').value = "";
            document.getElementById('custom-region').value = "";

            toggleCustomAdd();
            fetchCurriculum(); // Reload and merge
            log(`Custom Course[${name}] added to Local Lab under ${country}/${region}.`, "success");
        }

        function toggleCustomAdd() {
            const zone = document.getElementById('custom-add-zone');
            const btn = document.getElementById('custom-toggle-btn');
            const show = zone.style.display === 'none';
            zone.style.display = show ? 'block' : 'none';
            btn.innerText = show ? "CANCEL" : "+ ADD CUSTOM COURSE";
        }

        async function fetchCurriculum() {
            try {
                // 1. Load static curriculum.json (fast, cached)
                const res = await fetch("curriculum.json?v=74.01");
                curriculumData = await res.json();

                // 2. Fetch from Supabase (extended library)
                if (SupabaseBridge.client) {
                    try {
                        log("Fetching extended curriculum from Supabase...");
                        const outcomes = await SupabaseBridge.fetchAllOutcomes();

                        // Convert flat array to nested structure
                        outcomes.forEach(o => {
                            if (!curriculumData[o.country]) curriculumData[o.country] = {};
                            if (!curriculumData[o.country][o.region]) curriculumData[o.country][o.region] = {};
                            if (!curriculumData[o.country][o.region][o.course]) curriculumData[o.country][o.region][o.course] = [];
                            curriculumData[o.country][o.region][o.course].push(o.description);
                        });

                        log(`Supabase: Loaded ${outcomes.length} extended outcomes.`, "success");
                    } catch (e) {
                        log(`Supabase curriculum fetch failed: ${e.message}`, "error");
                    }
                }

                // 3. Merge Custom Lab (Deep Merge)
                const custom = getCustomOutcomes();
                Object.keys(custom).forEach(c => {
                    // Check if it's a legacy flat course (array) or new hierarchy (object)
                    if (Array.isArray(custom[c])) {
                        // Legacy: Add to CUSTOM_LAB > LOCAL
                        if (!curriculumData["CUSTOM_LAB"]) curriculumData["CUSTOM_LAB"] = { "LOCAL": {} };
                        curriculumData["CUSTOM_LAB"]["LOCAL"][c] = custom[c];
                    } else {
                        // New Hierarchy: Merge Country
                        if (!curriculumData[c]) curriculumData[c] = {};
                        Object.keys(custom[c]).forEach(r => {
                            // Merge Region
                            if (!curriculumData[c][r]) curriculumData[c][r] = {};
                            // Merge Courses
                            Object.assign(curriculumData[c][r], custom[c][r]);
                        });
                    }
                });

                const cSel = document.getElementById('f-country');
                cSel.innerHTML = '<option value="">-- SELECT COUNTRY --</option>';
                Object.keys(curriculumData).forEach(c => {
                    cSel.innerHTML += `<option value="${c}">${c}</option>`;
                });
                log("Curriculum Hub synchronized.", "success");

                // --- STICKY RESTORATION (v66.40 FIX) ---
                window.isRestoringCurriculum = true;
                const savedCountry = localStorage.getItem('TM_FORGE_COUNTRY');
                if (savedCountry && curriculumData[savedCountry]) {
                    cSel.value = savedCountry;
                    updateForgeRegions();

                    const savedRegion = localStorage.getItem('TM_FORGE_REGION');
                    const rSel = document.getElementById('f-region');
                    if (savedRegion && curriculumData[savedCountry][savedRegion]) {
                        rSel.value = savedRegion;
                        updateForgeCourses();

                        const savedCourse = localStorage.getItem('TM_FORGE_COURSE');
                        const crsSel = document.getElementById('f-course');
                        if (savedCourse && curriculumData[savedCountry][savedRegion][savedCourse]) {
                            crsSel.value = savedCourse;
                            updateForgeOutcomes();
                        }
                    }
                }
                window.isRestoringCurriculum = false;
                renderFavorites();
            } catch (e) {
                console.error("Failed to load curriculum", e);
                log("CURRICULUM_LOAD_FAILURE: Check network or file integrity.", "error");
            }
        }

        function updateForgeRegions() {
            const country = document.getElementById('f-country').value;
            if (!window.isRestoringCurriculum) {
                localStorage.setItem('TM_FORGE_COUNTRY', country);
                localStorage.removeItem('TM_FORGE_REGION');
                localStorage.removeItem('TM_FORGE_COURSE');
            }

            const rSel = document.getElementById('f-region');
            rSel.innerHTML = '<option value="">-- SELECT REGION --</option>';
            rSel.style.display = country ? 'block' : 'none';
            if (country && curriculumData[country]) {
                Object.keys(curriculumData[country]).forEach(r => {
                    rSel.innerHTML += `<option value="${r}">${r}</option>`;
                });
            }
            // Clear children
            if (!window.isRestoringCurriculum) {
                document.getElementById('f-course').style.display = 'none';
                document.getElementById('f-fav-btn').style.display = 'none';
                document.getElementById('f-outcomes').innerHTML = "<p style='text-align:center; opacity:0.4;'>SELECT COURSE TO LOAD OUTCOMES</p>";
            }
        }

        function updateForgeCourses() {
            const country = document.getElementById('f-country').value;
            const region = document.getElementById('f-region').value;
            if (!window.isRestoringCurriculum) {
                localStorage.setItem('TM_FORGE_REGION', region);
                localStorage.removeItem('TM_FORGE_COURSE');
            }

            const cSel = document.getElementById('f-course');
            cSel.innerHTML = '<option value="">-- SELECT COURSE --</option>';
            cSel.style.display = region ? 'block' : 'none';
            document.getElementById('f-fav-btn').style.display = 'none';

            if (region && curriculumData[country] && curriculumData[country][region]) {
                const courses = curriculumData[country][region];
                Object.keys(courses).forEach(c => {
                    cSel.innerHTML += `<option value="${c}">${c}</option>`;
                });
            }
            // Clear child
            if (!window.isRestoringCurriculum) {
                document.getElementById('f-outcomes').innerHTML = "<p style='text-align:center; opacity:0.4;'>SELECT COURSE TO LOAD OUTCOMES</p>";
            }
        }

        function updateForgeOutcomes() {
            const country = document.getElementById('f-country').value;
            const region = document.getElementById('f-region').value;
            const course = document.getElementById('f-course').value;
            if (!window.isRestoringCurriculum) {
                localStorage.setItem('TM_FORGE_COURSE', course);
            }

            const outDiv = document.getElementById('f-outcomes');
            const favBtn = document.getElementById('f-fav-btn');

            if (course && curriculumData[country] && curriculumData[country][region] && curriculumData[country][region][course]) {
                favBtn.style.display = 'block';
                updateFavBtnStyle();

                const data = curriculumData[country][region][course];
                const list = Array.isArray(data) ? data : (data.outcomes || []);

                let h = `<div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:flex-end; border-bottom:1px solid #222; padding-bottom:10px;">
                            <label style="color:#00ffcc; font-family:'Oswald',sans-serif; font-size:0.9rem; letter-spacing:2px; margin:0;">TARGET OUTCOMES</label>
                            <button onclick="toggleAllOutcomes(true)" onmouseover="this.style.color='#00ffcc'" onmouseout="this.style.color='#666'" style="background:none; border:none; color:#666; font-size:0.6rem; cursor:pointer; text-decoration:none; font-family:'Inter',sans-serif; letter-spacing:1px; transition:color 0.2s;">[SELECT ALL]</button>
                         </div>`;

                list.forEach((o, i) => {
                    h += `<label style="display:flex; gap:15px; padding:12px; border-bottom:1px solid #222; cursor:pointer; align-items:flex-start; transition:background 0.2s;">
                            <input type="checkbox" value="${o}" class="outcome-check" style="margin-top:2px; width:auto; accent-color:var(--forge-accent);">
                            <span style="font-size:0.65rem; color:#bbb; line-height:1.4; font-weight:normal;">${o}</span>
                          </label>`;
                });
                outDiv.innerHTML = h;
            } else {
                favBtn.style.display = 'none';
                outDiv.innerHTML = "<p style='text-align:center; opacity:0.4;'>SELECT COURSE TO LOAD OUTCOMES</p>";
            }
        }

        // --- FAVORITES SYSTEM ---
        function getFavorites() {
            const f = localStorage.getItem('TM_CURRICULUM_FAVORITES');
            return f ? JSON.parse(f) : [];
        }

        function toggleFavorite() {
            const country = document.getElementById('f-country').value;
            const region = document.getElementById('f-region').value;
            const course = document.getElementById('f-course').value;
            if (!country || !region || !course) return;

            let favs = getFavorites();
            const id = `${country}|${region}|${course}`;
            const idx = favs.findIndex(f => f.id === id);

            if (idx > -1) {
                favs.splice(idx, 1);
            } else {
                favs.push({ id, country, region, course });
            }

            localStorage.setItem('TM_CURRICULUM_FAVORITES', JSON.stringify(favs));
            updateFavBtnStyle();
            renderFavorites();
        }

        function updateFavBtnStyle() {
            const country = document.getElementById('f-country').value;
            const region = document.getElementById('f-region').value;
            const course = document.getElementById('f-course').value;
            const favs = getFavorites();
            const isFav = favs.some(f => f.country === country && f.region === region && f.course === course);
            const btn = document.getElementById('f-fav-btn');
            btn.style.color = isFav ? '#ffcc00' : '#444';
            btn.style.borderColor = isFav ? '#ffcc00' : '#333';
        }

        function renderFavorites() {
            const favs = getFavorites();
            const shelf = document.getElementById('f-favorites-shelf');
            if (favs.length === 0) {
                shelf.style.display = 'none';
                return;
            }
            shelf.style.display = 'flex';
            let h = "";
            favs.forEach(f => {
                h += `<button class="btn" onclick="jumpToFavorite('${f.country}', '${f.region}', '${f.course}')" 
                        style="font-size:0.55rem; padding:4px 8px; background:rgba(255,204,0,0.1); border:1px solid #ffcc00; color:#ffcc00; white-space:nowrap; border-radius:15px;">
                        ‚≠ê ${f.course}
                      </button>`;
            });
            shelf.innerHTML = h;
        }

        function jumpToFavorite(c, r, crs) {
            window.isRestoringCurriculum = true;
            document.getElementById('f-country').value = c;
            updateForgeRegions();
            document.getElementById('f-region').value = r;
            updateForgeCourses();
            document.getElementById('f-course').value = crs;
            updateForgeOutcomes();
            window.isRestoringCurriculum = false;
        }

        function toggleAllOutcomes(state) {
            document.querySelectorAll('.outcome-check').forEach(c => c.checked = state);
        }
        // --- END CURRICULUM ---

        // --- BIRTH & HOSPITAL ---
        function birthMission() {
            setForgeLoading(true, "STABILIZING BIOLOGICAL DATA...");
            const lastReply = forgeHistory.filter(m => m.role === 'assistant').pop()?.content;
            if (!lastReply) {
                setForgeLoading(false);
                return alert("NO BIOLOGICAL MATERIAL DETECTED.");
            }

            try {
                // RESILIENT PARSING: Strip markdown fences if present, then find the main JSON object
                let cleanStr = lastReply.trim();
                if (cleanStr.includes("```")) {
                    // Try to extract content between fences
                    const match = cleanStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                    if (match) cleanStr = match[1].trim();
                }

                // Final isolation: Find the first { and last }
                const start = cleanStr.indexOf('{');
                const end = cleanStr.lastIndexOf('}');

                if (start === -1 || end === -1) throw new Error("No JSON object found in AI response.");

                const jsonStr = cleanStr.substring(start, end + 1);
                accumulatedData = JSON.parse(jsonStr);

                // INJECT AUTH DATA
                if (googleUser && accumulatedData.metadata) {
                    accumulatedData.metadata.author = googleUser.name;
                    accumulatedData.metadata.authorEmail = googleUser.email;
                    log(`IDENTITY INJECTED: Mission authored by ${googleUser.name}`, "success");
                }

                addForgeChat("ai", "!!! BIRTH SUCCESSFUL. Initiating clinical review in the Surgical Hospital.");
                openHospital();
            } catch (e) {
                console.error("Birth Error:", e);
                addForgeChat("ai", `!! BIRTH TRAUMA: Parser failed. [Detail: ${e.message}]. Please ask the AI to re-output the RAW JSON block starting with { and ending with }.`);
            } finally {
                setForgeLoading(false);
            }
        }

        function openHospital() {
            // v73.SB UI: Hide main panels for surgical focus
            document.getElementById('forge-panel').style.display = 'none';
            document.getElementById('forge-output').style.display = 'none';

            const hv = document.getElementById('hospital-view');
            hv.style.display = 'grid';
            hv.style.gridColumn = '1 / span 2'; // Take full width of forge-main
            renderHospNodes();
        }

        function renderHospNodes() {
            const nav = document.getElementById('hosp-nav');
            let h = '<div style="font-size:0.6rem; color:var(--forge-accent); margin-bottom:15px; letter-spacing:1px; font-weight:bold;">SURGICAL NODES</div>';

            // Metadata Node
            h += `<div class="hosp-tab" onclick="editHospNode('metadata')">METADATA</div>`;

            // Slide Nodes
            if (accumulatedData.slides) {
                accumulatedData.slides.forEach((s, i) => {
                    h += `<div class="hosp-tab" id="hosp-tab-${i}" onclick="editHospNode(${i})">SLIDE ${i + 1}: ${(s.shortTitle || s.title || 'Untitled').substring(0, 15)}...</div>`;
                });
            }

            // Glossary Node
            h += `<div class="hosp-tab" onclick="editHospNode('glossary')">INTELLIGENCE GLOSSARY</div>`;

            nav.innerHTML = h;
        }

        let currentHospNode = null;
        let editorMode = 'visual'; // 'visual' or 'code'



        function renderSurgicalForm(nodeType, data) {
            return; // DEPRECATED - replaced by renderSurgicalTheater
            const container = document.getElementById('hosp-visual');
            let h = '';

            const inputStyle = "width:100%; background:#222; border:1px solid #444; color:#fff; padding:8px; font-family:var(--font-main); font-size:0.8rem; margin-bottom:10px;";
            const labelStyle = "display:block; color:#888; font-size:0.6rem; margin-bottom:4px; letter-spacing:1px;";

            if (nodeType === 'metadata') {
                h += `<label style="${labelStyle}">TITLE</label>
                      <input class="vis-input" data-key="title" value="${(data.title || '').replace(/"/g, '&quot;')}" style="${inputStyle}">
                      
                      <label style="${labelStyle}">DESCRIPTION</label>
                      <textarea class="vis-input" data-key="description" style="${inputStyle} height:80px;">${(data.description || '')}</textarea>
                      
                      <label style="${labelStyle}">AUTHOR</label>
                      <input class="vis-input" data-key="author" value="${(data.author || '').replace(/"/g, '&quot;')}" style="${inputStyle}">
                      
                      <label style="${labelStyle}">VERSION</label>
                      <input class="vis-input" data-key="version" value="${(data.version || '')}" style="${inputStyle}">`;

            } else if (nodeType === 'glossary') {
                h += `<div style="color:#666; font-size:0.7rem;">Key/Value pairs for AI context.</div>`;
                // Simple read-only view for now or basic editor
                for (const [key, val] of Object.entries(data)) {
                    h += `<div style="margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">
                            <div style="color:#00ffcc; font-size:0.7rem;">${key}</div>
                            <div style="color:#bbb; font-size:0.8rem;">${val}</div>
                          </div>`;
                }
                h += `<div style="font-size:0.6rem; color:#666; margin-top:10px;">To edit Glossary keys, switch to RAW JSON mode.</div>`;

            } else {
                // SLIDES
                h += `<label style="${labelStyle}">SLIDE TITLE</label>
                      <input class="vis-input" data-key="title" value="${(data.title || '').replace(/"/g, '&quot;')}" style="${inputStyle}">
                      
                      <label style="${labelStyle}">IMAGE URL</label>
                      <div style="display:flex; gap:10px;">
                        <input class="vis-input" data-key="image" value="${(data.image || '')}" style="${inputStyle}">
                        <div style="width:40px; height:40px; background-image:url('${data.image}'); background-size:cover; border:1px solid #444;"></div>
                      </div>

                      <label style="${labelStyle}">COMPONENT TYPE</label>
                      <select class="vis-input" data-key="component" style="${inputStyle}">
                        <option value="narrative" ${data.component === 'narrative' ? 'selected' : ''}>Narrative (Text Only)</option>
                        <option value="chat" ${data.component === 'chat' ? 'selected' : ''}>Chat Interface</option>
                        <option value="voting" ${data.component === 'voting' ? 'selected' : ''}>Voting System</option>
                        <option value="code" ${data.component === 'code' ? 'selected' : ''}>Code Terminal</option>
                      </select>

                      <label style="${labelStyle}">CONTENT</label>
                      <textarea class="vis-input" data-key="content" style="${inputStyle} height:150px;">${(data.content || '')}</textarea>`;

                if (data.options) {
                    h += `<label style="${labelStyle}">OPTIONS (Coming soon to Visual Editor)</label>
                           <div style="font-size:0.7rem; color:#666;">Switch to RAW JSON to edit options array.</div>`;
                }
            }

            container.innerHTML = h;

            // Auto-update JSON on input change
            container.querySelectorAll('.vis-input').forEach(el => {
                el.oninput = function () {
                    syncVisualToCode(nodeType);
                };
            });
        }


        let activeTabKey = 'primary';
        let quill = null;
        let turndownService = new TurndownService();
        turndownService.addRule('bold', { filter: ['strong', 'b'], replacement: function (content) { return '**' + content + '**' } });

        // Helper: Deep set
        function setNested(obj, path, value) {
            const parts = path.split('.');
            let current = obj;
            for (let i = 0; i < parts.length - 1; i++) {
                if (!current[parts[i]]) current[parts[i]] = {};
                current = current[parts[i]];
            }
            current[parts[parts.length - 1]] = value;
        }

        // Helper: Media Resolver (YouTube/PDF/Video)
        function formatText(text) {
            if (!text) return "";
            return text
                .replace(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/g,
                    '<div class="video-container" style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; margin:10px 0;"><iframe style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;" src="https://www.youtube.com/embed/$1" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>')
                .replace(/(https?:\/\/.*\.pdf)/gi,
                    '<div class="pdf-container" style="height:300px; margin:10px 0;"><embed src="$1" type="application/pdf" width="100%" height="100%"></div>')
                .replace(/(https?:\/\/.*\.(?:mp4|avi|mov|webm))/gi,
                    '<video controls style="width:100%; max-height:300px; background:#000; margin:10px 0;"><source src="$1">Video not supported.</video>')
                .replace(/\n/g, '<br>');
        }

        function toggleEditorMode(mode) {
            const visual = document.getElementById('hosp-visual');
            const code = document.getElementById('hosp-editor');
            if (mode === 'visual') {
                visual.style.display = 'block';
                code.style.display = 'none';
                // Re-render visual from code
                try {
                    const data = JSON.parse(code.value);
                    if (currentHospNode === 'metadata') {
                        accumulatedData.metadata = data;
                        renderMetadataEditor(data);
                    } else if (currentHospNode === 'glossary') {
                        accumulatedData.intelligenceGlossary = data;
                        renderGlossaryEditor(data);
                    } else {
                        accumulatedData.slides[currentHospNode] = data;
                        renderSurgicalTheater(data);
                    }
                } catch (e) { }
            } else {
                visual.style.display = 'none';
                code.style.display = 'block';
            }
        }

        function editHospNode(idx) {
            currentHospNode = idx;
            document.querySelectorAll('.hosp-tab').forEach(t => t.classList.remove('active'));

            const path = document.getElementById('hosp-path');

            // Force Visual Mode on Open
            document.getElementById('hosp-visual').style.display = 'block';
            document.getElementById('hosp-editor').style.display = 'none';
            document.querySelector('input[value="visual"]').checked = true;

            let data = {};

            if (idx === 'metadata') {
                path.innerText = "NODE: METADATA";
                renderMetadataEditor(accumulatedData.metadata);
            } else if (idx === 'glossary') {
                path.innerText = "NODE: GLOSSARY";
                renderGlossaryEditor(accumulatedData.intelligenceGlossary || {});
            } else {
                path.innerText = `NODE: SLIDE_${idx + 1}`;
                const tab = document.getElementById(`hosp-tab-${idx}`);
                if (tab) tab.classList.add('active');

                // Ensure tabs structure exists
                if (!accumulatedData.slides[idx].tabs) {
                    accumulatedData.slides[idx].tabs = { primary: { label: "Main", content: "" } };
                }
                renderSurgicalTheater(accumulatedData.slides[idx]);
            }

            // Populate Code Editor (Hidden Backup)
            document.getElementById('hosp-editor').value = JSON.stringify(
                (idx === 'metadata') ? accumulatedData.metadata :
                    (idx === 'glossary') ? accumulatedData.intelligenceGlossary :
                        accumulatedData.slides[idx], null, 2
            );
        }

        function renderMetadataEditor(data) {
            const container = document.getElementById('hosp-visual');
            container.innerHTML = ''; // Clear

            const header = document.createElement('h3');
            header.style.cssText = 'color:var(--forge-accent); margin-top:0;';
            header.innerText = 'PATIENT DOSSIER';
            container.appendChild(header);

            createSharedInput("Mission ID", data.id || "", "id", data, container);
            createSharedInput("Title", data.title || "", "title", data, container);
            createSharedInput("Description", data.description || "", "description", data, container);
            createSharedInput("Author", data.author || "", "author", data, container);
            createSharedInput("Version", data.version || "", "version", data, container);

            // Learning Outcomes Section
            const outcomesHeader = document.createElement('h4');
            outcomesHeader.style.cssText = 'color:var(--forge-accent); margin-top:20px; margin-bottom:10px;';
            outcomesHeader.innerText = 'LEARNING OUTCOMES';
            container.appendChild(outcomesHeader);

            // Ensure learningOutcomes array exists
            if (!data.learningOutcomes) data.learningOutcomes = [];

            data.learningOutcomes.forEach((outcome, i) => {
                const row = document.createElement('div');
                row.style.cssText = 'display:flex; gap:10px; margin-bottom:8px; align-items:center;';

                const input = document.createElement('input');
                input.className = 'med-input';
                input.style.flex = '1';
                input.value = outcome;
                input.placeholder = 'Learning Outcome';
                input.onchange = () => {
                    data.learningOutcomes[i] = input.value;
                    syncMetadataToCode();
                };

                const delBtn = document.createElement('button');
                delBtn.className = 'btn';
                delBtn.style.cssText = 'padding:5px 10px; font-size:0.7rem; background:#600;';
                delBtn.innerText = 'X';
                delBtn.onclick = () => {
                    data.learningOutcomes.splice(i, 1);
                    renderMetadataEditor(data);
                    syncMetadataToCode();
                };

                row.appendChild(input);
                row.appendChild(delBtn);
                container.appendChild(row);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'btn';
            addBtn.style.cssText = 'margin-top:5px; font-size:0.7rem;';
            addBtn.innerText = '+ ADD OUTCOME';
            addBtn.onclick = () => {
                data.learningOutcomes.push('');
                renderMetadataEditor(data);
                syncMetadataToCode();
            };
            container.appendChild(addBtn);

            // Advanced Settings
            const advHeader = document.createElement('h4');
            advHeader.style.cssText = 'color:var(--forge-accent); margin-top:30px; margin-bottom:10px;';
            advHeader.innerText = 'SIMULATION PROTOCOLS';
            container.appendChild(advHeader);

            const advDesc = document.createElement('div');
            advDesc.style.cssText = 'color:#666; font-size:0.65rem; margin-bottom:15px; font-style:italic;';
            advDesc.innerText = "Configure intelligent layers for the student's console.";
            container.appendChild(advDesc);

            const checkRow = document.createElement('div');
            checkRow.style.cssText = 'display:flex; align-items:center; gap:10px; margin-bottom:10px;';

            const check = document.createElement('input');
            check.type = 'checkbox';
            check.checked = data.enableDevilsAdvocate !== false;
            check.onchange = () => {
                data.enableDevilsAdvocate = check.checked;
                syncMetadataToCode();
            };

            const label = document.createElement('label');
            label.style.cssText = 'color:#eee; font-size:0.8rem; cursor:pointer;';
            label.innerText = "Enable AI 'Devil's Advocate' (Challenge Rationales)";

            checkRow.onclick = () => { check.checked = !check.checked; check.onchange(); };
            checkRow.style.cursor = 'pointer';

            checkRow.appendChild(check);
            checkRow.appendChild(label);
            container.appendChild(checkRow);
        }

        function syncMetadataToCode() {
            document.getElementById('hosp-editor').value = JSON.stringify(
                accumulatedData.metadata, null, 2
            );
        }

        function renderGlossaryEditor(data) {
            const container = document.getElementById('hosp-visual');
            container.innerHTML = ''; // Clear

            const header = document.createElement('h3');
            header.style.cssText = 'color:var(--forge-accent); margin-top:0;';
            header.innerText = 'INTELLIGENCE GLOSSARY';
            container.appendChild(header);

            const subhead = document.createElement('div');
            subhead.style.cssText = 'font-size:0.7rem; color:#666; margin-bottom:15px;';
            subhead.innerText = 'Define key terms for the AI context.';
            container.appendChild(subhead);

            // Handle array format [{term, definition}]
            if (Array.isArray(data)) {
                data.forEach((item, i) => {
                    const row = document.createElement('div');
                    row.style.cssText = 'display:grid; grid-template-columns: 150px 1fr; gap:10px; margin-bottom:10px; align-items:start;';

                    const termInput = document.createElement('input');
                    termInput.className = 'med-input';
                    termInput.value = item.term || item.key || '';
                    termInput.placeholder = 'Term';
                    termInput.onchange = () => {
                        data[i].term = termInput.value;
                        syncGlossaryToCode();
                    };

                    const defInput = document.createElement('textarea');
                    defInput.className = 'med-input';
                    defInput.style.minHeight = '60px';
                    defInput.value = item.definition || item.value || item.description || '';
                    defInput.placeholder = 'Definition';
                    defInput.onchange = () => {
                        data[i].definition = defInput.value;
                        syncGlossaryToCode();
                    };

                    row.appendChild(termInput);
                    row.appendChild(defInput);
                    container.appendChild(row);
                });

                // Add button
                const addBtn = document.createElement('button');
                addBtn.className = 'btn';
                addBtn.style.cssText = 'margin-top:10px; font-size:0.7rem;';
                addBtn.innerText = '+ ADD TERM';
                addBtn.onclick = () => {
                    data.push({ term: '', definition: '' });
                    renderGlossaryEditor(data);
                    syncGlossaryToCode();
                };
                container.appendChild(addBtn);
            } else if (typeof data === 'object' && data !== null) {
                // Object format {key: value} - less common, convert to editable
                Object.keys(data).forEach(key => {
                    const row = document.createElement('div');
                    row.style.cssText = 'display:grid; grid-template-columns: 150px 1fr; gap:10px; margin-bottom:10px;';

                    const keyLabel = document.createElement('div');
                    keyLabel.style.cssText = 'color:var(--forge-accent); padding:8px 0;';
                    keyLabel.innerText = key;

                    const valInput = document.createElement('input');
                    valInput.className = 'med-input';
                    valInput.value = data[key];
                    valInput.onchange = () => {
                        data[key] = valInput.value;
                        syncGlossaryToCode();
                    };

                    row.appendChild(keyLabel);
                    row.appendChild(valInput);
                    container.appendChild(row);
                });
            }
        }

        function syncGlossaryToCode() {
            document.getElementById('hosp-editor').value = JSON.stringify(
                accumulatedData.intelligenceGlossary, null, 2
            );
        }

        function renderSurgicalTheater(slide) {
            const container = document.getElementById('hosp-visual');
            container.innerHTML = ''; // Clear

            const theater = document.createElement('div');
            theater.className = 'surgical-theater';

            // --- LEFT: VISUAL MONITOR ---
            const monitor = document.createElement('div');
            monitor.className = 'visual-monitor';

            const tabData = slide.tabs[activeTabKey] || slide.tabs.primary || {};

            // Support legacy data: image may be on slide root, not in tabs
            const mediaUrl = tabData.image || slide.image || slide.video || "";

            // Media Preview Logic
            const imgLabel = document.createElement('label');
            imgLabel.className = 'med-label';
            imgLabel.innerText = `${activeTabKey.toUpperCase()} // VISUAL SENSOR FEED`;
            monitor.appendChild(imgLabel);

            if (mediaUrl) {
                const url = mediaUrl;
                const ytMatch = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                const isPDF = url.toLowerCase().endsWith('.pdf');
                const isVideo = url.match(/\.(mp4|avi|mov|webm)$/i);

                const mediaBox = document.createElement('div');
                mediaBox.style.border = "1px solid #333";

                if (ytMatch) {
                    mediaBox.innerHTML = `<div class="video-container" style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden;"><iframe style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;" src="https://www.youtube.com/embed/${ytMatch[1]}" allowfullscreen></iframe></div>`;
                } else if (isPDF) {
                    mediaBox.innerHTML = `<embed src="${url}" type="application/pdf" width="100%" height="200px">`;
                } else if (isVideo) {
                    mediaBox.innerHTML = `<video controls style="width:100%;"><source src="${url}"></video>`;
                } else {
                    mediaBox.innerHTML = `<img src="${url}" style="width:100%; opacity:0.9;">`;
                }
                monitor.appendChild(mediaBox);
            } else {
                const noSig = document.createElement('div');
                noSig.style.height = '150px';
                noSig.style.background = '#111';
                noSig.style.display = 'flex';
                noSig.alignItems = 'center';
                noSig.justifyContent = 'center';
                noSig.style.color = '#333';
                noSig.innerText = "NO VISUAL SIGNAL";
                monitor.appendChild(noSig);
            }

            // Monitor Inputs - use shortTitle as fallback
            createSharedInput("Slide Title (Navigation)", slide.shortTitle || slide.title || "", "shortTitle", slide, monitor);
            createSharedInput("Tab Label", tabData.label || "", `tabs.${activeTabKey}.label`, slide, monitor);
            createSharedInput("Image/Media URL", mediaUrl, `tabs.${activeTabKey}.image`, slide, monitor, true); // True triggers re-render
            createSharedInput("Interaction Prompt", slide.interactionPrompt || "", "interactionPrompt", slide, monitor);

            // --- RIGHT: DATA INPUT PANEL ---
            const inputPanel = document.createElement('div');
            inputPanel.className = 'data-input-panel';

            // Tactical Tabs Headers - show ALL tabs with their actual labels
            const tabsHeader = document.createElement('div');
            tabsHeader.className = 'tactical-tabs';
            const availableTabs = Object.keys(slide.tabs);
            availableTabs.forEach(key => {
                const tabInfo = slide.tabs[key];
                const btn = document.createElement('div');
                btn.className = `t-tab ${activeTabKey === key ? 'active' : ''}`;
                // Use the tab's label property if available, otherwise capitalize the key
                btn.innerText = (tabInfo.label || key).toUpperCase();
                btn.onclick = () => { activeTabKey = key; renderSurgicalTheater(slide); };
                tabsHeader.appendChild(btn);
            });
            inputPanel.appendChild(tabsHeader);

            // Quill Editor
            const quillWrap = document.createElement('div');
            inputPanel.appendChild(quillWrap);

            // Append output
            theater.appendChild(monitor);
            theater.appendChild(inputPanel);
            container.appendChild(theater);

            // Init Quill (must be in DOM)
            // Fix: handle legacy 'content' vs new 'body'
            const content = tabData.body || tabData.content || "";
            createQuillEditor(content, `tabs.${activeTabKey}.body`, slide, quillWrap);
        }

        function createSharedInput(label, val, path, objRoot, appendTo, triggerRender = false) {
            const group = document.createElement('div');
            group.innerHTML = `<label class="med-label">${label}</label>`;
            const input = document.createElement('input');
            input.className = 'med-input';
            input.value = val;
            input.onchange = (e) => {
                setNested(objRoot, path, e.target.value);
                // updating master 'accumulatedData' implicitly via reference
                document.getElementById('hosp-editor').value = JSON.stringify(
                    (currentHospNode === 'metadata') ? accumulatedData.metadata :
                        (currentHospNode === 'glossary') ? accumulatedData.intelligenceGlossary :
                            accumulatedData.slides[currentHospNode], null, 2
                );
                if (triggerRender) renderSurgicalTheater(objRoot);
            };
            group.appendChild(input);
            appendTo.appendChild(group);
        }

        function createQuillEditor(mdContent, path, objRoot, appendTo) {
            const group = document.createElement('div');
            group.innerHTML = `<label class="med-label">OPERATIONAL NARRATIVE (RICH TEXT)</label>`;
            const editorDiv = document.createElement('div');
            editorDiv.style.background = '#080808';
            editorDiv.style.border = '1px solid #333';
            group.appendChild(editorDiv);
            appendTo.appendChild(group);

            quill = new Quill(editorDiv, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, false] }],
                        ['bold', 'italic', 'underline'],
                        ['link', 'blockquote', 'code-block'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }]
                    ]
                }
            });

            // Set content
            quill.root.innerHTML = marked.parse(mdContent || "");

            // Sync on change
            quill.on('text-change', () => {
                const html = quill.root.innerHTML;
                const md = turndownService.turndown(html);
                setNested(objRoot, path, md);
                document.getElementById('hosp-editor').value = JSON.stringify(
                    accumulatedData.slides[currentHospNode], null, 2
                );
            });
        }

        function saveHospEdit() {
            // Logic is unified: The Code Editor is the Source of Truth.
            // Visual inputs update the Code Editor in real-time.
            // When saving, we just parse the Code Editor.
            const val = document.getElementById('hosp-editor').value;
            try {
                const parsed = JSON.parse(val);
                if (currentHospNode === 'metadata') {
                    accumulatedData.metadata = parsed;
                } else if (currentHospNode === 'glossary') {
                    accumulatedData.intelligenceGlossary = parsed;
                } else {
                    accumulatedData.slides[currentHospNode] = parsed;
                }
                log("Surgical Node Stabilized.", "success");
                renderHospNodes(); // Refresh sidebar titles
            } catch (e) { alert("Surgical Error: Invalid JSON in editor."); }
        }

        // --- IMPORT MISSION ---
        function handleLocalImport(input) {
            const file = input.files[0];
            if (!file) return;

            log(`Reading file: ${file.name} (${file.size} bytes)`, "success");

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    let raw = e.target.result.trim();

                    // Robust Isolate: Find first { and last } to strip potential markdown or noise
                    const start = raw.indexOf('{');
                    const end = raw.lastIndexOf('}');
                    if (start === -1 || end === -1) throw new Error("No JSON object found.");

                    const cleanJson = raw.substring(start, end + 1);
                    const payload = JSON.parse(cleanJson);
                    loadMissionIntoForge(payload, "FILE IMPORT");
                } catch (err) {
                    log(`Import Error: ${err.message}`, "error");
                    alert("FAILED: The file provided is not a valid Mission Capsule JSON.");
                }
            };
            reader.readAsText(file);
        }

        async function importMissionFromArchive(id) {
            log(`Loading Archive Mission [${id}]...`);

            // Fetch full payload from Supabase (cache only has metadata)
            if (SupabaseBridge.client) {
                try {
                    const teacherId = googleUser?.email || 'GUEST';
                    const { data, error } = await SupabaseBridge.client
                        .from('missions')
                        .select('blob_data')
                        .eq('mission_id', id)
                        .eq('teacher_id', teacherId)
                        .single();

                    if (error) throw error;
                    if (!data || !data.blob_data) throw new Error("Mission payload not found");

                    loadMissionIntoForge(data.blob_data, `ARCHIVE: ${id}`);
                    toggleLibrary(); // Close hub
                    return;
                } catch (e) {
                    log(`Supabase Fetch Failed: ${e.message}`, "error");
                    alert(`FAILED: Could not load mission from archive.\n\n${e.message}`);
                }
            } else {
                alert("Supabase is not configured. Cannot load missions from archive.");
            }
        }

        function loadMissionIntoForge(payload, sourceLabel) {
            // v73.SB: More permissive validation
            if (!payload || typeof payload !== 'object') {
                log("Import Error: Payload is not a valid object", "error");
                alert("FAILED: The file does not contain valid mission data.");
                return;
            }

            accumulatedData = payload;
            log(`DECRYPTED: Mission Capsule loaded from ${sourceLabel}.`, "success");

            // Jump to Birth Phase
            currentPhaseIndex = forgePipeline.indexOf('birth');
            if (currentPhaseIndex === -1) currentPhaseIndex = forgePipeline.length - 1;

            updateForgeUI();

            // Auto-open Hospital if slides detected
            if (payload.slides && payload.slides.length > 0) {
                openHospital();
                addForgeChat("ai", `!!! MISSION DATA RECOVERED [Source: ${sourceLabel}]. You are now in the Surgical Fine-Tuning mode. You can edit the JSON directly or re-birth the mission.`);
            } else {
                addForgeChat("ai", `Mission loaded from ${sourceLabel}. Note: No slides detected. You may need to manually configure the mission structure.`);
            }
        }

        function downloadBirthedBlob() {
            if (!accumulatedData) return;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(accumulatedData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", (accumulatedData.metadata.id || "mission") + ".blob");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            log("Local Source Download Initiated.", "success");
        }

        async function finalizeForge() {
            if (!confirm("Confirm Mission Deployment to Command Center?")) return;

            const id = accumulatedData.metadata.id.toUpperCase().replace(/\s/g, '');
            const name = accumulatedData.metadata.title;

            const teacherId = (typeof googleUser !== 'undefined') ? googleUser.email : 'GUEST';

            log(`Injecting Birthed Capsule [${id}]...`);
            if (SupabaseBridge.client) {
                try {
                    await SupabaseBridge.saveMission(id, name, accumulatedData, teacherId);
                    log("INTEGRATED INJECTION SUCCESSFUL.", "success");
                    toggleForge();
                    fetchMissions();
                    alert(`Mission [${name}] is now LIVE.`);
                } catch (e) { log("Deployment Failed: " + e.message, "error"); }
            } else {
                log("Supabase not configured. Cannot deploy.", "error");
            }
        }
        // --- END HOSPITAL ---

        async function fetchMissions() {
            log("Querying Supabase Archive...");
            const teacherId = googleUser?.email || 'GUEST';

            // CACHE LOAD (Interim)
            const cachedMissions = localStorage.getItem('TM_MISSION_CACHE');
            if (cachedMissions) {
                try {
                    renderMissions(JSON.parse(cachedMissions));
                } catch (e) { }
            }

            if (SupabaseBridge.client) {
                try {
                    log("Querying Supabase Archive...");
                    const missions = await SupabaseBridge.fetchMissions(teacherId);
                    log(`Supabase Handshake Successful. Found ${missions.length} mission(s).`, "success");
                    localStorage.setItem('TM_MISSION_CACHE', JSON.stringify(missions));
                    renderMissions(missions);
                    setStatus("online", "SUPABASE_CONNECTED");
                } catch (e) {
                    log(`Supabase Query Failed: ${e.message}`, "error");
                    setStatus("offline", "CONNECTION_FAILURE");
                }
            } else {
                log("Supabase not configured. Missions cannot be synced.", "error");
                setStatus("offline", "SUPABASE_NOT_CONFIGURED");
            }
        }

        async function upload() {
            const id = document.getElementById('m-id').value.toUpperCase().replace(/\s/g, ''),
                name = document.getElementById('m-name').value,
                raw = document.getElementById('json-input').value;

            if (!id || !name || !raw) return log("ABORTED: Missing required parameters.", "error");
            log(`Opening stream for Capsule [${id}]...`);

            const teacherId = (typeof googleUser !== 'undefined') ? googleUser.email : 'GUEST';
            const payload = JSON.parse(raw);

            // [Telemetry v0.50] Inject logging target into mission metadata
            if (!payload.metadata) payload.metadata = {};
            payload.metadata.creator_email = teacherId;
            payload.metadata.sb_url = localStorage.getItem('TM_SUPABASE_URL');
            payload.metadata.sb_key = localStorage.getItem('TM_SUPABASE_KEY');

            // --- Supabase Injection ---
            if (SupabaseBridge.client) {
                try {
                    log("Injecting into Supabase Cloud...");
                    await SupabaseBridge.saveMission(id, name, payload, teacherId);
                    log(`Supabase Injection Successful [${id}]`, "success");
                    fetchMissions();
                } catch (e) {
                    log(`Supabase Injection Failed: ${e.message}`, "error");
                }
            } else {
                log("Supabase not configured. Cannot save mission.", "error");
            }
        }

        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    // SCHEMA v1.0 SUPPORT
                    const id = (data.metadata && data.metadata.id) ? data.metadata.id : data.missionId || "";
                    const name = (data.metadata && data.metadata.title) ? data.metadata.title : (data.meta && data.meta.title) ? data.meta.title : "";

                    document.getElementById('m-id').value = id;
                    document.getElementById('m-name').value = name;
                    document.getElementById('json-input').value = e.target.result;

                    log(`Capsule [${file.name}] loaded into staging.`, "success");
                    document.getElementById('upload-zone').style.borderColor = "var(--success)";
                } catch (ex) { log("INVALID CAPSULE: Not a valid .blob/JSON file.", "error"); }
            };
            reader.readAsText(file);
        }

        async function fetchProgress() {
            document.getElementById('sync-tick').innerText = "[SYNC_BUSY]";

            if (SupabaseBridge.client) {
                try {
                    const teacherId = (typeof googleUser !== 'undefined') ? googleUser.email : 'GUEST';
                    const logs = await SupabaseBridge.fetchLogs(teacherId);

                    if (logs && logs.length > 0) {
                        const normalized = {};
                        logs.forEach(l => {
                            const key = l.student_name + "_" + l.class_period;
                            if (!normalized[key]) {
                                normalized[key] = {
                                    id: l.id,
                                    name: l.student_name,
                                    class: l.class_period || "UNKNOWN",
                                    missionData: {}
                                };
                            }
                            if (!normalized[key].missionData[l.mission_id]) {
                                normalized[key].missionData[l.mission_id] = { dec: {}, rat: {}, preDone: true };
                            }
                            if (l.decision_json && typeof l.decision_json.slideIndex !== 'undefined') {
                                normalized[key].missionData[l.mission_id].dec[l.decision_json.slideIndex] = "SB_RECORD";
                                normalized[key].missionData[l.mission_id].rat[l.decision_json.slideIndex] = l.rationale;
                            }
                        });
                        allProgress = Object.values(normalized);
                        updateClassFilter(); renderProgress();
                        document.getElementById('sync-tick').innerText = "[SYNC_SB_OK]";
                        setTimeout(() => document.getElementById('sync-tick').innerText = "[SYNC_IDLE]", 3000);
                    } else {
                        document.getElementById('sync-tick').innerText = "[SYNC_IDLE]";
                    }
                } catch (e) {
                    log("Supabase Progress Fetch Failed: " + e.message, "error");
                    document.getElementById('sync-tick').innerText = "[SYNC_FAIL]";
                }
            } else {
                document.getElementById('sync-tick').innerText = "[SYNC_ERR]";
            }
        }

        function updateClassFilter() {
            const f = document.getElementById('class-filter'); const val = f.value;
            const classes = [...new Set(allProgress.map(p => p.class))].sort();
            let h = `<option value="ALL">ALL CLASSES</option>`;
            classes.forEach(c => { h += `<option value="${c}">${c}</option>`; });
            f.innerHTML = h; if (f.innerHTML.includes(val)) f.value = val;
        }

        function renderProgress() {
            const filter = document.getElementById('class-filter').value;
            const filtered = filter === "ALL" ? allProgress : allProgress.filter(p => p.class === filter);
            let h = "";
            filtered.forEach(p => {
                const missions = Object.keys(p.missionData || {});
                // Strip any trailing PIN from name (e.g., "Dave 2188" becomes "Dave")
                const displayName = p.name.replace(/\s+\d+$/, '');
                missions.forEach(mid => {
                    const st = p.missionData[mid]; if (!st) return;
                    const decs = st.dec ? Object.keys(st.dec).length : 0;
                    const pre = st.preDone ? "‚úì" : "√ó";

                    h += `<div style="padding:6px 10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; gap:10px;">
                        <div style="flex:1; min-width:0;">
                            <div style="font-size:0.7rem; font-weight:bold;">${displayName} <span style="color:#888; font-weight:normal; font-size:0.65rem;">${p.class}</span></div>
                            <div style="color:#666; font-size:0.6rem; margin-top:2px;">MISSION: ${mid} | STEP: ${decs} | BRIEF: ${pre}</div>
                        </div>
                         <button class="btn" style="padding:5px 10px; font-size:0.6rem; background:#c00; color:#fff; white-space:nowrap; flex-shrink:0; width:auto !important;" onclick="deleteStudent('${p.id}', '${displayName}', '${p.class}')">DEL</button>
                      </div>`;
                });
            });
            document.getElementById('progress-list').innerHTML = h || "<p style='color:#ccc; padding:20px; font-size:0.65rem;'>No student data detected.</p>";
        }

        async function deleteStudent(id, name, classCode) {
            if (!confirm(`DELETE STUDENT: ${name}?\n\nThis will permanently remove all progress data. This action cannot be undone.`)) return;
            log(`Purging records for [${name}] class [${classCode}]...`);

            if (SupabaseBridge.client) {
                try {
                    const success = await SupabaseBridge.deleteLogs(name, classCode);
                    if (success) {
                        log(`Supabase records purged for ${name}.`, "success");
                        setTimeout(fetchProgress, 500);
                    }
                } catch (e) {
                    log("Supabase Delete Failed: " + e.message, "error");
                }
            } else {
                log("Supabase not configured. Cannot delete record.", "error");
            }
        }

        async function runAI(uid, mid) {
            alert("Student AI Analysis is currently offline during backend migration.");
        }

        async function toggleAI(id, state) {
            log(`Updating AI Protocols for [${id}]...`);
            const teacherId = (typeof googleUser !== 'undefined') ? googleUser.email : 'GUEST';

            // OPTIMISTIC CACHE UPDATE
            const cached = localStorage.getItem('TM_MISSION_CACHE');
            if (cached) {
                try {
                    const missions = JSON.parse(cached);
                    missions.forEach(m => { if (m.id === id) m.aiEnabled = state; });
                    localStorage.setItem('TM_MISSION_CACHE', JSON.stringify(missions));
                } catch (e) { }
            }

            if (SupabaseBridge.client) {
                try {
                    await SupabaseBridge.toggleAI(id, state, teacherId);
                    log(`Supabase AI Protocol Updated [${id}]: ${state ? 'ENABLED' : 'DISABLED'}`, "success");
                } catch (e) {
                    log(`Supabase Toggle Failed: ${e.message}`, "error");
                }
            } else {
                log("Supabase not configured. Cannot toggle AI.", "error");
            }
        }

        async function deleteMission(id) {
            if (!confirm(`PERMANENT DELETION: Are you sure you want to scrub mission [${id}] from the record?`)) return;
            log(`DELETING CAPSULE [${id}]...`);

            const teacherId = (typeof googleUser !== 'undefined') ? googleUser.email : 'GUEST';

            if (SupabaseBridge.client) {
                try {
                    log("Scrubbing from Supabase Cloud...");
                    await SupabaseBridge.deleteMission(id, teacherId);
                    log(`Supabase Delete Successful [${id}]`, "success");
                    fetchMissions();
                } catch (e) {
                    log(`Supabase Delete Failed: ${e.message}`, "error");
                }
            } else {
                log("Supabase not configured. Cannot delete from cloud.", "error");
            }
        }

        function renderMissions(missions) {
            console.log("DEBUG: Missions Payload:", missions); // DEBUG INSPECTION
            const list = document.getElementById('library-list');
            if (!missions || missions.length === 0) {
                list.innerHTML = "<div style='color:#ccc; padding:20px; font-size:0.65rem;'>No missions in archive.</div>";
                document.getElementById('lib-log').innerText = "Archive empty.";
                return;
            }
            document.getElementById('lib-log').innerText = `${missions.length} mission(s) loaded.`;
            const isUserAdmin = googleUser && ["dwaugh@gmail.com"].includes(googleUser.email);

            let h = `<table style="width:100%; font-size:0.65rem; border-collapse:collapse;">
                    <thead><tr style="border-bottom:1px solid #ddd; text-align:left;">
                        <th style="padding:8px; width:50px;">VISUAL</th>
                        <th style="padding:8px;">ID</th>
                        <th style="padding:8px;">NAME</th>
                    <th style="padding:8px; text-align:center;">AI Qs</th>
                        <th style="padding:8px; text-align:center;">ACTION</th>
                    </tr></thead><tbody>`;

            missions.forEach(m => {
                const thumb = m.thumb || "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=200&auto=format&fit=crop";
                const desc = (m.description || "").replace(/'/g, "\\'").substring(0, 200);
                const publishBtn = "";

                h += `<tr style="border-bottom:1px solid #eee;">
                    <td style="padding:8px;">
                        <div style="width:40px; height:25px; background-image:url('${thumb}'); background-size:cover; background-position:center; border-radius:2px; border:1px solid #ccc;"></div>
                    </td>
                    <td style="padding:8px; font-weight:bold;">${m.id}</td>
                    <td style="padding:8px;">${m.name}</td>
                    <td style="padding:8px; text-align:center;">
                        <label style="cursor:pointer; display:inline-flex; align-items:center; justify-content:center;">
                            <input type="checkbox" ${m.aiEnabled ? 'checked' : ''} onchange="toggleAI('${m.id}', this.checked)" style="cursor:pointer; transform:scale(1.2);">
                        </label>
                    </td>
                    <td style="padding:8px; text-align:center;">
                        ${publishBtn}
                        <button onclick="importMissionFromArchive('${m.id}')" style="font-size:0.6rem; padding:4px 8px; background:#0088ff; color:#fff; border:none; cursor:pointer; margin-right:4px;">LOAD</button>
                        <button class="btn-del" onclick="deleteMission('${m.id}')" style="font-size:0.6rem; padding:4px 8px; background:none; border:1px solid #c00; color:#c00; cursor:pointer;">DEL</button>
                    </td>
                  </tr>`;
            });
            h += `</tbody></table>`;
            list.innerHTML = h;
        }

        // FAILSAFE: Ensure UI renders even if handshake is slow
        window.onload = () => {
            log("BOOT SEQUENCE INITIATED...");

            // V73.SB.UDL Supabase Init
            if (SB_URL && SB_KEY) {
                const connected = SupabaseBridge.init(SB_URL, SB_KEY);
                if (connected) {
                    const sbIndicator = document.getElementById('sb-status');
                    sbIndicator.innerText = "SB_LIVE";
                    sbIndicator.style.color = "var(--accent)";
                    sbIndicator.style.borderColor = "var(--accent)";
                    sbIndicator.style.boxShadow = "0 0 10px var(--accent-dim)";
                }
            }

            // Sync Status
            const lastSync = localStorage.getItem('TM_LAST_SYNC');
            if (lastSync) {
                const cl = document.getElementById('cl-status');
                cl.innerText = "CL_SYNCED";
                cl.style.color = "#00ff88";
                cl.style.borderColor = "#00ff88";
            }

            if (typeof google !== 'undefined' && google.accounts) {
                initGoogleAuth();
            }
            setTimeout(fetchMissions, 1000);
            setInterval(fetchProgress, 30000);
        };

        // PROJECTOR VIEW
        function toggleProjector() {
            const pv = document.getElementById('projector-view');
            pv.classList.toggle('active');
            if (pv.classList.contains('active')) renderProjectorBoard();
        }

        function renderProjectorBoard() {
            const board = document.getElementById('proj-board');
            const classFilter = document.getElementById('proj-class-filter');
            const missionFilter = document.getElementById('proj-mission-filter');
            document.getElementById('proj-sync').innerText = "[LOG_ACTIVE]";

            // Build entries list
            const entries = [];
            const allClasses = new Set();
            const allMissions = new Set();

            allProgress.forEach(p => {
                Object.keys(p.missionData || {}).forEach(mid => {
                    const st = p.missionData[mid];
                    if (st) {
                        entries.push({ name: p.name, class: p.class, mission: mid, steps: st.dec ? Object.keys(st.dec).length : 0, brief: st.preDone ? "READY" : "BRIEFING" });
                        allClasses.add(p.class);
                        allMissions.add(mid);
                    }
                });
            });

            // Populate filter dropdowns (preserve selection)
            const currentClass = classFilter.value;
            const currentMission = missionFilter.value;

            classFilter.innerHTML = '<option value="ALL">ALL CLASSES</option>';
            [...allClasses].sort().forEach(c => {
                classFilter.innerHTML += `<option value="${c}" ${c === currentClass ? 'selected' : ''}>${c}</option>`;
            });

            missionFilter.innerHTML = '<option value="ALL">ALL MISSIONS</option>';
            [...allMissions].sort().forEach(m => {
                missionFilter.innerHTML += `<option value="${m}" ${m === currentMission ? 'selected' : ''}>${m}</option>`;
            });

            // Apply filters
            let filtered = entries;
            if (classFilter.value !== 'ALL') {
                filtered = filtered.filter(e => e.class === classFilter.value);
            }
            if (missionFilter.value !== 'ALL') {
                filtered = filtered.filter(e => e.mission === missionFilter.value);
            }

            // Sort and render
            filtered.sort((a, b) => (a.class > b.class) ? 1 : (a.name > b.name) ? 1 : -1);

            let h = "";
            filtered.forEach(e => {
                const pct = (e.steps / 18) * 100;
                h += `<div class="proj-card ${e.steps > 0 ? 'active' : ''}">
                <div class="proj-name">${e.name}</div>
                <div class="proj-class">${e.class} // ${e.mission}</div>
                <div class="proj-stats">
                    <div><div style="color:#d2b48c; font-size:0.5rem; text-transform:uppercase; margin-bottom:2px;">Exhibit</div><div style="font-size:0.75rem; color:#fff;">${e.steps}</div></div>
                    <div><div style="color:#d2b48c; font-size:0.5rem; text-transform:uppercase; margin-bottom:2px;">Status</div><div style="font-size:0.65rem; color:${e.brief === 'READY' ? '#0f0' : '#ff0'};">${e.brief}</div></div>
                </div>
                <div class="proj-bar"><div class="proj-fill" style="width:${pct}%"></div></div>
            </div>`;
            });

            document.getElementById('proj-sync').innerText = `[${filtered.length} AGENTS]`;
            board.innerHTML = h || "<div style='grid-column:1/-1; text-align:center; opacity:0.3; padding:100px; color:#d2b48c;'>WAITING FOR FIELD AGENTS...</div>";
        }

        // BATCH AI ANALYSIS
        async function analyzeAll() {
            const candidates = [];
            allProgress.forEach(p => {
                Object.keys(p.missionData || {}).forEach(mid => {
                    const st = p.missionData[mid];
                    if (st && st.preDone && !st.aiFeedback) candidates.push({ uid: p.id, mid: mid, name: p.name });
                });
            });
            if (candidates.length === 0) return log("No students ready for AI analysis.", "info");
            if (!confirm(`Generate AI feedback for ${candidates.length} student(s)? This may take 1-2 minutes.`)) return;

            log(`Starting batch AI analysis for ${candidates.length} students...`);
            let processed = 0;
            for (const c of candidates) {
                await runAI(c.uid, c.mid);
                processed++;
                log(`Progress: ${processed}/${candidates.length} (${c.name})`, "info");
                if (processed < candidates.length) await new Promise(r => setTimeout(r, 4000)); // Rate limit: 15 RPM
            }
            log(`Batch complete. ${processed} students analyzed.`, "success");
            fetchProgress();
        }
    </script>
    <!-- SETTINGS OVERLAY -->
    <div id="settings-overlay">
        <div class="settings-card">
            <div style="margin-top:20px; padding-top:15px; border-top:1px dashed #444;">
                <h4 style="margin:0 0 10px; font-size:0.7rem; color:var(--accent);">SUPABASE CLOUD</h4>
                <label>Supabase Project URL</label>
                <input type="text" id="set-sb-url" class="settings-input" placeholder="https://xyz.supabase.co">
                <label>Anon Public Key</label>
                <input type="password" id="set-sb-key" class="settings-input" placeholder="eyJhbGciOiJIUzI1NiI...">
            </div>

            <div style="font-size:0.5rem; color:#666; margin-bottom:20px; font-style:italic;">
                * Settings are saved to local storage. Changes require a page refresh to fully propagate across all AI
                services.
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="saveSettings()"
                    style="flex:2; background:var(--forge-accent); font-size:0.7rem;">SAVE CONFIG</button>
                <button class="btn" onclick="toggleSettings()"
                    style="flex:1; background:#333; font-size:0.7rem;">CANCEL</button>
            </div>
        </div>
    </div>
</body>

</html>