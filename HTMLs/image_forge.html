<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMAGE FORGE // BATCH PROTOCOL</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Oswald:wght@700&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --accent: #ff0055;
            --accent-dim: rgba(255, 0, 85, 0.1);
            --secondary: #222;
            --card: rgba(10, 10, 10, 0.95);
            --font-p: 'Inter', sans-serif;
            --font-h: 'Oswald', sans-serif;
            --font-tech: 'JetBrains Mono', monospace;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: #eee;
            font-family: var(--font-p);
            overflow-x: hidden;
            background: radial-gradient(circle at 50% -20%, #200505 0%, #050505 80%);
            min-height: 100vh;
        }

        /* HEADER */
        .header {
            padding: 30px 40px;
            border-bottom: 1px solid rgba(255, 0, 85, 0.2);
            display: flex;
            flex-direction: column;
            gap: 20px;
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(5, 5, 5, 0.9);
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .logo {
            font-family: var(--font-h);
            font-size: 1.8rem;
            letter-spacing: 5px;
            color: var(--accent);
            text-transform: uppercase;
            text-shadow: 0 0 20px var(--accent-dim);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        input[type="password"],
        select,
        input[type="text"],
        textarea {
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 10px 15px;
            font-size: 0.8rem;
            border-radius: 4px;
            font-family: var(--font-tech);
            transition: 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 10px var(--accent-dim);
        }

        /* BATCH INPUT AREA */
        .batch-area {
            display: flex;
            gap: 15px;
            width: 100%;
        }

        #batch-input {
            flex: 1;
            height: 60px;
            font-size: 0.7rem;
            opacity: 0.7;
        }

        #batch-input:focus {
            opacity: 1;
            height: 120px;
        }

        /* GRID */
        .forge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 30px;
            padding: 40px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .prompt-slot {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            position: relative;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }

        .prompt-slot:hover {
            border-color: var(--accent);
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7), 0 0 20px var(--accent-dim);
        }

        .slot-header {
            display: flex;
            justify-content: space-between;
            font-family: var(--font-tech);
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid #222;
            padding-bottom: 10px;
        }

        .slot-prompt-text {
            background: #080808;
            border: 1px solid #1a1a1a;
            color: #ccc;
            padding: 12px;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 60px;
            border-radius: 4px;
            font-family: var(--font-p);
            line-height: 1.4;
        }

        .image-preview {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border: 1px solid #1a1a1a;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: zoom-in;
        }

        .status-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: var(--font-h);
            font-size: 1rem;
            letter-spacing: 3px;
            color: var(--accent);
            z-index: 10;
        }

        .loading .status-overlay {
            display: flex;
        }

        /* BUTTONS */
        .btn {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 12px 25px;
            font-family: var(--font-h);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .btn:hover:not(:disabled) {
            filter: brightness(1.2);
            box-shadow: 0 0 30px var(--accent-dim);
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .btn.secondary {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            font-size: 0.7rem;
            padding: 8px 15px;
        }

        .btn.secondary:hover {
            border-color: var(--accent);
            color: #fff;
        }

        .action-tray {
            display: flex;
            gap: 10px;
        }

        /* SCANLINE ANIMATION */
        .loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent);
            box-shadow: 0 0 15px var(--accent);
            animation: scan 2s linear infinite;
            z-index: 11;
        }

        @keyframes scan {
            0% {
                top: 0;
            }

            100% {
                top: 100%;
            }
        }

        /* TOAST */
        #toast {
            position: fixed;
            bottom: 40px;
            right: 40px;
            background: #fff;
            color: #000;
            padding: 15px 30px;
            border-radius: 2px;
            font-family: var(--font-h);
            text-transform: uppercase;
            letter-spacing: 2px;
            transform: translateY(150px);
            transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        #toast.show {
            transform: translateY(0);
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <div class="header">
        <div class="header-top">
            <div class="logo">IMAGE FORGE // ADMIN PROTOCOL</div>
            <div class="controls">
                <select id="provider-select" onchange="toggleProvider()">
                    <option value="GOOGLE">GOOGLE GEMINI (IMAGE)</option>
                    <option value="OPENROUTER">OPENROUTER (MULTI-MODEL)</option>
                </select>

                <div id="cfg-google" class="controls">
                    <input type="password" id="api-key-gl" placeholder="GOOGLE API KEY" onchange="saveConfig()">
                    <select id="model-gl" onchange="saveConfig()">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Most Compatible)</option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Stable)</option>
                        <option value="gemini-2.5-flash-image">Gemini 2.5 Flash (Image)</option>
                        <option value="gemini-3.0-pro-image-preview">Gemini 3.0 Pro (Image)</option>
                    </select>
                    <button class="btn secondary" style="padding:5px 10px; font-size:0.6rem;"
                        onclick="listModels()">SCAN MODELS</button>
                </div>

                <div id="cfg-openrouter" class="controls hidden">
                    <input type="password" id="api-key-or" placeholder="OPENROUTER KEY" onchange="saveConfig()">
                    <select id="model-or" onchange="saveConfig()">
                        <option value="openai/dall-e-3">DALL-E 3</option>
                        <option value="black-forest-labs/flux-schnell">Flux Schnell</option>
                        <option value="black-forest-labs/flux.2-pro">Flux 2 Pro</option>
                        <option value="openai/gpt-5-image-mini">GPT-5 Image Mini</option>
                        <option value="google/imagen-3">Imagen 3 (Via OR)</option>
                    </select>
                </div>

                <button class="btn secondary" onclick="clearAll()">CLEAR ALL</button>
            </div>
        </div>

        <div class="batch-area">
            <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                <textarea id="batch-input"
                    placeholder="Paste Markdown Table from Teacher Mode here... [ID | Name | Context | Style | AI PROMPT | Source]"></textarea>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="master-prompt"
                        placeholder="Direct Forge: Enter a single prompt to populate Slot 01..." style="flex:1">
                    <button class="btn" style="padding:10px 20px; font-size:0.75rem;" onclick="directForge()">FORGE
                        NOW</button>
                </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:5px;">
                <button class="btn" onclick="parseBatch()">PARSE TABLE</button>
                <button class="btn" id="gen-all-btn" onclick="generateAll()"
                    style="background:var(--accent); color:#fff;">GENERATE ALL</button>
            </div>
        </div>
    </div>

    <div class="forge-grid" id="forge-grid">
        <!-- 10 Initial Slots generated by script -->
    </div>

    <div style="padding: 0 40px 40px;">
        <div
            style="font-family: var(--font-tech); font-size: 0.7rem; color: var(--accent); margin-bottom: 10px; letter-spacing: 2px;">
            DEBUG TERMINAL // API LOGS</div>
        <div id="debug-console"
            style="background: #000; border: 1px solid #333; height: 300px; overflow-y: auto; padding: 20px; font-family: var(--font-tech); font-size: 0.75rem; color: #0f0; white-space: pre-wrap; line-height: 1.4;">
            [SYSTEM READY] Awaiting instructions...</div>
    </div>

    <div id="toast">SYSTEM NOTIFICATION</div>

    <script>
        let CONFIG = {
            provider: 'GOOGLE',
            key_gl: '',
            key_or: '',
            model_gl: 'gemini-2.0-flash-exp',
            model_or: 'openai/dall-e-3'
        };

        const grid = document.getElementById('forge-grid');
        const consoleEl = document.getElementById('debug-console');

        function init() {
            const saved = localStorage.getItem('IMAGE_FORGE_CFG');
            if (saved) {
                CONFIG = JSON.parse(saved);
                document.getElementById('provider-select').value = CONFIG.provider;
                document.getElementById('api-key-gl').value = CONFIG.key_gl || '';
                document.getElementById('api-key-or').value = CONFIG.key_or || '';
                document.getElementById('model-gl').value = CONFIG.model_gl;
                document.getElementById('model-or').value = CONFIG.model_or;
                toggleProvider();
            }
            createSlots(10);
            log("System Initialized. 10 slots ready.");
        }

        function log(msg, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            let color = '#0f0';
            if (type === 'ERROR') color = '#f44';
            if (type === 'RESPONSE') color = '#0af';
            if (type === 'OUTBOUND') color = '#ff0';

            const entry = document.createElement('div');
            entry.style.color = color;
            entry.style.marginBottom = '5px';
            entry.innerText = `[${timestamp}] [${type}] ${msg}`;
            consoleEl.appendChild(entry);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function createSlots(count) {
            grid.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const div = document.createElement('div');
                div.className = 'prompt-slot';
                div.id = `slot-${i}`;
                div.innerHTML = `
                    <div class="slot-header">
                        <span id="label-${i}">SLOT ${i < 10 ? '0' + i : i}</span>
                        <span id="status-${i}">READY</span>
                    </div>
                    <textarea class="slot-prompt-text" id="prompt-${i}" placeholder="Enter generation prompt..."></textarea>
                    <div class="image-preview" id="preview-${i}">
                        <div class="status-overlay" id="overlay-text-${i}">SYNTHESIZING...</div>
                        <span style="opacity:0.1; font-size:0.6rem;">AWAITING DATA</span>
                    </div>
                    <div class="action-tray">
                        <button class="btn secondary" style="flex:1" onclick="generateSlot(${i})">RE-GEN</button>
                        <button class="btn secondary" id="dl-${i}" disabled onclick="downloadImage(${i})">DOWNLOAD</button>
                    </div>
                `;
                grid.appendChild(div);
            }
        }

        function toggleProvider() {
            CONFIG.provider = document.getElementById('provider-select').value;
            document.getElementById('cfg-google').classList.toggle('hidden', CONFIG.provider !== 'GOOGLE');
            document.getElementById('cfg-openrouter').classList.toggle('hidden', CONFIG.provider !== 'OPENROUTER');
            saveConfig();
        }

        function saveConfig() {
            CONFIG.provider = document.getElementById('provider-select').value;
            CONFIG.key_gl = document.getElementById('api-key-gl').value.trim();
            CONFIG.key_or = document.getElementById('api-key-or').value.trim();
            CONFIG.model_gl = document.getElementById('model-gl').value;
            CONFIG.model_or = document.getElementById('model-or').value;
            localStorage.setItem('IMAGE_FORGE_CFG', JSON.stringify(CONFIG));
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function directForge() {
            const p = document.getElementById('master-prompt').value;
            if (!p) return;
            document.getElementById('prompt-1').value = p;
            generateSlot(1);
        }

        function parseBatch() {
            const raw = document.getElementById('batch-input').value;
            if (!raw) return;

            const lines = raw.split('\n').filter(l => l.includes('|') && !l.includes('---'));
            let count = 0;

            lines.forEach((line) => {
                const parts = line.split('|').map(p => p.trim());
                let prompt = "";
                let name = "";
                let id = "";

                if (parts.length >= 6) {
                    id = parts[1];
                    name = parts[2];
                    prompt = parts[5] || parts[4];
                }

                if (prompt && prompt.toLowerCase() !== 'ai prompt' && count < 10) {
                    count++;
                    document.getElementById(`prompt-${count}`).value = prompt;
                    document.getElementById(`label-${count}`).innerText = `ASSET ${id} // ${name}`;
                }
            });

            if (count === 0) {
                showToast("ERROR: NO PROMPTS DETECTED");
                return;
            }

            showToast(`LOADED ${count} PROMPTS`);
            log(`Batch parsed: ${count} items extracted.`);
        }

        async function generateAll() {
            log("Bulk generation sequence initiated...");
            for (let i = 1; i <= 10; i++) {
                const prompt = document.getElementById(`prompt-${i}`).value;
                if (prompt) {
                    await generateSlot(i);
                }
            }
        }

        async function generateSlot(id) {
            const prompt = document.getElementById(`prompt-${id}`).value;
            const preview = document.getElementById(`preview-${id}`);
            const status = document.getElementById(`status-${id}`);
            const dlBtn = document.getElementById(`dl-${id}`);
            const overlayText = document.getElementById(`overlay-text-${id}`);

            if (!prompt) return;

            preview.classList.add('loading');
            status.innerText = "PROCESSING";
            overlayText.innerText = "COMMUNING WITH MODEL...";
            log(`Requesting Slot ${id}: "${prompt.substring(0, 40)}..."`, 'OUTBOUND');

            try {
                let imageUrl = "";
                if (CONFIG.provider === 'GOOGLE') {
                    imageUrl = await callGoogleAPI(prompt, id);
                } else {
                    imageUrl = await callOpenRouterAPI(prompt, id);
                }

                if (imageUrl) {
                    preview.innerHTML = `<img src="${imageUrl}" onclick="window.open(this.src)">`;
                    status.innerText = "COMPLETE";
                    status.style.color = "#0f0";
                    dlBtn.disabled = false;
                    dlBtn.dataset.url = imageUrl;
                    log(`Slot ${id} successful.`);
                }
            } catch (e) {
                console.error(id, e);
                status.innerText = "ERROR";
                status.style.color = "#f44";
                overlayText.innerText = "FAILURE: " + e.message;
                log(`Slot ${id} ERROR: ${e.message}`, 'ERROR');
            } finally {
                preview.classList.remove('loading');
            }
        }

        function listModels() {
            saveConfig();
            if (!CONFIG.key_gl) { showToast("NEED API KEY"); return; }
            log("DIAGNOSTIC: SCANNING ALL GOOGLE API TIERS...", 'OUTBOUND');

            // Tier 1: v1 with Query Param
            fetch(`https://generativelanguage.googleapis.com/v1/models?key=${CONFIG.key_gl}`)
                .then(r => r.json())
                .then(data => {
                    if (data.models) log(`V1 (QUERY) SUCCESS: ${data.models.length} entries found.`, 'RESPONSE');
                    else log(`V1 (QUERY) REJECTED: ${data.error ? data.error.message : 'Unknown'}`, 'ERROR');
                });

            // Tier 2: v1beta with Header
            fetch(`https://generativelanguage.googleapis.com/v1beta/models`, {
                headers: { 'x-goog-api-key': CONFIG.key_gl }
            })
                .then(r => r.json())
                .then(data => {
                    if (data.models) log(`V1BETA (HEADER) SUCCESS: ${data.models.length} entries found.`, 'RESPONSE');
                    else log(`V1BETA (HEADER) REJECTED: ${data.error ? data.error.message : 'Unknown'}`, 'ERROR');
                });

            // Tier 3: v1beta with Query Param
            fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${CONFIG.key_gl}`)
                .then(r => r.json())
                .then(data => {
                    if (data.models) log(`V1BETA (QUERY) SUCCESS: ${data.models.length} entries found.`, 'RESPONSE');
                    else log(`V1BETA (QUERY) REJECTED: ${data.error ? data.error.message : 'Unknown'}`, 'ERROR');
                });
        }

        async function callGoogleAPI(prompt, slotId) {
            if (!CONFIG.key_gl) throw new Error("MISSING API KEY");

            // Try multiple URL/Header combos to find a valid principal assertion
            const endpoints = [
                { url: `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.model_gl}:generateContent`, useHeader: true },
                { url: `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.model_gl}:generateContent?key=${CONFIG.key_gl}`, useHeader: false },
                { url: `https://generativelanguage.googleapis.com/v1/models/${CONFIG.model_gl}:generateContent?key=${CONFIG.key_gl}`, useHeader: false }
            ];

            let lastError = "";

            for (let ep of endpoints) {
                try {
                    const headers = { 'Content-Type': 'application/json' };
                    if (ep.useHeader) headers['x-goog-api-key'] = CONFIG.key_gl;

                    log(`ATTEMPTING GOOGLE AUTH: ${ep.url.includes('?') ? 'Query Param' : 'Header'} (${ep.url.includes('beta') ? 'v1beta' : 'v1'})`, 'OUTBOUND');

                    const response = await fetch(ep.url, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                responseModalities: ["TEXT", "IMAGE"],
                                candidateCount: 1
                            }
                        })
                    });

                    const data = await response.json();

                    if (data.error) {
                        lastError = data.error.message;
                        log(`EP FAILED: ${lastError}`, 'ERROR');
                        if (data.error.code === 401) continue;
                        throw new Error(lastError);
                    }

                    if (data.candidates && data.candidates[0].content.parts) {
                        const parts = data.candidates[0].content.parts;
                        const imgPart = parts.find(p => p.inlineData);
                        if (imgPart) return `data:${imgPart.inlineData.mimeType};base64,${imgPart.inlineData.data}`;

                        const textPart = parts.find(p => p.text);
                        if (textPart) throw new Error("REFUSAL: " + textPart.text);
                    }
                } catch (e) {
                    lastError = e.message;
                    if (lastError.includes('401')) continue;
                    throw e;
                }
            }
            throw new Error("ALL GOOGLE AUTH PATTERNS REJECTED: " + lastError);
        }

        async function callOpenRouterAPI(prompt, slotId) {
            if (!CONFIG.key_or) throw new Error("MISSING OPENROUTER KEY");

            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${CONFIG.key_or}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    "model": CONFIG.model_or,
                    "messages": [{ "role": "user", "content": prompt }]
                })
            });

            const data = await response.json();
            log(`INBOUND (OPENROUTER): ${JSON.stringify(data).substring(0, 1000)}...`, 'RESPONSE');

            if (data.error) throw new Error(data.error.message);

            const message = data.choices[0].message;

            // Check for new OpenRouter/Flux image object format
            if (message.images && message.images.length > 0) {
                const img = message.images[0];
                if (img.image_url) return img.image_url.url;
                if (typeof img === 'string') return img;
            }

            const content = message.content || "";
            const urlMatch = content.match(/https?:\/\/[^\s\)]+/g);
            if (urlMatch) return urlMatch[0];

            if (content.includes('data:image')) {
                const base64Match = content.match(/data:image\/[a-zA-Z]*;base64,[^\s\n]+/);
                if (base64Match) return base64Match[0];
                return content.trim();
            }

            throw new Error("COULD NOT IDENTIFY IMAGE URL/DATA");
        }

        function downloadImage(id) {
            const btn = document.getElementById(`dl-${id}`);
            const url = btn.dataset.url;
            if (!url) return;

            const link = document.createElement('a');
            link.href = url;
            link.download = `FORGE_ASSET_${id}_${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("DATA DOWNLOADED");
        }

        function clearAll() {
            if (confirm("PURGE ALL SLOTS?")) {
                for (let i = 1; i <= 10; i++) {
                    document.getElementById(`prompt-${i}`).value = '';
                    document.getElementById(`preview-${i}`).innerHTML = '<div class="status-overlay" id="overlay-text-' + i + '">SYNTHESIZING...</div><span style="opacity:0.1; font-size:0.6rem;">AWAITING DATA</span>';
                    document.getElementById(`status-${i}`).innerText = 'READY';
                    document.getElementById(`status-${i}`).style.color = '';
                    document.getElementById(`label-${i}`).innerText = `SLOT ${i < 10 ? '0' + i : i}`;
                }
                showToast("SESSION PURGED");
                log("All slots cleared.");
            }
        }

        init();
    </script>
</body>

</html>